<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám Chi nh√°nh C·∫ßn Th∆° II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mobile-enhancements.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Theme and PWA meta tags -->
  <meta name="theme-color" content="#800020">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Quiz C·∫ßn Th∆° II">
  <!-- Excel export library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <meta name="apple-touch-fullscreen" content="yes">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  
  <!-- Android specific meta tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Quiz C·∫ßn Th∆° II">
  <meta name="msapplication-TileColor" content="#800020">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- Android Chrome specific -->
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: dark)">
  
  <!-- Manifest and icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="logo.png">
  <link rel="icon" type="image/png" sizes="512x512" href="logo.png">
  <!-- Config file -->
  <script src="config.js"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* iPhone specific optimizations */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        border-radius: 0;
      }
      
      button {
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
      }
    }
    
    /* Android specific optimizations */
    @supports not (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: 8px;
      }
      
      button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
        -moz-tap-highlight-color: transparent;
        tap-highlight-color: transparent;
      }
      
      /* Android Chrome specific optimizations */
      .container {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
      }
      
      /* Better touch targets for Android */
      .btn, .answer, .topic-card {
        min-height: 48px;
        min-width: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img">
        <div class="logo-text">
          <h1>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám</h1>
          <p>Chi nh√°nh C·∫ßn Th∆° II</p>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="welcome-section">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II</h2>
        <p>Ch·ªçn chuy√™n m·ª•c ph√π h·ª£p b√™n d∆∞·ªõi:</p>
      </div>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">Chuy√™n ƒë·ªÅ (kh√¥ng gi·ªõi h·∫°n th·ªùi gian)</h3>
          <button id="topic-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="topic-dropdown-view">
          <div class="form-group">
            <label for="topic-select">Ch·ªçn chuy√™n ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="topic-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>
            </select>
          </div>
          <div id="topic-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="topic-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="topic-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="topic-grid-view" style="display: none;">
          <div id="topics-container" class="topics-grid"></div>
        </div>
      </section>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">B√†i thi (c√≥ th·ªùi gian)</h3>
          <button id="exam-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="exam-dropdown-view">
          <div class="form-group">
            <label for="exam-select">Ch·ªçn b√†i thi ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="exam-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn b√†i thi --</option>
            </select>
          </div>
          <div id="exam-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="exam-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="exam-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu thi
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="exam-grid-view" style="display: none;">
          <div id="exams-container" class="topics-grid"></div>
        </div>
      </section>

      <div class="admin-section">
        <div class="admin-buttons-grid">
          <a href="admin.html" class="btn btn-outline admin-btn">
            <i class="material-icons">admin_panel_settings</i> Qu·∫£n tr·ªã vi√™n
          </a>
          <button id="clear-cookies-btn" type="button" class="btn btn-outline admin-btn">
            <i class="material-icons">delete</i> X√≥a cookie
          </button>
          <button id="clear-storage-btn" type="button" class="btn btn-outline admin-btn">
            <i class="material-icons">delete_sweep</i> X√≥a b·ªô nh·ªõ
          </button>
          <button id="refresh-data-btn" type="button" class="btn btn-outline admin-btn">
            <i class="material-icons">refresh</i> T·∫£i l·∫°i d·ªØ li·ªáu
          </button>
          <button id="global-stats-btn" type="button" class="btn btn-outline admin-btn">
            <i class="material-icons">analytics</i> Th·ªëng k√™ t·ªïng qu√°t
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const topicSelect = document.getElementById('topic-select');
        const examSelect = document.getElementById('exam-select');
        const topicInfo = document.getElementById('topic-info');
        const examInfo = document.getElementById('exam-info');
        const topicDescription = document.getElementById('topic-description');
        const examDescription = document.getElementById('exam-description');
        const topicStartBtn = document.getElementById('topic-start-btn');
        const examStartBtn = document.getElementById('exam-start-btn');
        const clearCookiesBtn = document.getElementById('clear-cookies-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');
        const refreshDataBtn = document.getElementById('refresh-data-btn');
        const globalStatsBtn = document.getElementById('global-stats-btn');

        function showEmptyState() {
          topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          topicInfo.style.display = 'none';
          examInfo.style.display = 'none';
          
          // Show error message
          const errorMsg = document.createElement('div');
          errorMsg.id = 'loading-error';
          errorMsg.style.cssText = `
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #f44336;
            text-align: center;
          `;
          errorMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">error</i>
            Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ c√°c c√°ch sau:
            <br><br>
            <strong>C√°ch 1:</strong> Nh·∫•n n√∫t "T·∫£i l·∫°i d·ªØ li·ªáu" b√™n d∆∞·ªõi
            <br><strong>C√°ch 2:</strong> Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† t·∫£i l·∫°i trang
            <br><strong>C√°ch 3:</strong> X√≥a cache tr√¨nh duy·ªát (Ctrl+F5)
            <br><br>
            <small>N·∫øu v·∫´n kh√¥ng ƒë∆∞·ª£c, li√™n h·ªá qu·∫£n tr·ªã vi√™n: trungnguyenthanh1@agribank.com.vn</small>
          `;
          
          const container = document.querySelector('.content');
          const existingError = document.getElementById('loading-error');
          if (existingError) {
            existingError.remove();
          }
          container.insertBefore(errorMsg, container.firstChild);
        }
        
        function showLoadingState() {
          const loadingMsg = document.createElement('div');
          loadingMsg.id = 'loading-indicator';
          loadingMsg.style.cssText = `
            background: #e3f2fd;
            color: #1976d2;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #2196f3;
            text-align: center;
          `;
          loadingMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">refresh</i>
            ƒêang t·∫£i d·ªØ li·ªáu...
          `;
          
          const container = document.querySelector('.content');
          const existingLoading = document.getElementById('loading-indicator');
          const existingError = document.getElementById('loading-error');
          if (existingLoading) existingLoading.remove();
          if (existingError) existingError.remove();
          container.insertBefore(loadingMsg, container.firstChild);
        }
        
        function hideLoadingState() {
          const loading = document.getElementById('loading-indicator');
          if (loading) loading.remove();
        }

        function clearAllCookies() {
          try {
            const cookies = document.cookie ? document.cookie.split(';') : [];
            const past = 'Thu, 01 Jan 1970 00:00:00 GMT';
            const hostnameParts = location.hostname ? location.hostname.split('.') : [];
            const domains = [''];
            for (let i = 0; i < hostnameParts.length; i++) {
              const d = '.' + hostnameParts.slice(i).join('.');
              if (d !== '.') domains.push(d);
            }
            const paths = Array.from(new Set(['/','/' + location.pathname.split('/').filter(Boolean).join('/')]))
                              .filter(Boolean);

            for (const c of cookies) {
              const eqPos = c.indexOf('=');
              const name = (eqPos > -1 ? c.substr(0, eqPos) : c).trim();
              for (const domain of domains) {
                for (const p of paths) {
                  document.cookie = `${name}=; expires=${past}; path=${p};${domain ? ` domain=${domain};` : ''} SameSite=Lax`;
                }
              }
            }
            alert('ƒê√£ x√≥a t·∫•t c·∫£ cookie c·ªßa trang.');
          } catch (e) {
            alert('Kh√¥ng th·ªÉ x√≥a cookie: ' + (e && e.message ? e.message : e));
          }
        }

        async function clearWebStorage() {
          try {
            localStorage.clear();
            sessionStorage.clear();
            
            // Clear IndexedDB as well
            try {
              await indexedDBStorage.clear();
              console.log('IndexedDB cleared successfully');
            } catch (dbError) {
              console.warn('Could not clear IndexedDB:', dbError);
            }
            
            alert('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu l∆∞u tr·ªØ:\n\n' +
                  '‚Ä¢ localStorage\n' +
                  '‚Ä¢ sessionStorage\n' +
                  '‚Ä¢ IndexedDB\n\n' +
                  'Dung l∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c gi·∫£i ph√≥ng ho√†n to√†n.');
          } catch (e) {
            alert('‚ùå Kh√¥ng th·ªÉ x√≥a web storage: ' + (e && e.message ? e.message : e));
          }
        }

        // Ki·ªÉm tra dung l∆∞·ª£ng localStorage
        function checkLocalStorageUsage() {
          try {
            let totalSize = 0;
            for (let key in localStorage) {
              if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
              }
            }
            
            const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            const quotaLimit = 5; // 5MB l√† gi·ªõi h·∫°n ph·ªï bi·∫øn
            
            console.log(`LocalStorage usage: ${sizeInMB}MB / ${quotaLimit}MB`);
            
            if (parseFloat(sizeInMB) > quotaLimit * 0.8) {
              console.warn('LocalStorage ƒëang s·ª≠ d·ª•ng h∆°n 80% quota!');
              return {
                used: parseFloat(sizeInMB),
                limit: quotaLimit,
                percentage: (parseFloat(sizeInMB) / quotaLimit * 100).toFixed(1),
                warning: parseFloat(sizeInMB) > quotaLimit * 0.8
              };
            }
            
            return {
              used: parseFloat(sizeInMB),
              limit: quotaLimit,
              percentage: (parseFloat(sizeInMB) / quotaLimit * 100).toFixed(1),
              warning: false
            };
          } catch (e) {
            console.error('Error checking localStorage usage:', e);
            return null;
          }
        }

        // X·ª≠ l√Ω l·ªói QuotaExceededError
        function handleQuotaExceededError(error, context = '') {
          console.error(`QuotaExceededError in ${context}:`, error);
          
          const usage = checkLocalStorageUsage();
          if (usage) {
            alert(`‚ö†Ô∏è L·ªói v∆∞·ª£t qu√° dung l∆∞·ª£ng l∆∞u tr·ªØ!\n\n` +
                  `ƒê√£ s·ª≠ d·ª•ng: ${usage.used}MB / ${usage.limit}MB (${usage.percentage}%)\n\n` +
                  `Vui l√≤ng:\n` +
                  `1. Nh·∫•n "X√≥a b·ªô nh·ªõ" ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng\n` +
                  `2. Ho·∫∑c x√≥a d·ªØ li·ªáu c≈© trong th·ªëng k√™\n` +
                  `3. Li√™n h·ªá admin n·∫øu v·∫•n ƒë·ªÅ ti·∫øp t·ª•c`);
          } else {
            alert(`‚ö†Ô∏è L·ªói v∆∞·ª£t qu√° dung l∆∞·ª£ng l∆∞u tr·ªØ!\n\n` +
                  `Vui l√≤ng nh·∫•n "X√≥a b·ªô nh·ªõ" ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng.`);
          }
        }

        // N√©n d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u (ƒë∆°n gi·∫£n)
        function compressData(data) {
          try {
            // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a v√† n√©n JSON
            return JSON.stringify(JSON.parse(JSON.stringify(data)));
          } catch (e) {
            return data;
          }
        }

        // Gi·∫£i n√©n d·ªØ li·ªáu
        function decompressData(compressedData) {
          try {
            return JSON.parse(compressedData);
          } catch (e) {
            return compressedData;
          }
        }

        // X√≥a d·ªØ li·ªáu c≈© t·ª± ƒë·ªông
        function cleanupOldData() {
          try {
            const now = Date.now();
            const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 ng√†y
            
            // X√≥a th·ªëng k√™ c≈©
            const stats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
            const recentStats = stats.filter(stat => {
              const statTime = new Date(stat.timestamp).getTime();
              return (now - statTime) < maxAge;
            });
            
            if (recentStats.length < stats.length) {
              localStorage.setItem('quiz_statistics', JSON.stringify(recentStats));
              console.log(`Cleaned up ${stats.length - recentStats.length} old statistics`);
            }
            
            // X√≥a c√¢u sai c≈©
            const wrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
            const recentWrongAnswers = wrongAnswers.filter(answer => {
              const answerTime = new Date(answer.timestamp).getTime();
              return (now - answerTime) < maxAge;
            });
            
            if (recentWrongAnswers.length < wrongAnswers.length) {
              localStorage.setItem('wrong_answers', JSON.stringify(recentWrongAnswers));
              console.log(`Cleaned up ${wrongAnswers.length - recentWrongAnswers.length} old wrong answers`);
            }
            
            return {
              statsRemoved: stats.length - recentStats.length,
              wrongAnswersRemoved: wrongAnswers.length - recentWrongAnswers.length
            };
          } catch (e) {
            console.error('Error cleaning up old data:', e);
            return null;
          }
        }

        // Wrapper function ƒë·ªÉ l∆∞u d·ªØ li·ªáu an to√†n v·ªõi t·ªëi ∆∞u h√≥a
        function safeLocalStorageSet(key, value, options = {}) {
          try {
            let dataToStore = value;
            
            // N√©n d·ªØ li·ªáu n·∫øu ƒë∆∞·ª£c y√™u c·∫ßu
            if (options.compress !== false) {
              dataToStore = compressData(value);
            }
            
            localStorage.setItem(key, dataToStore);
            return true;
          } catch (error) {
            if (error.name === 'QuotaExceededError') {
              // Th·ª≠ d·ªçn d·∫πp d·ªØ li·ªáu c≈© tr∆∞·ªõc
              const cleanupResult = cleanupOldData();
              if (cleanupResult) {
                console.log('Cleaned up old data, retrying save...');
                try {
                  localStorage.setItem(key, dataToStore);
                  return true;
                } catch (retryError) {
                  handleQuotaExceededError(retryError, `saving ${key} after cleanup`);
                  return false;
                }
              } else {
                handleQuotaExceededError(error, `saving ${key}`);
                return false;
              }
            }
            throw error;
          }
        }

        // L∆∞u d·ªØ li·ªáu v·ªõi t·ªëi ∆∞u h√≥a
        function optimizedLocalStorageSet(key, value) {
          return safeLocalStorageSet(key, value, { compress: true });
        }

        // IndexedDB ƒë·ªÉ l∆∞u tr·ªØ d·ªØ li·ªáu l·ªõn
        class IndexedDBStorage {
          constructor() {
            this.dbName = 'QuizStorageDB';
            this.version = 1;
            this.db = null;
          }

          async init() {
            return new Promise((resolve, reject) => {
              const request = indexedDB.open(this.dbName, this.version);
              
              request.onerror = () => reject(request.error);
              request.onsuccess = () => {
                this.db = request.result;
                resolve(this.db);
              };
              
              request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('quizData')) {
                  db.createObjectStore('quizData', { keyPath: 'key' });
                }
              };
            });
          }

          async setItem(key, value) {
            if (!this.db) await this.init();
            
            return new Promise((resolve, reject) => {
              const transaction = this.db.transaction(['quizData'], 'readwrite');
              const store = transaction.objectStore('quizData');
              const request = store.put({ key, value, timestamp: Date.now() });
              
              request.onsuccess = () => resolve(true);
              request.onerror = () => reject(request.error);
            });
          }

          async getItem(key) {
            if (!this.db) await this.init();
            
            return new Promise((resolve, reject) => {
              const transaction = this.db.transaction(['quizData'], 'readonly');
              const store = transaction.objectStore('quizData');
              const request = store.get(key);
              
              request.onsuccess = () => {
                resolve(request.result ? request.result.value : null);
              };
              request.onerror = () => reject(request.error);
            });
          }

          async removeItem(key) {
            if (!this.db) await this.init();
            
            return new Promise((resolve, reject) => {
              const transaction = this.db.transaction(['quizData'], 'readwrite');
              const store = transaction.objectStore('quizData');
              const request = store.delete(key);
              
              request.onsuccess = () => resolve(true);
              request.onerror = () => reject(request.error);
            });
          }

          async clear() {
            if (!this.db) await this.init();
            
            return new Promise((resolve, reject) => {
              const transaction = this.db.transaction(['quizData'], 'readwrite');
              const store = transaction.objectStore('quizData');
              const request = store.clear();
              
              request.onsuccess = () => resolve(true);
              request.onerror = () => reject(request.error);
            });
          }
        }

        // Kh·ªüi t·∫°o IndexedDB storage
        const indexedDBStorage = new IndexedDBStorage();

        // Hybrid storage: localStorage + IndexedDB
        async function hybridStorageSet(key, value) {
          try {
            // Th·ª≠ localStorage tr∆∞·ªõc
            if (safeLocalStorageSet(key, value)) {
              return true;
            }
          } catch (e) {
            console.log('localStorage failed, trying IndexedDB...');
          }
          
          try {
            // Fallback to IndexedDB
            await indexedDBStorage.setItem(key, value);
            console.log(`Data saved to IndexedDB: ${key}`);
            return true;
          } catch (e) {
            console.error('Both localStorage and IndexedDB failed:', e);
            return false;
          }
        }

        async function hybridStorageGet(key) {
          try {
            // Th·ª≠ localStorage tr∆∞·ªõc
            const localData = localStorage.getItem(key);
            if (localData) {
              return localData;
            }
          } catch (e) {
            console.log('localStorage read failed, trying IndexedDB...');
          }
          
          try {
            // Fallback to IndexedDB
            const indexedData = await indexedDBStorage.getItem(key);
            return indexedData;
          } catch (e) {
            console.error('Both localStorage and IndexedDB read failed:', e);
            return null;
          }
        }

        if (clearCookiesBtn) {
          clearCookiesBtn.addEventListener('click', clearAllCookies);
        }

        if (clearStorageBtn) {
          clearStorageBtn.addEventListener('click', async function() {
            if (confirm('‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a T·∫§T C·∫¢ d·ªØ li·ªáu l∆∞u tr·ªØ?\n\n' +
                        'ƒêi·ªÅu n√†y s·∫Ω x√≥a:\n' +
                        '‚Ä¢ T·∫•t c·∫£ chuy√™n ƒë·ªÅ ƒë√£ t·∫£i\n' +
                        '‚Ä¢ T·∫•t c·∫£ th·ªëng k√™\n' +
                        '‚Ä¢ T·∫•t c·∫£ c√¢u tr·∫£ l·ªùi sai\n' +
                        '‚Ä¢ T·∫•t c·∫£ d·ªØ li·ªáu kh√°c\n\n' +
                        'KH√îNG TH·ªÇ HO√ÄN T√ÅC!')) {
              await clearWebStorage();
            }
          });
        }

        // Th√™m n√∫t ki·ªÉm tra dung l∆∞·ª£ng localStorage
        const checkStorageBtn = document.createElement('button');
        checkStorageBtn.innerHTML = '<i class="material-icons">storage</i> Ki·ªÉm tra dung l∆∞·ª£ng';
        checkStorageBtn.className = 'btn btn-outline admin-btn';
        checkStorageBtn.style.marginTop = '10px';
        checkStorageBtn.addEventListener('click', function() {
          const usage = checkLocalStorageUsage();
          if (usage) {
            const status = usage.warning ? '‚ö†Ô∏è C·∫¢NH B√ÅO' : '‚úÖ B√¨nh th∆∞·ªùng';
            const color = usage.warning ? '#ff9800' : '#4caf50';
            
            alert(`${status}\n\n` +
                  `Dung l∆∞·ª£ng ƒë√£ s·ª≠ d·ª•ng: ${usage.used}MB\n` +
                  `Gi·ªõi h·∫°n: ${usage.limit}MB\n` +
                  `T·ª∑ l·ªá s·ª≠ d·ª•ng: ${usage.percentage}%\n\n` +
                  `${usage.warning ? 'Khuy·∫øn ngh·ªã: X√≥a d·ªØ li·ªáu c≈© ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng.' : 'Dung l∆∞·ª£ng s·ª≠ d·ª•ng trong gi·ªõi h·∫°n an to√†n.'}`);
          } else {
            alert('Kh√¥ng th·ªÉ ki·ªÉm tra dung l∆∞·ª£ng localStorage.');
          }
        });
        document.querySelector('.admin-buttons-grid').appendChild(checkStorageBtn);

        // Th√™m n√∫t d·ªçn d·∫πp d·ªØ li·ªáu c≈©
        const cleanupBtn = document.createElement('button');
        cleanupBtn.innerHTML = '<i class="material-icons">cleaning_services</i> D·ªçn d·∫πp d·ªØ li·ªáu c≈©';
        cleanupBtn.className = 'btn btn-outline admin-btn';
        cleanupBtn.style.marginTop = '10px';
        cleanupBtn.addEventListener('click', async function() {
          if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën d·ªçn d·∫πp d·ªØ li·ªáu c≈© h∆°n 30 ng√†y?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n- Th·ªëng k√™ c≈©\n- C√¢u tr·∫£ l·ªùi sai c≈©\n\nKh√¥ng th·ªÉ ho√†n t√°c!')) {
            const result = cleanupOldData();
            if (result) {
              alert(`‚úÖ D·ªçn d·∫πp ho√†n t·∫•t!\n\n` +
                    `ƒê√£ x√≥a:\n` +
                    `- ${result.statsRemoved} th·ªëng k√™ c≈©\n` +
                    `- ${result.wrongAnswersRemoved} c√¢u tr·∫£ l·ªùi sai c≈©\n\n` +
                    `Dung l∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c gi·∫£i ph√≥ng.`);
            } else {
              alert('‚ùå Kh√¥ng th·ªÉ d·ªçn d·∫πp d·ªØ li·ªáu c≈©.');
            }
          }
        });
        document.querySelector('.admin-buttons-grid').appendChild(cleanupBtn);

        // Th√™m n√∫t export d·ªØ li·ªáu
        const exportDataBtn = document.createElement('button');
        exportDataBtn.innerHTML = '<i class="material-icons">file_download</i> Export d·ªØ li·ªáu';
        exportDataBtn.className = 'btn btn-outline admin-btn';
        exportDataBtn.style.marginTop = '10px';
        exportDataBtn.addEventListener('click', function() {
          try {
            const allData = {
              quiz_topics: JSON.parse(localStorage.getItem('quiz_topics') || '[]'),
              quiz_statistics: JSON.parse(localStorage.getItem('quiz_statistics') || '[]'),
              wrong_answers: JSON.parse(localStorage.getItem('wrong_answers') || '[]'),
              exportDate: new Date().toISOString(),
              version: '1.0'
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `quiz-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            alert('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c export th√†nh c√¥ng!');
          } catch (e) {
            alert('‚ùå Kh√¥ng th·ªÉ export d·ªØ li·ªáu: ' + e.message);
          }
        });
        document.querySelector('.admin-buttons-grid').appendChild(exportDataBtn);

        // Th√™m n√∫t import d·ªØ li·ªáu
        const importDataBtn = document.createElement('button');
        importDataBtn.innerHTML = '<i class="material-icons">file_upload</i> Import d·ªØ li·ªáu';
        importDataBtn.className = 'btn btn-outline admin-btn';
        importDataBtn.style.marginTop = '10px';
        importDataBtn.addEventListener('click', function() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = function(e) {
                try {
                  const data = JSON.parse(e.target.result);
                  
                  if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën import d·ªØ li·ªáu?\n\n` +
                             `D·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω ƒë∆∞·ª£c thay th·∫ø b·ªüi:\n` +
                             `- ${data.quiz_topics?.length || 0} chuy√™n ƒë·ªÅ\n` +
                             `- ${data.quiz_statistics?.length || 0} th·ªëng k√™\n` +
                             `- ${data.wrong_answers?.length || 0} c√¢u sai\n\n` +
                             `Kh√¥ng th·ªÉ ho√†n t√°c!`)) {
                    
                    if (data.quiz_topics) localStorage.setItem('quiz_topics', JSON.stringify(data.quiz_topics));
                    if (data.quiz_statistics) localStorage.setItem('quiz_statistics', JSON.stringify(data.quiz_statistics));
                    if (data.wrong_answers) localStorage.setItem('wrong_answers', JSON.stringify(data.wrong_answers));
                    
                    alert('‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c import th√†nh c√¥ng!\n\nVui l√≤ng t·∫£i l·∫°i trang ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi.');
                    window.location.reload();
                  }
                } catch (e) {
                  alert('‚ùå File kh√¥ng h·ª£p l·ªá: ' + e.message);
                }
              };
              reader.readAsText(file);
            }
          };
          input.click();
        });
        document.querySelector('.admin-buttons-grid').appendChild(importDataBtn);

        if (refreshDataBtn) {
          refreshDataBtn.addEventListener('click', function() {
            // Clear cached data and reload
            localStorage.removeItem('quiz_topics');
            loadTopics();
          });
        }


        if (globalStatsBtn) {
          globalStatsBtn.addEventListener('click', async function() {
            await showGlobalStatistics();
          });
        }


    // Test Google Sheets connection
    async function testGoogleSheetsConnection() {
      if (!window.QUIZ_CONFIG || !window.isConfigured()) {
        alert('Google Sheets ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!');
        return;
      }

      try {
        console.log('Testing Google Sheets connection...');
        const response = await fetch(`${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=test`, {
          method: 'GET',
          mode: 'cors'
        });
        
        const text = await response.text();
        console.log('Test response:', text);
        
        if (text.includes('working')) {
          alert('‚úÖ K·∫øt n·ªëi Google Sheets th√†nh c√¥ng!\n\n' + text);
        } else {
          alert('‚ö†Ô∏è Google Sheets ph·∫£n h·ªìi nh∆∞ng c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ:\n\n' + text);
        }
      } catch (error) {
        console.error('Google Sheets test error:', error);
        alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Google Sheets:\n\n' + error.message + '\n\nVui l√≤ng ki·ªÉm tra:\n- URL Google Script\n- C·∫•u h√¨nh CORS\n- Quy·ªÅn truy c·∫≠p');
      }
    }

    async function showGlobalStatistics() {
      // Remove any existing global statistics modal
      const existingModal = document.querySelector('.global-statistics-modal');
      if (existingModal) {
        existingModal.remove();
        document.body.style.overflow = '';
        document.body.style.position = '';
        // Restore visibility of all elements
        const allElements = document.querySelectorAll('*');
        allElements.forEach(el => {
          el.style.visibility = '';
        });
        return;
      }
      
      // Save original body content
      const originalBodyContent = document.body.innerHTML;
      window.originalBodyContent = originalBodyContent;
      
      // Th·ª≠ l·∫•y d·ªØ li·ªáu t·ª´ Google Sheets tr∆∞·ªõc
      let allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
      let allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
      
      // N·∫øu c√≥ c·∫•u h√¨nh Google Sheets, th·ª≠ l·∫•y d·ªØ li·ªáu t·ª´ ƒë√≥
      if (window.QUIZ_CONFIG && window.QUIZ_CONFIG.ENABLE_CLOUD_SYNC && window.isConfigured()) {
        try {
          console.log('Trying to load statistics from Google Sheets...');
          console.log('Google Script URL:', window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL);
          
          const response = await fetch(`${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getStatistics`, {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Accept': 'application/json',
            }
          });
          
          console.log('Response status:', response.status);
          console.log('Response headers:', response.headers);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const result = await response.json();
          console.log('Raw response from Google Sheets:', result);
          
          if (result.success && result.data) {
            console.log('Loaded statistics from Google Sheets:', result.data);
            
            // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ Google Sheets sang format localStorage
            const googleStats = result.data.topicStats || [];
            const googleWrongAnswers = result.data.frequentWrongAnswers || [];
            
            if (googleStats.length > 0) {
              // Merge v·ªõi d·ªØ li·ªáu localStorage (∆∞u ti√™n Google Sheets)
              allStats = googleStats.map(stat => ({
                topicId: stat.topicId,
                topicName: stat.topicName,
                timestamp: new Date().toISOString(), // D√πng th·ªùi gian hi·ªán t·∫°i
                totalQuestions: stat.totalQuestions,
                correctAnswers: stat.totalCorrect,
                wrongAnswers: stat.totalWrong,
                score: stat.avgScore,
                isExam: stat.isExam,
                fullname: 'Google Sheets Data',
                branch: 'Online'
              }));
              
              console.log('Converted Google Sheets stats:', allStats);
            }
            
            if (googleWrongAnswers.length > 0) {
              // Chuy·ªÉn ƒë·ªïi wrong answers
              allWrongAnswers = googleWrongAnswers.map(wrong => ({
                questionIndex: 0,
                question: wrong.question,
                options: [wrong.optionA, wrong.optionB, wrong.optionC, wrong.optionD],
                optionLabels: ['A', 'B', 'C', 'D'],
                correctAnswer: wrong.correctAnswer,
                userAnswer: 'Unknown',
                explanation: '',
                topicId: 'unknown',
                topicName: wrong.topicName,
                timestamp: new Date().toISOString()
              }));
              
              console.log('Converted Google Sheets wrong answers:', allWrongAnswers);
            }
          } else {
            console.log('Google Sheets response not successful or no data:', result);
          }
        } catch (error) {
          console.error('Error loading from Google Sheets:', error);
          console.log('Falling back to localStorage data');
        }
      } else {
        console.log('Google Sheets not configured or disabled');
      }
      
      if (allStats.length === 0) {
        // Hi·ªÉn th·ªã th√¥ng tin v·ªÅ c√°c chuy√™n ƒë·ªÅ c√≥ s·∫µn thay v√¨ ch·ªâ b√°o l·ªói
        const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        const topicsCount = allTopics.filter(t => !t.isExam).length;
        const examsCount = allTopics.filter(t => t.isExam).length;
        
        const message = `Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o!\n\n` +
                       `Hi·ªán t·∫°i c√≥ s·∫µn:\n` +
                       `‚Ä¢ ${topicsCount} chuy√™n ƒë·ªÅ √¥n t·∫≠p\n` +
                       `‚Ä¢ ${examsCount} b√†i thi\n\n` +
                       `H√£y l√†m m·ªôt s·ªë b√†i quiz ƒë·ªÉ xem th·ªëng k√™ chi ti·∫øt!`;
        
        alert(message);
        return;
      }
      
      // Calculate overall statistics
      const totalAttempts = allStats.length;
      const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...allStats.map(s => s.score));
      const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
      const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Group by topic
      const topicStats = {};
      allStats.forEach(stat => {
        if (!topicStats[stat.topicId]) {
          topicStats[stat.topicId] = {
            topicId: stat.topicId,
            name: stat.topicName,
            attempts: 0,
            totalScore: 0,
            bestScore: 0,
            totalQuestions: 0,
            totalCorrect: 0,
            totalWrong: 0,
            isExam: stat.isExam
          };
        }
        topicStats[stat.topicId].attempts++;
        topicStats[stat.topicId].totalScore += stat.score;
        topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
        topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
        topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
        topicStats[stat.topicId].totalWrong += stat.wrongAnswers;
      });
      
      // Calculate averages for each topic
      Object.values(topicStats).forEach(topic => {
        topic.avgScore = Math.round(topic.totalScore / topic.attempts);
      });
      
      // Sort topics by average score (descending)
      const sortedTopics = Object.values(topicStats).sort((a, b) => b.avgScore - a.avgScore);
      
      // Group wrong answers by topic
      const wrongAnswersByTopic = {};
      allWrongAnswers.forEach(answer => {
        if (!wrongAnswersByTopic[answer.topicId]) {
          wrongAnswersByTopic[answer.topicId] = [];
        }
        wrongAnswersByTopic[answer.topicId].push(answer);
      });
      
      // Replace entire body content with full-screen statistics page
      document.body.innerHTML = `
        <div style="
          background: white !important;
          width: 100% !important;
          height: 100vh !important;
          padding: 0 !important;
          margin: 0 !important;
          position: relative !important;
          z-index: 100000 !important;
          display: flex !important;
          flex-direction: column !important;
          border: none !important;
          box-shadow: none !important;
        ">
          <!-- Header -->
          <div style="
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            padding: 20px !important;
            border-bottom: 2px solid #e0e0e0 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            flex-shrink: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
          ">
            <h2 style="color: #800020; margin: 0; font-size: 28px;">
              üìä Th·ªëng k√™ t·ªïng qu√°t
            </h2>
            <button onclick="
              // Restore original body content
              if (window.originalBodyContent) {
                document.body.innerHTML = window.originalBodyContent;
                // Re-initialize event listeners
                document.addEventListener('DOMContentLoaded', function() {
                  // Re-initialize all event listeners here
                });
              }
            " style="
              background: #c62828;
              color: white;
              border: none;
              border-radius: 50%;
              width: 40px;
              height: 40px;
              cursor: pointer;
              font-size: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
            ">√ó</button>
          </div>
          
          <!-- Main Content Container -->
          <div style="
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 20px !important;
            width: 100% !important;
            box-sizing: border-box !important;
          ">
          
          <!-- Overall Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #1976d2; margin-bottom: 8px;">${totalAttempts}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">T·ªïng s·ªë l·∫ßn l√†m b√†i</div>
            </div>
            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #2e7d32; margin-bottom: 8px;">${avgScore}%</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">ƒêi·ªÉm trung b√¨nh</div>
            </div>
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #f57c00; margin-bottom: 8px;">${bestScore}%</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">ƒêi·ªÉm cao nh·∫•t</div>
            </div>
            <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #7b1fa2; margin-bottom: 8px;">${sortedTopics.length}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">Chuy√™n ƒë·ªÅ ƒë√£ l√†m</div>
            </div>
            <div style="background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #00695c; margin-bottom: 8px;">${totalCorrect}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">C√¢u tr·∫£ l·ªùi ƒë√∫ng</div>
            </div>
            <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #c62828; margin-bottom: 8px;">${totalWrong}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">C√¢u tr·∫£ l·ªùi sai</div>
            </div>
          </div>
          
          <!-- Online Leaderboard -->
          <div class="online-leaderboard-section" style="margin-bottom: 30px;">
            <h3 style="color: #800020; margin-bottom: 20px; font-size: 24px; text-align: center;">üèÜ B·∫£ng x·∫øp h·∫°ng Online</h3>
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div id="online-leaderboard" style="padding: 20px; min-height: 300px;">
                <div style="text-align: center; padding: 40px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 16px;">üåê</div>
                  <h4 style="color: #800020; margin-bottom: 8px;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ trang web...</h4>
                  <p>K·∫øt n·ªëi v·ªõi <a href="https://tvnghp.github.io/Tracnghiem/" target="_blank" style="color: #1976d2;">tvnghp.github.io/Tracnghiem</a></p>
                  <button onclick="loadOnlineLeaderboard()" style="
                    background: #1976d2;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-top: 16px;
                  ">
                    üîÑ T·∫£i l·∫°i
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Topic Statistics -->
          <div style="margin-bottom: 40px;">
            <h3 style="color: #800020; margin-bottom: 20px; font-size: 22px;">üìà Th·ªëng k√™ theo chuy√™n ƒë·ªÅ</h3>
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead style="background: #f5f5f5;">
                  <tr>
                    <th style="padding: 16px; text-align: left; font-weight: 600; color: #333;">Chuy√™n ƒë·ªÅ</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Lo·∫°i</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">L·∫ßn l√†m</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">ƒêi·ªÉm TB</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Cao nh·∫•t</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">C√¢u sai</th>
                    <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody>
                  ${sortedTopics.map((topic, index) => `
                    <tr style="border-bottom: 1px solid #f0f0f0; ${topic.name.includes('√în t·∫≠p c√¢u sai') ? 'background: #fff3e0;' : ''}">
                      <td style="padding: 16px; color: #333; font-weight: 600;">
                        ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">√îN T·∫¨P</span>
                            <span style="color: #f57c00;">${topic.name}</span>
                          </div>
                        ` : topic.name}
                      </td>
                      <td style="padding: 16px; text-align: center;">
                        <span style="background: ${topic.isExam ? '#ff9800' : topic.name.includes('√în t·∫≠p c√¢u sai') ? '#ff9800' : '#4caf50'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                          ${topic.isExam ? 'EXAM' : topic.name.includes('√în t·∫≠p c√¢u sai') ? 'REVIEW' : 'TOPIC'}
                        </span>
                      </td>
                      <td style="padding: 16px; text-align: center; color: #666;">${topic.attempts}</td>
                      <td style="padding: 16px; text-align: center; color: ${topic.avgScore >= 80 ? '#2e7d32' : topic.avgScore >= 60 ? '#f57c00' : '#c62828'}; font-weight: bold; font-size: 18px;">${topic.avgScore}%</td>
                      <td style="padding: 16px; text-align: center; color: #666;">${topic.bestScore}%</td>
                      <td style="padding: 16px; text-align: center; color: #c62828; font-weight: 600;">${topic.totalWrong}</td>
                      <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; gap: 6px; justify-content: center; flex-direction: column;">
                          <button onclick="exportTopicStatisticsExcel('${topic.topicId}')" style="background: #1976d2; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1976d2'" title="Xu·∫•t Excel">
                            <i class="material-icons" style="font-size: 14px;">download</i> Excel
                          </button>
                          <button onclick="createQuizFromWrongAnswers('${topic.topicId}', '${topic.name}')" style="background: #4caf50; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'" title="T·∫°o b√†i thi t·ª´ c√¢u sai">
                            <i class="material-icons" style="font-size: 14px;">quiz</i> T·∫°o b√†i
                          </button>
                          ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                          <button onclick="deleteReviewTopic('${topic.topicId}', '${topic.name}')" style="background: #f44336; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'" title="X√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p">
                            <i class="material-icons" style="font-size: 14px;">delete</i> X√≥a
                          </button>
                          ` : ''}
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          </div> <!-- End Main Content Container -->
          
          <!-- Action Buttons - Fixed at Bottom -->
          <div style="
            padding: 20px !important;
            border-top: 2px solid #e0e0e0 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            flex-shrink: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
          ">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; max-width: 100%; margin: 0;">
              <button onclick="exportGlobalStatisticsExcel()" class="btn" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; min-height: 52px;">
                <i class="material-icons">download</i> Xu·∫•t Excel
              </button>
              <button onclick="exportGlobalStatistics()" class="btn btn-outline" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; min-height: 52px;">
                <i class="material-icons">description</i> Xu·∫•t CSV
              </button>
              <button onclick="deleteAllReviewTopics()" class="btn btn-outline" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; min-height: 52px; background: #ffebee; color: #c62828; border-color: #ffcdd2;" onmouseover="this.style.background='#ffcdd2'" onmouseout="this.style.background='#ffebee'">
                <i class="material-icons">delete_sweep</i> X√≥a √¥n t·∫≠p
              </button>
              <button onclick="
                // Restore original body content
                if (window.originalBodyContent) {
                  document.body.innerHTML = window.originalBodyContent;
                  // Re-initialize event listeners
                  document.addEventListener('DOMContentLoaded', function() {
                    // Re-initialize all event listeners here
                  });
                }
              " class="btn btn-outline" style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 20px; font-size: 0.95rem; font-weight: 600; min-height: 52px;">
                <i class="material-icons">close</i> ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      `;
      
      // Load online leaderboard after content is replaced
      setTimeout(() => {
        loadOnlineLeaderboard();
      }, 100);
    }

    // Function to load online leaderboard data from Google Sheets
    async function loadOnlineLeaderboard() {
      const leaderboardContainer = document.getElementById('online-leaderboard');
      if (!leaderboardContainer) return;
      
      // Show loading state
      leaderboardContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
          <h4 style="color: #800020; margin-bottom: 8px;">ƒêang t·∫£i d·ªØ li·ªáu...</h4>
          <p>K·∫øt n·ªëi v·ªõi Google Sheets ƒë·ªÉ l·∫•y b·∫£ng x·∫øp h·∫°ng</p>
        </div>
      `;
      
      try {
        // Check if Google Sheets is configured
        if (!window.QUIZ_CONFIG || !window.isConfigured()) {
          throw new Error('Google Sheets ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh');
        }
        
        // Fetch data from Google Sheets
        const response = await fetch(`${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getLeaderboard`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu');
        }
        
        const data = result.data;
        
        // Display the leaderboard
        displayOnlineLeaderboard(data, leaderboardContainer);
        
      } catch (error) {
        console.error('Error loading online leaderboard:', error);
        
        // Hide the entire online leaderboard section if can't connect
        const onlineLeaderboardSection = leaderboardContainer.closest('.online-leaderboard-section');
        if (onlineLeaderboardSection) {
          onlineLeaderboardSection.style.display = 'none';
        }
      }
    }
    
    // Display the online leaderboard data
    function displayOnlineLeaderboard(data, container) {
      const { leaderboard, totalAttempts, avgScore, bestScore, lastUpdate } = data;
      
      if (!leaderboard || leaderboard.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h4 style="color: #800020; margin-bottom: 8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</h4>
            <p>Ch∆∞a c√≥ ai l√†m b√†i tr√™n h·ªá th·ªëng online</p>
            <button onclick="loadOnlineLeaderboard()" style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              margin-top: 16px;
            ">
              üîÑ T·∫£i l·∫°i
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="padding: 20px;">
          <!-- Summary Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalAttempts}</div>
              <div style="color: #666; font-size: 14px;">T·ªïng l·∫ßn l√†m b√†i</div>
            </div>
            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${avgScore}%</div>
              <div style="color: #666; font-size: 14px;">ƒêi·ªÉm trung b√¨nh</div>
            </div>
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${bestScore}%</div>
              <div style="color: #666; font-size: 14px;">ƒêi·ªÉm cao nh·∫•t</div>
            </div>
          </div>
          
          <!-- Top Users Leaderboard -->
          <h4 style="color: #800020; margin-bottom: 16px; font-size: 18px;">üèÜ B·∫£ng x·∫øp h·∫°ng ng∆∞·ªùi d√πng</h4>
          <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
              <thead style="background: #f5f5f5;">
                <tr>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">H·∫°ng</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">H·ªç t√™n</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">ƒê∆°n v·ªã</th>
                  <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Chuy√™n ƒë·ªÅ</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">ƒêi·ªÉm</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">K·∫øt qu·∫£</th>
                  <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">Th·ªùi gian</th>
                </tr>
              </thead>
              <tbody>
                ${leaderboard.slice(0, 20).map((user, index) => `
                  <tr style="border-bottom: 1px solid #e0e0e0; ${index < 3 ? 'background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);' : ''}">
                    <td style="padding: 12px; text-align: center; font-weight: 600;">
                      ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${user.rank}`}
                    </td>
                    <td style="padding: 12px; font-weight: 600; color: #333;">${user.fullname}</td>
                    <td style="padding: 12px; color: #666; font-size: 14px;">${user.branch}</td>
                    <td style="padding: 12px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: #333;">${user.topicName}</span>
                        ${user.isExam ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">THI</span>' : ''}
                      </div>
                    </td>
                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #2e7d32; font-size: 18px;">${user.score}%</td>
                    <td style="padding: 12px; text-align: center; color: #666; font-size: 14px;">${user.correctAnswers}/${user.totalQuestions}</td>
                    <td style="padding: 12px; text-align: center; color: #666; font-size: 12px;">${new Date(user.timestamp).toLocaleDateString('vi-VN')}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          
          <!-- Footer -->
          <div style="text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0; color: #666; font-size: 12px;">
            <p>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date(lastUpdate).toLocaleString('vi-VN')}</p>
            <button onclick="loadOnlineLeaderboard()" style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 12px;
              margin-top: 8px;
            ">
              üîÑ C·∫≠p nh·∫≠t
            </button>
          </div>
        </div>
      `;
    }

        function renderLists(all) {
          const exams = all.filter(t => t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0)));
          const topics = all.filter(t => !(t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0))));

          // Populate topic dropdown
          if (topics.length > 0) {
            topicSelect.innerHTML = '<option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>' + 
              topics.map(topic => `<option value="${topic.id}">${topic.name} (${topic.questions ? topic.questions.length : 0} c√¢u)</option>`).join('');
          } else {
            topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          }

          // Populate exam dropdown
          if (exams.length > 0) {
            examSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i thi --</option>' + 
              exams.map(exam => {
                const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
                const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A';
                return `<option value="${exam.id}">${exam.name} (${total} c√¢u, ${duration})</option>`;
              }).join('');
          } else {
            examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          }

          // Populate topic grid
          const topicsContainer = document.getElementById('topics-container');
          if (topicsContainer) {
            topicsContainer.innerHTML = topics.length ? topics.map(topic => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${topic.name}</h3>
                  <p>${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="quiz.html?topic=${encodeURIComponent(topic.id)}" class="btn" style="flex: 1;">
                      <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                    </a>
                    <button onclick="exportTopicToExcel('${topic.id}')" class="btn btn-outline" style="flex: 1;" title="Xu·∫•t c√¢u h·ªèi ra Excel">
                      <i class="material-icons">download</i> Excel
                    </button>
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">folder_open</i>
                <p>Ch∆∞a c√≥ chuy√™n ƒë·ªÅ n√†o</p>
              </div>`;
          }

          // Populate exam grid
          const examsContainer = document.getElementById('exams-container');
          if (examsContainer) {
            examsContainer.innerHTML = exams.length ? exams.map(exam => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${exam.name}</h3>
                  <p>${exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0)} c√¢u ‚Ä¢ ${exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A'}</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="quiz.html?topic=${encodeURIComponent(exam.id)}" class="btn" style="flex: 1;">
                      <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                    </a>
                    <button onclick="exportTopicToExcel('${exam.id}')" class="btn btn-outline" style="flex: 1;" title="Xu·∫•t c√¢u h·ªèi ra Excel">
                      <i class="material-icons">download</i> Excel
                    </button>
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">assignment</i>
                <p>Ch∆∞a c√≥ b√†i thi n√†o</p>
              </div>`;
          }

          // Store data for later use
          window.allTopics = topics;
          window.allExams = exams;
        }

        // View toggle functions
        function toggleTopicView() {
          const dropdownView = document.getElementById('topic-dropdown-view');
          const gridView = document.getElementById('topic-grid-view');
          const toggleBtn = document.getElementById('topic-view-toggle');
          const currentView = localStorage.getItem('index_topic_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_topic_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_topic_view', 'dropdown');
          }
        }

        function toggleExamView() {
          const dropdownView = document.getElementById('exam-dropdown-view');
          const gridView = document.getElementById('exam-grid-view');
          const toggleBtn = document.getElementById('exam-view-toggle');
          const currentView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_exam_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_exam_view', 'dropdown');
          }
        }

        function initializeViews() {
          const topicView = localStorage.getItem('index_topic_view') || 'dropdown';
          const examView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          const topicDropdown = document.getElementById('topic-dropdown-view');
          const topicGrid = document.getElementById('topic-grid-view');
          const topicToggleBtn = document.getElementById('topic-view-toggle');
          
          if (topicView === 'grid') {
            topicDropdown.style.display = 'none';
            topicGrid.style.display = 'block';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            topicDropdown.style.display = 'block';
            topicGrid.style.display = 'none';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
          
          const examDropdown = document.getElementById('exam-dropdown-view');
          const examGrid = document.getElementById('exam-grid-view');
          const examToggleBtn = document.getElementById('exam-view-toggle');
          
          if (examView === 'grid') {
            examDropdown.style.display = 'none';
            examGrid.style.display = 'block';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            examDropdown.style.display = 'block';
            examGrid.style.display = 'none';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
        }

        // Initialize views on load
        initializeViews();

        // View toggle event listeners with touch optimization
        document.getElementById('topic-view-toggle').addEventListener('click', toggleTopicView);
        document.getElementById('exam-view-toggle').addEventListener('click', toggleExamView);

        // Add touch optimization for mobile
        if ('ontouchstart' in window) {
          document.body.classList.add('touch-device');
          
          // Optimize button interactions for touch
          document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.95)';
            });
            
            btn.addEventListener('touchend', function() {
              this.style.transform = '';
            });
          });

          // Optimize answer interactions for touch
          document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.answer').forEach(answer => {
              answer.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
              });
              
              answer.addEventListener('touchend', function() {
                this.style.transform = '';
              });
            });
          });
        }

        // Topic selector change handler
        topicSelect.addEventListener('change', function(e) {
          const topicId = e.target.value;
          if (!topicId) {
            topicInfo.style.display = 'none';
            return;
          }
          
          const topic = window.allTopics.find(t => t.id === topicId);
          if (topic) {
            topicDescription.textContent = `${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi ‚Ä¢ Kh√¥ng gi·ªõi h·∫°n th·ªùi gian`;
            topicStartBtn.href = `quiz.html?topic=${encodeURIComponent(topic.id)}`;
            topicInfo.style.display = 'block';
          }
        });

        // Exam selector change handler
        examSelect.addEventListener('change', function(e) {
          const examId = e.target.value;
          if (!examId) {
            examInfo.style.display = 'none';
            return;
          }
          
          const exam = window.allExams.find(t => t.id === examId);
          if (exam) {
            const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
            const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'Kh√¥ng r√µ th·ªùi gian';
            const pauseText = exam.allowPause ? ' ‚Ä¢ Cho ph√©p t·∫°m d·ª´ng' : '';
            examDescription.textContent = `${total} c√¢u h·ªèi ‚Ä¢ ${duration}${pauseText}`;
            examStartBtn.href = `quiz.html?topic=${encodeURIComponent(exam.id)}`;
            examInfo.style.display = 'block';
          }
        });

        async function loadTopics() {
          console.log('Loading topics...');
          showLoadingState();
          
          // Try to load from hybrid storage first
          try {
            const localTopicsStr = await hybridStorageGet('quiz_topics');
            if (localTopicsStr) {
              const localTopics = JSON.parse(localTopicsStr);
              if (Array.isArray(localTopics) && localTopics.length > 0) {
                console.log('Loaded topics from storage:', localTopics.length);
                hideLoadingState();
                renderLists(localTopics);
                return;
              }
            }
          } catch (e) {
            console.warn('Error loading from storage:', e);
            // Clear corrupted data from both storages
            localStorage.removeItem('quiz_topics');
            try {
              await indexedDBStorage.removeItem('quiz_topics');
            } catch (dbError) {
              console.warn('Could not clear IndexedDB:', dbError);
            }
          }
          
          // Try to load from remote with multiple fallback strategies
          const urls = [
            './topics.json',
            'topics.json',
            window.location.origin + '/topics.json',
            window.location.href.replace(/\/[^\/]*$/, '/topics.json')
          ];
          
          for (const urlString of urls) {
            try {
              console.log('Trying to load from:', urlString);
              const url = new URL(urlString, location.href);
              url.searchParams.set('v', Date.now());
              
              const resp = await fetch(url, { 
                cache: 'no-store',
                headers: {
                  'Accept': 'application/json'
                }
              });
              
              console.log('Fetch response status:', resp.status, 'for URL:', urlString);
              
              if (resp.ok) {
                const remoteTopics = await resp.json();
                console.log('Remote topics loaded:', remoteTopics);
                
                if (Array.isArray(remoteTopics) && remoteTopics.length > 0) {
                  // Validate topic structure
                  const validTopics = remoteTopics.filter(topic => 
                    topic && 
                    typeof topic.id === 'string' && 
                    typeof topic.name === 'string' &&
                    Array.isArray(topic.questions)
                  );
                  
                  if (validTopics.length > 0) {
                    if (!(await hybridStorageSet('quiz_topics', JSON.stringify(validTopics)))) {
                      console.warn('Could not save topics to any storage');
                    } else {
                      console.log('Valid topics saved to storage:', validTopics.length);
                    }
                    hideLoadingState();
                    renderLists(validTopics);
                    return;
                  } else {
                    console.warn('No valid topics found in remote data');
                  }
                } else {
                  console.warn('Remote topics is not a valid array or is empty');
                }
              } else {
                console.error('Failed to fetch from', urlString, ':', resp.status, resp.statusText);
              }
            } catch(e) {
              console.error('Error loading from', urlString, ':', e);
            }
          }
          
          // Show empty state if all methods fail
          console.log('All loading methods failed, showing empty state');
          hideLoadingState();
          showEmptyState();
        }

        loadTopics();
      });


      // Delete all review topics (created from wrong answers)
      window.deleteAllReviewTopics = function() {
        const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        const reviewTopics = allTopics.filter(topic => topic.name.includes('√în t·∫≠p c√¢u sai'));
        
        if (reviewTopics.length === 0) {
          alert('Kh√¥ng c√≥ chuy√™n ƒë·ªÅ √¥n t·∫≠p n√†o ƒë·ªÉ x√≥a!');
          return;
        }
        
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ ${reviewTopics.length} chuy√™n ƒë·ªÅ √¥n t·∫≠p?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n- T·∫•t c·∫£ chuy√™n ƒë·ªÅ √¥n t·∫≠p\n- T·∫•t c·∫£ th·ªëng k√™ li√™n quan\n- Kh√¥ng th·ªÉ ho√†n t√°c`)) {
          return;
        }
        
        try {
          const reviewTopicIds = reviewTopics.map(topic => topic.id);
          
          // Remove all review topics
          const updatedTopics = allTopics.filter(topic => !topic.name.includes('√în t·∫≠p c√¢u sai'));
          localStorage.setItem('quiz_topics', JSON.stringify(updatedTopics));
          
          // Remove related statistics
          const allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
          const updatedStats = allStats.filter(stat => !reviewTopicIds.includes(stat.topicId));
          localStorage.setItem('quiz_statistics', JSON.stringify(updatedStats));
          
          // Remove related wrong answers
          const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
          const updatedWrongAnswers = allWrongAnswers.filter(answer => !reviewTopicIds.includes(answer.topicId));
          localStorage.setItem('wrong_answers', JSON.stringify(updatedWrongAnswers));
          
          alert(`ƒê√£ x√≥a th√†nh c√¥ng ${reviewTopics.length} chuy√™n ƒë·ªÅ √¥n t·∫≠p!`);
          
          // Refresh the global statistics display
          // Restore original body content and show statistics again
          if (window.originalBodyContent) {
            document.body.innerHTML = window.originalBodyContent;
            // Re-initialize event listeners
            document.addEventListener('DOMContentLoaded', function() {
              // Re-initialize all event listeners here
            });
            showGlobalStatistics();
          }
          
        } catch (error) {
          console.error('Error deleting all review topics:', error);
          alert('C√≥ l·ªói x·∫£y ra khi x√≥a chuy√™n ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      };

      // Delete review topic (created from wrong answers)
      window.deleteReviewTopic = function(topicId, topicName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy√™n ƒë·ªÅ "${topicName}"?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n- Chuy√™n ƒë·ªÅ √¥n t·∫≠p\n- T·∫•t c·∫£ th·ªëng k√™ li√™n quan\n- Kh√¥ng th·ªÉ ho√†n t√°c`)) {
          return;
        }
        
        try {
          // Get all topics
          const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
          
          // Remove the topic
          const updatedTopics = allTopics.filter(topic => topic.id !== topicId);
          localStorage.setItem('quiz_topics', JSON.stringify(updatedTopics));
          
          // Remove related statistics
          const allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
          const updatedStats = allStats.filter(stat => stat.topicId !== topicId);
          localStorage.setItem('quiz_statistics', JSON.stringify(updatedStats));
          
          // Remove related wrong answers
          const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
          const updatedWrongAnswers = allWrongAnswers.filter(answer => answer.topicId !== topicId);
          localStorage.setItem('wrong_answers', JSON.stringify(updatedWrongAnswers));
          
          alert('ƒê√£ x√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p th√†nh c√¥ng!');
          
          // Refresh the global statistics display
          // Restore original body content and show statistics again
          if (window.originalBodyContent) {
            document.body.innerHTML = window.originalBodyContent;
            // Re-initialize event listeners
            document.addEventListener('DOMContentLoaded', function() {
              // Re-initialize all event listeners here
            });
            showGlobalStatistics();
          }
          
        } catch (error) {
          console.error('Error deleting review topic:', error);
          alert('C√≥ l·ªói x·∫£y ra khi x√≥a chuy√™n ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      };

      // Create quiz from wrong answers
      window.createQuizFromWrongAnswers = function(topicId, topicName) {
        const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
        const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        
        // S·ª≠ d·ª•ng s·ªë l·∫ßn sai t·ªëi thi·ªÉu c·ªë ƒë·ªãnh
        const minWrongCount = 1;
        
        const topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicId === topicId);
        
        if (topicWrongAnswers.length === 0) {
          alert('Ch∆∞a c√≥ c√¢u sai n√†o cho chuy√™n ƒë·ªÅ n√†y!');
          return;
        }
        
        // ƒê·∫øm t·∫ßn su·∫•t sai c·ªßa m·ªói c√¢u
        const questionFrequency = {};
        topicWrongAnswers.forEach(answer => {
          const key = answer.question;
          if (!questionFrequency[key]) {
            questionFrequency[key] = {
              question: answer.question,
              options: answer.options,
              optionLabels: answer.optionLabels,
              correctAnswer: answer.correctAnswer,
              explanation: answer.explanation,
              count: 0
            };
          }
          questionFrequency[key].count++;
        });
        
        // L·ªçc theo s·ªë l·∫ßn sai v√† s·∫Øp x·∫øp
        const availableQuestions = Object.values(questionFrequency)
          .filter(q => q.count >= minWrongCount)
          .sort((a, b) => b.count - a.count);
        
        if (availableQuestions.length === 0) {
          alert('Kh√¥ng c√≥ c√¢u n√†o b·ªã sai ƒë·ªÉ t·∫°o b√†i thi!');
          return;
        }
        
        // H·ªèi s·ªë c√¢u h·ªèi mu·ªën t·∫°o
        const maxAvailable = availableQuestions.length;
        const numQuestions = prompt(
          'C√≥ ' + maxAvailable + ' c√¢u b·ªã sai\n\n' +
          'B·∫°n mu·ªën t·∫°o b√†i thi v·ªõi bao nhi√™u c√¢u?',
          Math.min(20, maxAvailable)
        );
        
        if (!numQuestions || numQuestions <= 0) {
          return; // H·ªßy
        }
        
        const questionCount = Math.min(parseInt(numQuestions), maxAvailable);
        const selectedQuestions = availableQuestions.slice(0, questionCount);
        
        const newTopicId = 'wrong_answers_quiz_' + Date.now();
        const newTopic = {
          id: newTopicId,
          name: '√în t·∫≠p c√¢u sai - ' + topicName + ' (' + questionCount + ' c√¢u)',
          questions: selectedQuestions.map(q => ({
            question: q.question,
            options: q.options,
            optionLabels: q.optionLabels,
            answer: q.correctAnswer,
            explain: q.explanation || ''
          })),
          isExam: false,
          createdFrom: 'wrong_answers',
          sourceTopicId: topicId,
          minWrongCount: minWrongCount,
          createdAt: new Date().toISOString()
        };
        
        const topics = allTopics;
        topics.push(newTopic);
        localStorage.setItem('quiz_topics', JSON.stringify(topics));
        
        if (confirm('ƒê√£ t·∫°o b√†i thi "' + newTopic.name + '"!\n\nB·∫°n c√≥ mu·ªën l√†m b√†i ngay kh√¥ng?')) {
          window.location.href = 'quiz.html?topic=' + newTopicId;
        } else {
          window.location.reload();
        }
      };

      // Export topic to Excel function with all answers displayed
      window.exportTopicToExcel = function(topicId) {
        const allTopicsData = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        const topic = allTopicsData.find(t => t.id === topicId);
        
        if (!topic) {
          alert('Kh√¥ng t√¨m th·∫•y chuy√™n ƒë·ªÅ!');
          return;
        }
        
        if (!topic.questions || topic.questions.length === 0) {
          alert('Chuy√™n ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi!');
          return;
        }
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Prepare data with all answers
        const questionsData = [
          ['Chuy√™n ƒë·ªÅ: ' + topic.name, '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch']
        ];
        
        topic.questions.forEach((q, index) => {
          // Map option labels to their text values
          const optionsMap = {};
          (q.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = q.options[i] || '';
          });
          
          questionsData.push([
            index + 1,
            q.question || '',
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            q.answer || '',
            q.explain || ''
          ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(questionsData);
        
        // Set column widths
        ws['!cols'] = [
          { width: 6 },   // STT
          { width: 60 },  // C√¢u h·ªèi
          { width: 30 },  // ƒê√°p √°n A
          { width: 30 },  // ƒê√°p √°n B
          { width: 30 },  // ƒê√°p √°n C
          { width: 30 },  // ƒê√°p √°n D
          { width: 12 },  // ƒê√°p √°n ƒë√∫ng
          { width: 50 }   // Gi·∫£i th√≠ch
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'C√¢u h·ªèi');
        
        // Save file
        const fileName = `${topic.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
      };

      // Export global statistics function
      window.exportGlobalStatisticsExcel = function() {
      const allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
      const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
      
      if (allStats.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o ƒë·ªÉ xu·∫•t!');
        return;
      }
      
      // Calculate overall statistics
      const totalAttempts = allStats.length;
      const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...allStats.map(s => s.score));
      const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
      const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Group by topic
      const topicStats = {};
      allStats.forEach(stat => {
        if (!topicStats[stat.topicId]) {
          topicStats[stat.topicId] = {
            topicId: stat.topicId,
            name: stat.topicName,
            attempts: 0,
            totalScore: 0,
            bestScore: 0,
            totalQuestions: 0,
            totalCorrect: 0,
            totalWrong: 0,
            isExam: stat.isExam
          };
        }
        topicStats[stat.topicId].attempts++;
        topicStats[stat.topicId].totalScore += stat.score;
        topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
        topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
        topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
        topicStats[stat.topicId].totalWrong += stat.wrongAnswers;
      });
      
      // Calculate averages for each topic
      Object.values(topicStats).forEach(topic => {
        topic.avgScore = Math.round(topic.totalScore / topic.attempts);
      });
      
      // Sort topics by average score (descending)
      const sortedTopics = Object.values(topicStats).sort((a, b) => b.avgScore - a.avgScore);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Summary sheet
      const summaryData = [
        ['Th·ªëng k√™ t·ªïng qu√°t - H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II', ''],
        ['T·ªïng s·ªë l·∫ßn l√†m b√†i', totalAttempts],
        ['ƒêi·ªÉm trung b√¨nh', avgScore + '%'],
        ['ƒêi·ªÉm cao nh·∫•t', bestScore + '%'],
        ['T·ªïng s·ªë c√¢u h·ªèi', totalQuestions],
        ['T·ªïng s·ªë c√¢u ƒë√∫ng', totalCorrect],
        ['T·ªïng s·ªë c√¢u sai', totalWrong],
        ['', ''],
        ['Th·ªëng k√™ theo chuy√™n ƒë·ªÅ', ''],
        ['STT', 'T√™n chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'L·∫ßn l√†m', 'ƒêi·ªÉm TB', 'ƒêi·ªÉm cao nh·∫•t', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai']
      ];
      
      sortedTopics.forEach((topic, index) => {
        summaryData.push([
          index + 1,
          topic.name,
          topic.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
          topic.attempts,
          topic.avgScore + '%',
          topic.bestScore + '%',
          topic.totalQuestions,
          topic.totalCorrect,
          topic.totalWrong
        ]);
      });
      
      const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
      ws1['!cols'] = [
        { width: 8 },
        { width: 30 },
        { width: 12 },
        { width: 10 },
        { width: 12 },
        { width: 12 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng quan');
      
      // Detailed attempts sheet
      const attemptsData = [
        ['Chi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i', ''],
        ['Th·ªùi gian', 'T√™n chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai', 'ƒêi·ªÉm']
      ];
      
      allStats.forEach(stat => {
        attemptsData.push([
          new Date(stat.timestamp).toLocaleString('vi-VN'),
          stat.topicName,
          stat.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
          stat.totalQuestions,
          stat.correctAnswers,
          stat.wrongAnswers,
          stat.score + '%'
        ]);
      });
      
      const ws2 = XLSX.utils.aoa_to_sheet(attemptsData);
      ws2['!cols'] = [
        { width: 20 },
        { width: 30 },
        { width: 12 },
        { width: 10 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt l·∫ßn l√†m');
      
      // Wrong answers sheet with all options displayed
      if (allWrongAnswers.length > 0) {
        const wrongAnswersData = [
          ['C√¢u tr·∫£ l·ªùi sai chi ti·∫øt', '', '', '', '', '', '', '', ''],
          ['STT', 'Chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n c·ªßa b·∫°n', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch', 'Th·ªùi gian']
        ];
        
        allWrongAnswers.forEach((answer, index) => {
          // Map option labels to their text values
          const optionsMap = {};
          (answer.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = answer.options[i] || '';
          });
          
          wrongAnswersData.push([
            index + 1,
            answer.topicName,
            answer.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
            answer.question,
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            answer.userAnswer,
            answer.correctAnswer,
            answer.explanation || '',
            new Date(answer.timestamp).toLocaleString('vi-VN')
          ]);
        });
        
        const ws3 = XLSX.utils.aoa_to_sheet(wrongAnswersData);
        ws3['!cols'] = [
          { width: 6 },   // STT
          { width: 25 },  // Chuy√™n ƒë·ªÅ
          { width: 12 },  // Lo·∫°i
          { width: 60 },  // C√¢u h·ªèi
          { width: 30 },  // ƒê√°p √°n A
          { width: 30 },  // ƒê√°p √°n B
          { width: 30 },  // ƒê√°p √°n C
          { width: 30 },  // ƒê√°p √°n D
          { width: 15 },  // ƒê√°p √°n c·ªßa b·∫°n
          { width: 15 },  // ƒê√°p √°n ƒë√∫ng
          { width: 40 },  // Gi·∫£i th√≠ch
          { width: 20 }   // Th·ªùi gian
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'C√¢u sai');
      }
      
      // Save file
      const fileName = `thong-ke-tong-quat-${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
    };

    // Export statistics for a specific topic
    window.exportTopicStatisticsExcel = function(topicId) {
      const allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
      const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
      const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
      
      // L·ªçc d·ªØ li·ªáu theo topicId
      const topicStats = allStats.filter(stat => stat.topicId === topicId);
      const topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicId === topicId);
      const topic = allTopics.find(t => t.id === topicId);
      
      if (topicStats.length === 0) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ cho chuy√™n ƒë·ªÅ n√†y!');
        return;
      }
      
      const topicName = topic ? topic.name : (topicStats[0] ? topicStats[0].topicName : 'Unknown');
      
      // T√≠nh to√°n th·ªëng k√™
      const totalAttempts = topicStats.length;
      const avgScore = Math.round(topicStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...topicStats.map(s => s.score));
      const totalCorrect = topicStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = topicStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Summary sheet
      const summaryData = [
        ['Th·ªëng k√™ chuy√™n ƒë·ªÅ: ' + topicName, ''],
        ['T·ªïng s·ªë l·∫ßn l√†m b√†i', totalAttempts],
        ['ƒêi·ªÉm trung b√¨nh', avgScore + '%'],
        ['ƒêi·ªÉm cao nh·∫•t', bestScore + '%'],
        ['T·ªïng s·ªë c√¢u ƒë√∫ng', totalCorrect],
        ['T·ªïng s·ªë c√¢u sai', totalWrong],
        ['', ''],
        ['Chi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i', ''],
        ['Th·ªùi gian', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai', 'ƒêi·ªÉm']
      ];
      
      topicStats.forEach(stat => {
        summaryData.push([
          new Date(stat.timestamp).toLocaleString('vi-VN'),
          stat.totalQuestions,
          stat.correctAnswers,
          stat.wrongAnswers,
          stat.score + '%'
        ]);
      });
      
      const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
      ws1['!cols'] = [
        { width: 20 },
        { width: 15 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng quan');
      
      // C√¢u h·ªèi t·ª´ chuy√™n ƒë·ªÅ (n·∫øu c√≥)
      if (topic && topic.questions && topic.questions.length > 0) {
        const questionsData = [
          ['Danh s√°ch c√¢u h·ªèi - ' + topicName, '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch']
        ];
        
        topic.questions.forEach((q, index) => {
          const optionsMap = {};
          (q.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = q.options[i] || '';
          });
          
          questionsData.push([
            index + 1,
            q.question || '',
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            q.answer || '',
            q.explain || ''
          ]);
        });
        
        const ws2 = XLSX.utils.aoa_to_sheet(questionsData);
        ws2['!cols'] = [
          { width: 6 },
          { width: 60 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 12 },
          { width: 50 }
        ];
        XLSX.utils.book_append_sheet(wb, ws2, 'C√¢u h·ªèi');
      }
      
      // Wrong answers sheet
      if (topicWrongAnswers.length > 0) {
        const wrongAnswersData = [
          ['C√¢u tr·∫£ l·ªùi sai - ' + topicName, '', '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n c·ªßa b·∫°n', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch', 'Th·ªùi gian']
        ];
        
        topicWrongAnswers.forEach((answer, index) => {
          const optionsMap = {};
          (answer.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = answer.options[i] || '';
          });
          
          wrongAnswersData.push([
            index + 1,
            answer.question,
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            answer.userAnswer,
            answer.correctAnswer,
            answer.explanation || '',
            new Date(answer.timestamp).toLocaleString('vi-VN')
          ]);
        });
        
        const ws3 = XLSX.utils.aoa_to_sheet(wrongAnswersData);
        ws3['!cols'] = [
          { width: 6 },
          { width: 60 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 15 },
          { width: 15 },
          { width: 40 },
          { width: 20 }
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'C√¢u sai');
      }
      
      // Save file
      const fileName = `thong-ke-${topicName.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
    };

    window.exportGlobalStatistics = function() {
        const allStats = JSON.parse(localStorage.getItem('quiz_statistics') || '[]');
        const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
        
        if (allStats.length === 0) {
          alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o ƒë·ªÉ xu·∫•t!');
          return;
        }
        
        // Calculate overall statistics
        const totalAttempts = allStats.length;
        const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
        const bestScore = Math.max(...allStats.map(s => s.score));
        const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
        const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
        const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
        
        // Group by topic
        const topicStats = {};
        allStats.forEach(stat => {
          if (!topicStats[stat.topicId]) {
            topicStats[stat.topicId] = {
              name: stat.topicName,
              attempts: 0,
              totalScore: 0,
              bestScore: 0,
              totalQuestions: 0,
              totalCorrect: 0,
              totalWrong: 0,
              isExam: stat.isExam
            };
          }
          topicStats[stat.topicId].attempts++;
          topicStats[stat.topicId].totalScore += stat.score;
          topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
          topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
          topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
          topicStats[stat.topicId].totalWrong += stat.wrongAnswers;
        });
        
        // Calculate averages for each topic
        Object.values(topicStats).forEach(topic => {
          topic.avgScore = Math.round(topic.totalScore / topic.attempts);
        });
        
        // Sort topics by average score (descending)
        const sortedTopics = Object.values(topicStats).sort((a, b) => b.avgScore - a.avgScore);
        
        // Create CSV content
        let csvContent = 'Th·ªëng k√™ t·ªïng qu√°t - H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II\n\n';
        csvContent += 'T·ªïng s·ªë l·∫ßn l√†m b√†i,' + totalAttempts + '\n';
        csvContent += 'ƒêi·ªÉm trung b√¨nh,' + avgScore + '%\n';
        csvContent += 'ƒêi·ªÉm cao nh·∫•t,' + bestScore + '%\n';
        csvContent += 'T·ªïng s·ªë c√¢u h·ªèi,' + totalQuestions + '\n';
        csvContent += 'T·ªïng s·ªë c√¢u ƒë√∫ng,' + totalCorrect + '\n';
        csvContent += 'T·ªïng s·ªë c√¢u sai,' + totalWrong + '\n\n';
        
        csvContent += 'Th·ªëng k√™ theo chuy√™n ƒë·ªÅ:\n';
        csvContent += 'STT,T√™n chuy√™n ƒë·ªÅ,Lo·∫°i,L·∫ßn l√†m,ƒêi·ªÉm TB,ƒêi·ªÉm cao nh·∫•t,T·ªïng c√¢u,ƒê√∫ng,Sai\n';
        sortedTopics.forEach((topic, index) => {
          csvContent += (index + 1) + ',"' + 
                       topic.name.replace(/"/g, '""') + '","' + 
                       (topic.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ') + '",' + 
                       topic.attempts + ',' + 
                       topic.avgScore + '%,' + 
                       topic.bestScore + '%,' + 
                       topic.totalQuestions + ',' + 
                       topic.totalCorrect + ',' + 
                       topic.totalWrong + '\n';
        });
        
        csvContent += '\nChi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i:\n';
        csvContent += 'Th·ªùi gian,T√™n chuy√™n ƒë·ªÅ,Lo·∫°i,T·ªïng c√¢u,ƒê√∫ng,Sai,ƒêi·ªÉm\n';
        allStats.forEach(stat => {
          csvContent += new Date(stat.timestamp).toLocaleString('vi-VN') + ',"' + 
                       stat.topicName.replace(/"/g, '""') + '","' + 
                       (stat.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ') + '",' + 
                       stat.totalQuestions + ',' + 
                       stat.correctAnswers + ',' + 
                       stat.wrongAnswers + ',' + 
                       stat.score + '%\n';
        });
        
        // Download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `thong-ke-tong-quat-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
    </script>

  </div>
  
  <footer style="background: linear-gradient(135deg, #8e0e00 0%, #1f1c18 100%); color: #fff; padding: 40px 20px 20px; margin-top: 60px; position: relative; overflow: hidden;">
    <div style="max-width: 1200px; margin: 0 auto; position: relative; z-index: 1;">
      <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 40px; margin-bottom: 30px;" class="footer-content">
        <div style="flex: 1; min-width: 300px;">
          <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
            <img src="logo.png" alt="Logo" style="width: 70px; height: 70px; object-fit: contain; filter: brightness(0) invert(1);">
            <div>
              <h3 style="font-size: 1.1em; margin: 0 0 5px; color: #fff; font-weight: 600;">H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám</h3>
              <p style="margin: 0; color: rgba(255, 255, 255, 0.8); font-size: 0.95em;">Chi nh√°nh C·∫ßn Th∆° II</p>
            </div>
          </div>
          <p style="color: rgba(255, 255, 255, 0.8); line-height: 1.6; margin: 0;">
            H·ªá th·ªëng h·ªó tr·ª£ h·ªçc t·∫≠p v√† ƒë√°nh gi√° ki·∫øn th·ª©c th√¥ng qua c√°c b√†i thi tr·∫Øc nghi·ªám tr·ª±c tuy·∫øn. 
            ƒê∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ mang l·∫°i tr·∫£i nghi·ªám h·ªçc t·∫≠p hi·ªáu qu·∫£ v√† ti·ªán l·ª£i.
          </p>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 8px; min-width: 300px; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.1);">
          <h4 style="color: #fff; margin-top: 0; margin-bottom: 20px; font-size: 1.3em; padding-bottom: 10px; border-bottom: 2px solid #800020; display: inline-block;">Li√™n h·ªá h·ªó tr·ª£</h4>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease;">
            <i class="material-icons" style="color: #800020; font-size: 1.2em; min-width: 24px; text-align: center;">person</i>
            <span>Nguy·ªÖn Th√†nh Trung</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease;">
            <i class="material-icons" style="color: #800020; font-size: 1.2em; min-width: 24px; text-align: center;">phone</i>
            <span>0947.86.86.82</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease;">
            <i class="material-icons" style="color: #800020; font-size: 1.2em; min-width: 24px; text-align: center;">email</i>
            <span>trungnguyenthanh1@agribank.com.vn</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; color: rgba(255, 255, 255, 0.9); padding: 8px 12px; border-radius: 6px; transition: all 0.3s ease;">
            <i class="material-icons" style="color: #800020; font-size: 1.2em; min-width: 24px; text-align: center;">business</i>
            <span>Agribank Chi nh√°nh C·∫ßn Th∆° II</span>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; padding-top: 25px; margin-top: 25px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6); font-size: 0.9em;">
        <strong>B·∫£n quy·ªÅn ¬© 2025 H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II.</strong><br>
        T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u. H·ªá th·ªëng ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi ƒë·ªôi ng≈© IT Agribank.
      </div>
    </div>
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #800020;"></div>
  </footer>
  
  <script src="mobile-touch.js"></script>
  
  <script>
    // Register Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered'))
          .catch(err => console.log('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>
