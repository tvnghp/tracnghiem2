<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám Chi nh√°nh C·∫ßn Th∆° II</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <!-- Force browser to reload fresh content (no cache) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  
  <link rel="stylesheet" href="styles.css?v=20250112">
  <link rel="stylesheet" href="mobile-enhancements.css?v=20250112">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Theme and PWA meta tags -->
  <meta name="theme-color" content="#800020">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="format-detection" content="telephone=no">
  
  <!-- iOS specific meta tags -->
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Quiz C·∫ßn Th∆° II">
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  
  <!-- Excel export library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Android specific meta tags -->
  <meta name="application-name" content="Quiz C·∫ßn Th∆° II">
  <meta name="msapplication-TileColor" content="#800020">
  <meta name="msapplication-tap-highlight" content="no">
  
  <!-- Android Chrome specific -->
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#800020" media="(prefers-color-scheme: dark)">
  
  <!-- Manifest and icons -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="logo.png">
  <link rel="icon" type="image/png" sizes="512x512" href="logo.png">
  <!-- Config file -->
  <script src="config.js?v=20250112"></script>
  <script src="indexeddb-storage.js?v=20250112"></script>
  <script src="storage-wrapper.js?v=20250112"></script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* iPhone specific optimizations */
    @supports (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -webkit-text-size-adjust: 100%;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        border-radius: 0;
      }
      
      button {
        -webkit-appearance: none;
        -webkit-tap-highlight-color: transparent;
      }
    }
    
    /* Android specific optimizations */
    @supports not (-webkit-touch-callout: none) {
      body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
      }
      
      input, select, textarea {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        border-radius: 8px;
      }
      
      button {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        -webkit-tap-highlight-color: transparent;
        -moz-tap-highlight-color: transparent;
        tap-highlight-color: transparent;
      }
      
      /* Android Chrome specific optimizations */
      .container {
        -webkit-overflow-scrolling: touch;
        overflow-scrolling: touch;
      }
      
      /* Better touch targets for Android */
      .btn, .answer, .topic-card {
        min-height: 48px;
        min-width: 48px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <img src="logo.png" alt="Logo" id="logo-img" onerror="console.error('Logo load failed:', this.src);">
        <div class="logo-text">
          <h1>H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám</h1>
          <p>Chi nh√°nh C·∫ßn Th∆° II</p>
        </div>
      </div>
    </header>

    <div class="content">
      <div class="welcome-section">
        <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II</h2>
        <p>Ch·ªçn chuy√™n m·ª•c ph√π h·ª£p b√™n d∆∞·ªõi:</p>
      </div>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">Chuy√™n ƒë·ªÅ (kh√¥ng gi·ªõi h·∫°n th·ªùi gian)</h3>
          <button id="topic-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="topic-dropdown-view">
          <div class="form-group">
            <label for="topic-select">Ch·ªçn chuy√™n ƒë·ªÅ ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="topic-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>
            </select>
          </div>
          <div id="topic-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="topic-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="topic-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="topic-grid-view" style="display: none;">
          <div id="topics-container" class="topics-grid"></div>
        </div>
      </section>

      <section class="mt-4">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <h3 style="margin: 0;">B√†i thi (c√≥ th·ªùi gian)</h3>
          <button id="exam-view-toggle" class="btn btn-outline" style="padding: 6px 12px; font-size: 0.9rem;">
            <i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi
          </button>
        </div>
        
        <!-- Dropdown View -->
        <div id="exam-dropdown-view">
          <div class="form-group">
            <label for="exam-select">Ch·ªçn b√†i thi ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
            <select id="exam-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #d4a5a5; font-size: 1rem;">
              <option value="">-- Ch·ªçn b√†i thi --</option>
            </select>
          </div>
          <div id="exam-info" style="display: none; margin-top: 16px; padding: 16px; background: #f8f6f8; border-radius: 8px; border-left: 4px solid #800020;">
            <p id="exam-description" style="margin: 0 0 12px; color: #666;"></p>
            <a id="exam-start-btn" href="#" class="btn" style="display: inline-flex;">
              <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu thi
            </a>
          </div>
        </div>
        
        <!-- Grid View -->
        <div id="exam-grid-view" style="display: none;">
          <div id="exams-container" class="topics-grid"></div>
        </div>
      </section>

      <div class="admin-section">
        <div class="admin-buttons-grid">
          <a href="admin.html" class="btn btn-outline admin-btn">
            <i class="material-icons">admin_panel_settings</i> Qu·∫£n tr·ªã vi√™n
          </a>
          <button id="hard-reload-btn" type="button" class="btn btn-outline admin-btn" title="üîÑ C·∫≠p nh·∫≠t CODE m·ªõi (JS/CSS/HTML) - T∆∞∆°ng ƒë∆∞∆°ng Ctrl+Shift+R">
            <i class="material-icons">refresh</i> Hard Reload (Code)
          </button>
          <button id="refresh-data-btn" type="button" class="btn btn-outline admin-btn" title="üì• C·∫≠p nh·∫≠t N·ªòI DUNG c√¢u h·ªèi m·ªõi t·ª´ topics.json (kh√¥ng reload trang)">
            <i class="material-icons">cloud_download</i> T·∫£i c√¢u h·ªèi m·ªõi
          </button>
          <button id="clear-storage-btn" type="button" class="btn btn-outline admin-btn" title="üóëÔ∏è X√≥a TO√ÄN B·ªò d·ªØ li·ªáu: IndexedDB, LocalStorage, Cache (reset v·ªÅ ban ƒë·∫ßu)">
            <i class="material-icons">delete_sweep</i> X√≥a to√†n b·ªô d·ªØ li·ªáu
          </button>
          <button id="global-stats-btn" type="button" class="btn btn-outline admin-btn">
            <i class="material-icons">analytics</i> Th·ªëng k√™ t·ªïng qu√°t
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // üîÑ Auto-cleanup: X√≥a localStorage c≈© (quiz progress ƒë√£ chuy·ªÉn sang IndexedDB)
        // Ch·ªâ gi·ªØ l·∫°i admin credentials v√† deleted_review_topics
        const keysToKeep = ['admin_credentials', 'admin_authenticated', 'deleted_review_topics', 'deleted_review_topics_map'];
        const keysToRemove = [];
        
        try {
          for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && !keysToKeep.includes(key)) {
              keysToRemove.push(key);
            }
          }
          
          // X√≥a c√°c key kh√¥ng c·∫ßn thi·∫øt (ƒë·∫∑c bi·ªát l√† quiz_topics c≈©)
          if (keysToRemove.length > 0) {
            console.log('üßπ Cleaning up old localStorage keys:', keysToRemove);
            keysToRemove.forEach(key => {
              try {
                localStorage.removeItem(key);
              } catch (e) {
                console.error('Error removing key:', key, e);
              }
            });
          }
          
          // Force clear quiz_topics if it exists (ƒë·∫£m b·∫£o kh√¥ng c√≤n data c≈©)
          if (localStorage.getItem('quiz_topics')) {
            console.log('üóëÔ∏è Removing old quiz_topics from localStorage');
            localStorage.removeItem('quiz_topics');
          }
        } catch (e) {
          console.error('Error during cleanup:', e);
          // If localStorage is full, show alert immediately
          if (e.name === 'QuotaExceededError') {
            const shouldClear = confirm(
              '‚ö†Ô∏è C·∫¢NH B√ÅO: B·ªô nh·ªõ LocalStorage ƒë√£ ƒë·∫ßy!\n\n' +
              'Browser c·ªßa b·∫°n c√≥ th·ªÉ ƒëang cache code c≈©.\n\n' +
              '‚úÖ GI·∫¢I PH√ÅP:\n' +
              '1. Click OK ƒë·ªÉ x√≥a d·ªØ li·ªáu c≈©\n' +
              '2. Sau ƒë√≥ nh·∫•n Ctrl+Shift+R\n' +
              '   (hard reload ƒë·ªÉ x√≥a cache)\n\n' +
              'Ti·∫øp t·ª•c?'
            );
            
            if (shouldClear) {
              try {
                // Save critical data to sessionStorage temporarily
                keysToKeep.forEach(key => {
                  try {
                    const value = localStorage.getItem(key);
                    if (value) {
                      sessionStorage.setItem(key, value);
                    }
                  } catch (err) {
                    console.error('Error saving to sessionStorage:', err);
                  }
                });
                
                // Clear localStorage
                localStorage.clear();
                
                // Restore critical data
                keysToKeep.forEach(key => {
                  try {
                    const value = sessionStorage.getItem(key);
                    if (value) {
                      localStorage.setItem(key, value);
                      sessionStorage.removeItem(key);
                    }
                  } catch (err) {
                    console.error('Error restoring from sessionStorage:', err);
                  }
                });
                
                console.log('‚úÖ Forced localStorage cleanup due to quota exceeded');
                alert('‚úÖ ƒê√£ x√≥a xong!\n\nüîÑ B√ÇY GI·ªú NH·∫§N:\n‚Ä¢ Ctrl+Shift+R (Windows)\n‚Ä¢ Cmd+Shift+R (Mac)\n\nƒë·ªÉ t·∫£i code m·ªõi!');
              } catch (cleanupError) {
                console.error('Failed to cleanup localStorage:', cleanupError);
                alert('‚ùå L·ªói khi x√≥a.\n\nVui l√≤ng:\n1. F12 ‚Üí Application ‚Üí Storage\n2. Clear site data\n3. Reload');
              }
            }
          }
        }
        
        // üîÑ AUTO-MIGRATION: Copy data t·ª´ localStorage sang IndexedDB
        (async function autoMigrateToIndexedDB() {
          try {
            // Wait for IndexedDB to be ready
            if (window.db && window.db.ready) {
              await window.db.ready;
              
              // Check if we have data in localStorage that needs migration
              const hasLocalStats = localStorage.getItem('quiz_statistics');
              const hasLocalWrongAnswers = localStorage.getItem('wrong_answers');
              const hasLocalBlacklist = localStorage.getItem('deleted_review_topics');
              
              if (hasLocalStats || hasLocalWrongAnswers || hasLocalBlacklist) {
                console.log('üì¶ Found data in localStorage, starting migration to IndexedDB...');
                
                // Perform migration
                const migrated = await window.db.migrateFromLocalStorage();
                
                if (migrated.statistics > 0 || migrated.wrongAnswers > 0 || migrated.config > 0) {
                  console.log('‚úÖ Migration completed:', migrated);
                  
                  // Clear migrated data from localStorage to save space
                  if (migrated.statistics > 0) {
                    localStorage.removeItem('quiz_statistics');
                    console.log('üóëÔ∏è Removed quiz_statistics from localStorage');
                  }
                  if (migrated.wrongAnswers > 0) {
                    localStorage.removeItem('wrong_answers');
                    console.log('üóëÔ∏è Removed wrong_answers from localStorage');
                  }
                  // Keep blacklist in localStorage as backup for now
                }
              } else {
                console.log('‚úÖ No data to migrate from localStorage');
              }
            }
          } catch (error) {
            console.error('‚ùå Auto-migration error:', error);
            // Don't show alert, just log - migration will retry next time
          }
        })();
        
        const topicSelect = document.getElementById('topic-select');
        const examSelect = document.getElementById('exam-select');
        const topicInfo = document.getElementById('topic-info');
        const examInfo = document.getElementById('exam-info');
        const topicDescription = document.getElementById('topic-description');
        const examDescription = document.getElementById('exam-description');
        const topicStartBtn = document.getElementById('topic-start-btn');
        const examStartBtn = document.getElementById('exam-start-btn');
        const hardReloadBtn = document.getElementById('hard-reload-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');
        const refreshDataBtn = document.getElementById('refresh-data-btn');
        const globalStatsBtn = document.getElementById('global-stats-btn');

        function showEmptyState() {
          topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          topicInfo.style.display = 'none';
          examInfo.style.display = 'none';
          
          // Show error message
          const errorMsg = document.createElement('div');
          errorMsg.id = 'loading-error';
          errorMsg.style.cssText = `
            background: #ffebee;
            color: #c62828;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #f44336;
            text-align: center;
          `;
          errorMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">error</i>
            Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ c√°c c√°ch sau:
            <br><br>
            <strong>C√°ch 1:</strong> Nh·∫•n n√∫t "T·∫£i l·∫°i d·ªØ li·ªáu" b√™n d∆∞·ªõi
            <br><strong>C√°ch 2:</strong> Ki·ªÉm tra k·∫øt n·ªëi m·∫°ng v√† t·∫£i l·∫°i trang
            <br><strong>C√°ch 3:</strong> X√≥a cache tr√¨nh duy·ªát (Ctrl+F5)
            <br><br>
            <small>N·∫øu v·∫´n kh√¥ng ƒë∆∞·ª£c, li√™n h·ªá qu·∫£n tr·ªã vi√™n: trungnguyenthanh1@agribank.com.vn</small>
          `;
          
          const container = document.querySelector('.content');
          const existingError = document.getElementById('loading-error');
          if (existingError) {
            existingError.remove();
          }
          container.insertBefore(errorMsg, container.firstChild);
        }
        
        function showLoadingState() {
          const loadingMsg = document.createElement('div');
          loadingMsg.id = 'loading-indicator';
          loadingMsg.style.cssText = `
            background: #e3f2fd;
            color: #1976d2;
            padding: 16px;
            border-radius: 8px;
            margin: 16px 0;
            border-left: 4px solid #2196f3;
            text-align: center;
          `;
          loadingMsg.innerHTML = `
            <i class="material-icons" style="vertical-align: middle; margin-right: 8px; animation: spin 1s linear infinite;">refresh</i>
            ƒêang t·∫£i d·ªØ li·ªáu...
          `;
          
          const container = document.querySelector('.content');
          const existingLoading = document.getElementById('loading-indicator');
          const existingError = document.getElementById('loading-error');
          if (existingLoading) existingLoading.remove();
          if (existingError) existingError.remove();
          container.insertBefore(loadingMsg, container.firstChild);
        }
        
        function hideLoadingState() {
          const loading = document.getElementById('loading-indicator');
          if (loading) loading.remove();
        }

        // Hard Reload function (t∆∞∆°ng ƒë∆∞∆°ng Ctrl+Shift+R)
        async function performHardReload() {
          try {
            let actions = [];
            
            // 1. Clear Service Worker cache (kh√¥ng unregister SW)
            if ('caches' in window) {
              const cacheNames = await caches.keys();
              for (const cacheName of cacheNames) {
                await caches.delete(cacheName);
                actions.push(`‚úì X√≥a cache: ${cacheName}`);
              }
            }
            
            // 2. Tell Service Worker to skip waiting (if there's an update)
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
              navigator.serviceWorker.controller.postMessage({ action: 'skipWaiting' });
              actions.push('‚úì Service Worker: skip waiting');
            }
            
            console.log('‚úÖ Hard Reload actions:', actions);
            
            // 3. Force reload (bypass cache)
            // Use multiple methods to ensure cache bypass
            setTimeout(() => {
              window.location.reload(true); // Force reload from server
            }, 100);
            
          } catch (e) {
            console.error('‚ùå Error during hard reload:', e);
            // Fallback: simple reload
            alert('‚ö†Ô∏è C√≥ l·ªói khi x√≥a cache.\n\nƒêang reload trang...');
            window.location.reload(true);
          }
        }

        async function clearWebStorage() {
          const confirmed = confirm(
            '‚ö†Ô∏è C·∫¢NH B√ÅO: X√≥a to√†n b·ªô d·ªØ li·ªáu!\n\n' +
            'H√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n' +
            '‚úì IndexedDB (quiz progress, statistics, wrong answers)\n' +
            '‚úì LocalStorage (settings)\n' +
            '‚úì SessionStorage (temporary data)\n' +
            '‚úì Browser cache\n\n' +
            'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?'
          );
          
          if (!confirmed) return;
          
          try {
            let deletedItems = [];
            
            // 1. Clear IndexedDB
            if (window.indexedDB) {
              try {
                const dbs = await window.indexedDB.databases();
                for (const db of dbs) {
                  window.indexedDB.deleteDatabase(db.name);
                  deletedItems.push(`IndexedDB: ${db.name}`);
                }
              } catch (e) {
                console.error('Error deleting IndexedDB:', e);
                // Fallback: delete known database
                window.indexedDB.deleteDatabase('QuizAppDB');
                deletedItems.push('IndexedDB: QuizAppDB');
              }
            }
            
            // 2. Clear localStorage
            localStorage.clear();
            deletedItems.push('LocalStorage');
            
            // 3. Clear sessionStorage
            sessionStorage.clear();
            deletedItems.push('SessionStorage');
            
            // 4. Clear Service Worker cache
            if ('caches' in window) {
              const cacheNames = await caches.keys();
              for (const cacheName of cacheNames) {
                await caches.delete(cacheName);
                deletedItems.push(`Cache: ${cacheName}`);
              }
            }
            
            // 5. Unregister Service Worker
            if ('serviceWorker' in navigator) {
              const registrations = await navigator.serviceWorker.getRegistrations();
              for (const registration of registrations) {
                await registration.unregister();
                deletedItems.push('Service Worker');
              }
            }
            
            console.log('‚úÖ Deleted:', deletedItems);
            
            alert(
              '‚úÖ ƒê√£ x√≥a th√†nh c√¥ng!\n\n' +
              'ƒê√£ x√≥a:\n' +
              deletedItems.map(item => '‚Ä¢ ' + item).join('\n') + '\n\n' +
              'üîÑ Trang s·∫Ω t·ª± ƒë·ªông reload...'
            );
            
            // Reload page after 2 seconds
            setTimeout(() => {
              window.location.reload(true);
            }, 2000);
            
          } catch (e) {
            console.error('Error clearing storage:', e);
            alert('‚ö†Ô∏è C√≥ l·ªói khi x√≥a d·ªØ li·ªáu:\n' + (e && e.message ? e.message : e));
          }
        }

        // Ki·ªÉm tra dung l∆∞·ª£ng localStorage
        function checkLocalStorageUsage() {
          try {
            let totalSize = 0;
            for (let key in localStorage) {
              if (localStorage.hasOwnProperty(key)) {
                totalSize += localStorage[key].length + key.length;
              }
            }
            
            const sizeInMB = (totalSize / (1024 * 1024)).toFixed(2);
            const quotaLimit = 5; // 5MB l√† gi·ªõi h·∫°n ph·ªï bi·∫øn
            
            if (parseFloat(sizeInMB) > quotaLimit * 0.8) {
              return {
                used: parseFloat(sizeInMB),
                limit: quotaLimit,
                percentage: (parseFloat(sizeInMB) / quotaLimit * 100).toFixed(1),
                warning: parseFloat(sizeInMB) > quotaLimit * 0.8
              };
            }
            
            return {
              used: parseFloat(sizeInMB),
              limit: quotaLimit,
              percentage: (parseFloat(sizeInMB) / quotaLimit * 100).toFixed(1),
              warning: false
            };
          } catch (e) {
            return null;
          }
        }

        // X·ª≠ l√Ω l·ªói QuotaExceededError
        function handleQuotaExceededError(error, context = '') {
          console.error('‚ùå QuotaExceededError:', error, 'Context:', context);
          
          // Alert user v·ªõi h∆∞·ªõng d·∫´n r√µ r√†ng
          const shouldReload = confirm(
            '‚ö†Ô∏è L·ªói: B·ªô nh·ªõ LocalStorage ƒë√£ ƒë·∫ßy!\n\n' +
            'H·ªá th·ªëng ƒë√£ chuy·ªÉn sang IndexedDB (kh√¥ng gi·ªõi h·∫°n).\n\n' +
            'üîß C√ÅCH S·ª¨A:\n' +
            '1. Click OK ƒë·ªÉ x√≥a d·ªØ li·ªáu c≈©\n' +
            '2. Sau ƒë√≥ nh·∫•n Ctrl+Shift+R (hard reload)\n' +
            '   ho·∫∑c Ctrl+F5 ƒë·ªÉ t·∫£i l·∫°i trang\n\n' +
            'D·ªØ li·ªáu quiz c·ªßa b·∫°n s·∫Ω an to√†n trong IndexedDB!'
          );
          
          if (shouldReload) {
            try {
              // Clear localStorage except critical keys
              const keysToKeep = ['admin_credentials', 'admin_authenticated', 'deleted_review_topics', 'deleted_review_topics_map'];
              const allKeys = [];
              for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key) allKeys.push(key);
              }
              
              allKeys.forEach(key => {
                if (!keysToKeep.includes(key)) {
                  try {
                    localStorage.removeItem(key);
                  } catch (e) {
                    console.error('Error removing key:', key, e);
                  }
                }
              });
              
              alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu c≈©!\n\nB√¢y gi·ªù h√£y nh·∫•n:\n‚Ä¢ Ctrl+Shift+R (Windows/Linux)\n‚Ä¢ ho·∫∑c Cmd+Shift+R (Mac)\n\nƒë·ªÉ t·∫£i l·∫°i trang v·ªõi code m·ªõi!');
            } catch (e) {
              console.error('Error clearing localStorage:', e);
              alert('‚ö†Ô∏è Kh√¥ng th·ªÉ x√≥a localStorage.\n\nVui l√≤ng th·ª≠:\n1. M·ªü DevTools (F12)\n2. Application ‚Üí Storage ‚Üí Clear site data\n3. Reload trang');
            }
          }
        }

        // Helper function to get topics from IndexedDB (primary) or localStorage (fallback)
        async function getTopicsFromStorage() {
          // Try IndexedDB first (unlimited storage)
          if (window.db) {
            try {
              // Try to get from quiz_topics store first
              const topics = await window.db.getTopics();
              if (topics && topics.length > 0) {
                return topics;
              }
              
              // Fallback to config store for backward compatibility
              const topicsStr = await window.db.getConfig('quiz_topics');
              if (topicsStr) {
                return JSON.parse(topicsStr);
              }
            } catch (e) {
              console.error('Error loading from IndexedDB:', e);
            }
          }
          
          // Fallback to localStorage (legacy, limited to 5MB)
          // This is only for backward compatibility
          try {
            const topicsStr = localStorage.getItem('quiz_topics');
            if (topicsStr) {
              console.log('‚ö†Ô∏è Loading from localStorage (legacy). Data will be migrated to IndexedDB.');
              return JSON.parse(topicsStr);
            }
          } catch (e) {
            console.error('Error loading from localStorage:', e);
          }
          
          return [];
        }
        
        // Expose function globally
        window.getTopicsFromStorage = getTopicsFromStorage;

        if (hardReloadBtn) {
          hardReloadBtn.addEventListener('click', performHardReload);
        }

        if (clearStorageBtn) {
          clearStorageBtn.addEventListener('click', clearWebStorage);
        }


        if (refreshDataBtn) {
          refreshDataBtn.addEventListener('click', async function() {
            try {
              console.log('üîÑ B·∫Øt ƒë·∫ßu t·∫£i c√¢u h·ªèi m·ªõi t·ª´ server...');
              
              // 1. Clear topics.json cache from IndexedDB
              if (window.db && window.db.ready) {
                await window.db.deleteConfig('quiz_topics');
                console.log('‚úÖ ƒê√£ x√≥a cache quiz_topics t·ª´ IndexedDB');
              }
              
              // 2. Clear legacy localStorage cache (if any)
              localStorage.removeItem('quiz_topics');
              
              // 3. Clear Service Worker cache for topics.json
              if ('caches' in window) {
                const cacheNames = await caches.keys();
                for (const cacheName of cacheNames) {
                  const cache = await caches.open(cacheName);
                  const keys = await cache.keys();
                  for (const request of keys) {
                    if (request.url.includes('topics.json')) {
                      await cache.delete(request);
                      console.log('‚úÖ ƒê√£ x√≥a cache topics.json t·ª´ Service Worker');
                    }
                  }
                }
              }
              
              // 4. Reload topics from server (without page reload)
              await loadTopics();
              
              console.log('‚úÖ ƒê√£ t·∫£i c√¢u h·ªèi m·ªõi th√†nh c√¥ng! Danh s√°ch chuy√™n ƒë·ªÅ ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.');
              
            } catch (e) {
              console.error('‚ùå L·ªói khi t·∫£i c√¢u h·ªèi m·ªõi:', e);
              alert('‚ö†Ô∏è C√≥ l·ªói khi t·∫£i c√¢u h·ªèi m·ªõi:\n\n' + (e.message || e) + '\n\nüí° Th·ª≠ "Hard Reload (Code)" n·∫øu v·∫´n l·ªói.');
            }
          });
        }


        if (globalStatsBtn) {
          globalStatsBtn.addEventListener('click', async function() {
            await showGlobalStatistics();
          });
        }


    // Test Google Sheets connection
    async function testGoogleSheetsConnection() {
      if (!window.QUIZ_CONFIG || !window.isConfigured()) {
        alert('Google Sheets ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh!');
        return;
      }

      try {
        const response = await fetch(`${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=test`, {
          method: 'GET',
          mode: 'cors'
        });
        
        const text = await response.text();
        
        if (text.includes('working')) {
          alert('‚úÖ K·∫øt n·ªëi Google Sheets th√†nh c√¥ng!\n\n' + text);
        } else {
          alert('‚ö†Ô∏è Google Sheets ph·∫£n h·ªìi nh∆∞ng c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ:\n\n' + text);
        }
      } catch (error) {
        alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Google Sheets:\n\n' + error.message + '\n\nVui l√≤ng ki·ªÉm tra:\n- URL Google Script\n- C·∫•u h√¨nh CORS\n- Quy·ªÅn truy c·∫≠p');
      }
    }

    async function showGlobalStatistics() {
      // Remove any existing global statistics modal
      const existingModal = document.querySelector('.global-statistics-modal');
      if (existingModal) {
        existingModal.remove();
        document.body.style.overflow = '';
        document.body.style.position = '';
        // Restore visibility of all elements
        const allElements = document.querySelectorAll('*');
        allElements.forEach(el => {
          el.style.visibility = '';
        });
        return;
      }
      
      // Save original body content
      const originalBodyContent = document.body.innerHTML;
      window.originalBodyContent = originalBodyContent;
      
      // Ch·ªâ l·∫•y d·ªØ li·ªáu t·ª´ Google Sheets, kh√¥ng d√πng local data
      let allStats = [];
      let allWrongAnswers = [];
      let uniqueQuestionsByTopic = {}; // Initialize here
      
      // Ki·ªÉm tra c·∫•u h√¨nh Google Sheets
      if (!window.QUIZ_CONFIG || !window.QUIZ_CONFIG.ENABLE_CLOUD_SYNC || !window.isConfigured()) {
        alert('‚ùå Ch·ª©c nƒÉng th·ªëng k√™ t·ªïng qu√°t y√™u c·∫ßu k·∫øt n·ªëi Google Sheets!\n\n' +
              'Vui l√≤ng c·∫•u h√¨nh Google Sheets trong config.js ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y.');
        return;
      }
      
      // L·∫•y d·ªØ li·ªáu t·ª´ Google Sheets
      try {
        console.log('üåê Fetching statistics from Google Sheets...');
          
        // Use JSONP to avoid CORS issues
        const timestamp = Date.now();
        const url = `${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getStatistics&_t=${timestamp}`;

        console.log('üåê Fetching statistics from URL:', url);
        const fetchResponse = await fetch(url);
        console.log('üåê Fetch response status:', fetchResponse.status);
        
        const responseText = await fetchResponse.text();
        console.log('üåê Raw response text:', responseText.substring(0, 200));
        
        const result = JSON.parse(responseText);
          
        if (result.success && result.data) {
          console.log('‚úÖ Google Sheets data loaded successfully');
            
          // Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ Google Sheets
            const googleStats = result.data.topicStats || [];
            const googleWrongAnswers = result.data.frequentWrongAnswers || [];
            
            // Also fetch wrong answers data for accurate counting
            console.log('üåê Fetching wrong answers for accurate counting...');
            const wrongAnswersUrl = `${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getWrongAnswers&_t=${timestamp}`;
            const wrongAnswersResponse = await fetch(wrongAnswersUrl);
            const wrongAnswersText = await wrongAnswersResponse.text();
            const wrongAnswersResult = JSON.parse(wrongAnswersText);
            
            if (wrongAnswersResult.success && wrongAnswersResult.data) {
              console.log('‚úÖ Wrong answers data loaded:', wrongAnswersResult.data.length);
              // Use wrong answers data instead of frequentWrongAnswers
              const allWrongAnswersFromAPI = wrongAnswersResult.data;
              
              // Debug: Check data for specific topic
              const topicData = allWrongAnswersFromAPI.filter(item => 
                item.topicName === '1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp'
              );
              console.log('üîç Raw data for "1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp":', topicData.length, 'items');
              console.log('üîç Sample data:', topicData.slice(0, 3));
            
            if (googleStats.length > 0) {
              allStats = googleStats.map(stat => ({
                topicId: stat.topicId,
                topicName: stat.topicName,
                timestamp: new Date().toISOString(),
                totalQuestions: stat.totalQuestions,
                correctAnswers: stat.totalCorrect,
                wrongAnswers: stat.totalWrong, // This is total wrong attempts from Google Sheets
                score: stat.avgScore,
                isExam: stat.isExam,
                fullname: 'Google Sheets Data',
                branch: 'Online'
              }));
              console.log('üìä Google Sheets stats loaded:', allStats.length, 'topics');
            }
            
              // Use wrong answers data from getWrongAnswers API for accurate counting
              allWrongAnswers = allWrongAnswersFromAPI.map(wrong => ({
                questionIndex: 0,
                question: wrong.question,
                options: [wrong.optionA, wrong.optionB, wrong.optionC, wrong.optionD],
                optionLabels: ['A', 'B', 'C', 'D'],
                correctAnswer: wrong.correctAnswer,
                userAnswer: 'Unknown',
                explanation: '',
                topicId: wrong.topicId || 'unknown',
                topicName: wrong.topicName,
                timestamp: new Date().toISOString()
              }));
              
            // Save to IndexedDB so "T·∫°o b√†i" button can use it
              await window.db.addWrongAnswers(allWrongAnswers);
              
              // Count unique questions per topic for statistics
              // Group by topic first, then count unique questions
              const wrongAnswersByTopicName = {};
              allWrongAnswers.forEach(answer => {
                const topicName = answer.topicName;
                if (!wrongAnswersByTopicName[topicName]) {
                  wrongAnswersByTopicName[topicName] = [];
                }
                wrongAnswersByTopicName[topicName].push(answer);
              });
              
              // Count unique questions for each topic using same logic as quiz creation modal
              for (const [topicName, answers] of Object.entries(wrongAnswersByTopicName)) {
                const uniqueQuestions = new Set();
                answers.forEach(answer => {
                  uniqueQuestions.add(answer.question);
                });
                uniqueQuestionsByTopic[topicName] = uniqueQuestions;
                console.log(`üìä Topic "${topicName}": ${answers.length} total wrong answers, ${uniqueQuestions.size} unique questions`);
              }
              
              // Also try to match topics that might have different names but same content
              // This matches the logic used in quiz creation modal
              const allTopicNames = Object.keys(wrongAnswersByTopicName);
              for (const [topicName, answers] of Object.entries(wrongAnswersByTopicName)) {
                // Try to find similar topic names (like "1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp" vs "1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp (B√†i thi...)")
                const topicNumber = topicName.match(/^(\d+)\./);
                if (topicNumber) {
                  const number = topicNumber[1];
                  const similarTopics = allTopicNames.filter(name => 
                    name.match(/^(\d+)\./) && name.match(/^(\d+)\./)[1] === number
                  );
                  
                  if (similarTopics.length > 1) {
                    // Combine all similar topics
                    const combinedQuestions = new Set();
                    similarTopics.forEach(similarTopic => {
                      const similarAnswers = wrongAnswersByTopicName[similarTopic];
                      similarAnswers.forEach(answer => {
                        combinedQuestions.add(answer.question);
                      });
                    });
                    
                    // Update the main topic with combined count
                    uniqueQuestionsByTopic[topicName] = combinedQuestions;
                    console.log(`üìä Combined similar topics for "${topicName}": ${combinedQuestions.size} unique questions`);
                  }
                }
              }
              
              console.log('üìä All wrong answers:', allWrongAnswers.length);
              console.log('üìä Unique questions per topic:', uniqueQuestionsByTopic);
            } else {
              console.warn('‚ö†Ô∏è No wrong answers data from getWrongAnswers API');
            }
        } else {
          throw new Error(result.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets');
        }
        } catch (error) {
        console.error('‚ùå Error loading Google Sheets data:', error);
        alert('‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu th·ªëng k√™ t·ª´ Google Sheets!\n\n' +
              'L·ªói: ' + error.message + '\n\n' +
              'Vui l√≤ng ki·ªÉm tra:\n' +
              '‚Ä¢ K·∫øt n·ªëi internet\n' +
              '‚Ä¢ C·∫•u h√¨nh Google Sheets\n' +
              '‚Ä¢ Google Apps Script ƒëang ho·∫°t ƒë·ªông');
        return;
      }
      
      // Filter out statistics from blacklisted (deleted) review topics
      const blacklist = (await window.db.getConfig('deleted_review_topics')) || [];
      const blacklistMap = (await window.db.getConfig('deleted_review_topics_map')) || {};
      
      // Get blacklisted topic names
      const blacklistedTopicNames = new Set(Object.values(blacklistMap));
      
      if (blacklist.length > 0 || blacklistedTopicNames.size > 0) {
        const beforeFilter = allStats.length;
        allStats = allStats.filter(stat => {
          // Filter by topicId
          if (blacklist.includes(stat.topicId)) {
            return false;
          }
          // Filter by topicName (for review topics from Google Sheets)
          if (stat.topicName && blacklistedTopicNames.has(stat.topicName)) {
            return false;
          }
          return true;
        });
        
        // Also filter wrong answers
        const beforeWrongFilter = allWrongAnswers.length;
        allWrongAnswers = allWrongAnswers.filter(answer => {
          if (blacklist.includes(answer.topicId)) return false;
          if (answer.topicName && blacklistedTopicNames.has(answer.topicName)) return false;
          return true;
        });
      }
      
      if (allStats.length === 0) {
        alert('‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ t·ª´ Google Sheets!\n\n' +
              'C√≥ th·ªÉ:\n' +
              '‚Ä¢ Ch∆∞a c√≥ ai l√†m b√†i quiz\n' +
              '‚Ä¢ Google Sheets ch∆∞a c√≥ d·ªØ li·ªáu\n' +
              '‚Ä¢ C·∫ßn th·ªùi gian ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu\n\n' +
              'Vui l√≤ng th·ª≠ l·∫°i sau khi c√≥ d·ªØ li·ªáu t·ª´ Google Sheets.');
        return;
      }
      
      // Calculate overall statistics
      const totalAttempts = allStats.length;
      const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...allStats.map(s => s.score));
      const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
      const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Group by topic - Use unique questions count instead of total wrong attempts
      const topicStats = {};
      allStats.forEach(stat => {
        if (!topicStats[stat.topicId]) {
          topicStats[stat.topicId] = {
            topicId: stat.topicId,
            name: stat.topicName,
            attempts: 0,
            totalScore: 0,
            bestScore: 0,
            totalQuestions: 0,
            totalCorrect: 0,
            totalWrong: 0, // Will be updated with unique questions count
            isExam: stat.isExam
          };
        }
        topicStats[stat.topicId].attempts++;
        topicStats[stat.topicId].totalScore += stat.score;
        topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
        topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
        topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
        
        if (stat.topicName === '4. X·ª≠ l√Ω n·ª£') {
          console.log(`üìä Google Sheets data for "4. X·ª≠ l√Ω n·ª£": wrongAnswers = ${stat.wrongAnswers}`);
        }
      });
      
      // Update totalWrong with unique questions count
      console.log('üìä uniqueQuestionsByTopic:', uniqueQuestionsByTopic);
      console.log('üìä Object.keys(uniqueQuestionsByTopic):', Object.keys(uniqueQuestionsByTopic));
      
      for (const topicId in topicStats) {
        const topic = topicStats[topicId];
        console.log(`üìä Processing topic: "${topic.name}"`);
        
        // Try exact match first
        let uniqueCount = 0;
        if (uniqueQuestionsByTopic[topic.name]) {
          uniqueCount = uniqueQuestionsByTopic[topic.name].size;
          console.log(`üìä Exact match found: ${uniqueCount} unique questions`);
        } else {
          // Try partial match
          const matchingKeys = Object.keys(uniqueQuestionsByTopic).filter(key => 
            key.includes(topic.name) || topic.name.includes(key)
          );
          console.log(`üìä No exact match. Matching keys for "${topic.name}":`, matchingKeys);
          
          if (matchingKeys.length > 0) {
            // Use the first matching key
            const matchingKey = matchingKeys[0];
            uniqueCount = uniqueQuestionsByTopic[matchingKey].size;
            console.log(`üìä Using matching key "${matchingKey}": ${uniqueCount} unique questions`);
          }
        }
        
        topicStats[topicId].totalWrong = uniqueCount;
        console.log(`üìä Final result for "${topic.name}": ${uniqueCount} unique wrong questions`);
      }
      
      // Group wrong answers by topic (by topicId AND topicName) BEFORE calculating averages
      const wrongAnswersByTopic = {};
      const wrongAnswersByTopicName = {};
      
      
      allWrongAnswers.forEach(answer => {
        // Group by topicId
        if (!wrongAnswersByTopic[answer.topicId]) {
          wrongAnswersByTopic[answer.topicId] = [];
        }
        wrongAnswersByTopic[answer.topicId].push(answer);
        
        // Also group by topicName for fallback
        const topicName = answer.topicName || 'Unknown';
        if (!wrongAnswersByTopicName[topicName]) {
          wrongAnswersByTopicName[topicName] = [];
        }
        wrongAnswersByTopicName[topicName].push(answer);
      });
      
      
      // Debug: Show detailed count for each topic name
      for (const [topicName, answers] of Object.entries(wrongAnswersByTopicName)) {
        // Show actual questions for "4. X·ª≠ l√Ω n·ª£" to compare with Google Sheets
        if (topicName === '4. X·ª≠ l√Ω n·ª£') {
          answers.forEach((ans, idx) => {
          });
        }
      }
      
      // Use Google Sheets data directly - no need to recalculate
      console.log('üìä Using Google Sheets data directly for all statistics');
      
      // Calculate averages for each topic AFTER updating totalWrong
      Object.values(topicStats).forEach(topic => {
        topic.avgScore = Math.round(topic.totalScore / topic.attempts);
      });
      
      // Sort topics by average score (descending) AFTER all calculations
      // Note: blacklist filtering already done at the top, so topicStats only contains valid topics
      // Filter out topics with no wrong answers
      const sortedTopics = Object.values(topicStats)
        .filter(topic => topic.totalWrong > 0) // Only show topics with wrong answers
        .sort((a, b) => b.avgScore - a.avgScore);
      
      // Debug: Log final sorted topics with their totalWrong values
      sortedTopics.forEach(topic => {
      });
      
      // Double check the specific topic causing issues
      const problematicTopic = sortedTopics.find(t => t.name === '4. X·ª≠ l√Ω n·ª£');
      if (problematicTopic) {
      }
      
      // Replace entire body content with full-screen statistics page
      document.body.innerHTML = `
        <div style="
          background: white !important;
          width: 100% !important;
          height: 100vh !important;
          padding: 0 !important;
          margin: 0 !important;
          position: relative !important;
          z-index: 100000 !important;
          display: flex !important;
          flex-direction: column !important;
          border: none !important;
          box-shadow: none !important;
        ">
          <!-- Header -->
          <div style="
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 10px 15px !important;
            border-bottom: 1px solid #e0e0e0 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            flex-shrink: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
          ">
            <h2 style="color: #800020; margin: 0; font-size: 16px; font-weight: 600; line-height: 1.2; display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 18px;">üìä</span>
              <span>Th·ªëng k√™ t·ªïng qu√°t</span>
            </h2>
          </div>
          
          <!-- Main Content Container -->
          <div style="
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 20px !important;
            width: 100% !important;
            box-sizing: border-box !important;
          ">
          
          <!-- Overall Statistics Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #1976d2; margin-bottom: 8px;">${totalAttempts}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">T·ªïng s·ªë l·∫ßn l√†m b√†i</div>
            </div>
            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #2e7d32; margin-bottom: 8px;">${avgScore}%</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">ƒêi·ªÉm trung b√¨nh</div>
            </div>
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #f57c00; margin-bottom: 8px;">${bestScore}%</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">ƒêi·ªÉm cao nh·∫•t</div>
            </div>
            <div style="background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #7b1fa2; margin-bottom: 8px;">${sortedTopics.length}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">Chuy√™n ƒë·ªÅ ƒë√£ l√†m</div>
            </div>
            <div style="background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #00695c; margin-bottom: 8px;">${totalCorrect}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">C√¢u tr·∫£ l·ªùi ƒë√∫ng</div>
            </div>
            <div style="background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); padding: 24px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div style="font-size: 36px; font-weight: bold; color: #c62828; margin-bottom: 8px;">${totalWrong}</div>
              <div style="color: #666; font-size: 16px; font-weight: 500;">C√¢u tr·∫£ l·ªùi sai</div>
            </div>
          </div>
          
          <!-- Online Leaderboard -->
          <div class="online-leaderboard-section" style="margin-bottom: 30px;">
            <h3 style="color: #800020; margin-bottom: 20px; font-size: 24px; text-align: center;">üèÜ B·∫£ng x·∫øp h·∫°ng Online</h3>
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <div id="online-leaderboard" style="padding: 20px; min-height: 300px;">
                <div style="text-align: center; padding: 40px; color: #666;">
                  <div style="font-size: 48px; margin-bottom: 16px;">üåê</div>
                  <h4 style="color: #800020; margin-bottom: 8px;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ trang web...</h4>
                  <p>K·∫øt n·ªëi v·ªõi <a href="https://tvnghp.github.io/Tracnghiem/" target="_blank" style="color: #1976d2;">tvnghp.github.io/Tracnghiem</a></p>
                  <button onclick="loadOnlineLeaderboard()" style="
                    background: #1976d2;
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 16px;
                    margin-top: 16px;
                    min-height: 48px;
                    width: 100%;
                    max-width: 200px;
                  ">
                    üîÑ T·∫£i l·∫°i
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Topic Statistics -->
          <div style="margin-bottom: 40px;">
            <h3 style="color: #800020; margin-bottom: 20px; font-size: 22px;">üìà Th·ªëng k√™ theo chuy√™n ƒë·ªÅ</h3>
            <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
              <!-- Desktop Table View -->
              <div class="desktop-table" style="display: block;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                  <thead style="background: #f5f5f5;">
                    <tr>
                      <th style="padding: 16px; text-align: left; font-weight: 600; color: #333;">Chuy√™n ƒë·ªÅ</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Lo·∫°i</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">L·∫ßn l√†m</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">ƒêi·ªÉm TB</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Cao nh·∫•t</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">C√¢u sai</th>
                      <th style="padding: 16px; text-align: center; font-weight: 600; color: #333;">Thao t√°c</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${sortedTopics.map((topic, index) => `
                      <tr style="border-bottom: 1px solid #f0f0f0; ${topic.name.includes('√în t·∫≠p c√¢u sai') ? 'background: #fff3e0;' : ''}">
                        <td style="padding: 16px; color: #333; font-weight: 600;">
                          ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">√îN T·∫¨P</span>
                              <span style="color: #f57c00;">${topic.name}</span>
                            </div>
                          ` : topic.name}
                        </td>
                        <td style="padding: 16px; text-align: center;">
                          <span style="background: ${topic.isExam ? '#ff9800' : topic.name.includes('√în t·∫≠p c√¢u sai') ? '#ff9800' : '#4caf50'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${topic.isExam ? 'EXAM' : topic.name.includes('√în t·∫≠p c√¢u sai') ? 'REVIEW' : 'TOPIC'}
                          </span>
                        </td>
                        <td style="padding: 16px; text-align: center; color: #666;">${topic.attempts}</td>
                        <td style="padding: 16px; text-align: center; color: ${topic.avgScore >= 80 ? '#2e7d32' : topic.avgScore >= 60 ? '#f57c00' : '#c62828'}; font-weight: bold; font-size: 18px;">${topic.avgScore}%</td>
                        <td style="padding: 16px; text-align: center; color: #666;">${topic.bestScore}%</td>
                        <td style="padding: 16px; text-align: center; color: #c62828; font-weight: 600;" title="S·ªë c√¢u h·ªèi duy nh·∫•t b·ªã sai">${topic.totalWrong}</td>
                        <td style="padding: 12px; text-align: center;">
                          <div style="display: flex; gap: 6px; justify-content: center; flex-direction: column;">
                            <button onclick="exportTopicStatisticsExcel('${topic.topicId}')" style="background: #1976d2; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1976d2'" title="Xu·∫•t Excel">
                              <i class="material-icons" style="font-size: 14px;">download</i> Excel
                            </button>
                            <button onclick="event.stopPropagation(); createQuizFromWrongAnswers('${topic.topicId}', '${topic.name}')" style="background: #4caf50; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#45a049'" onmouseout="this.style.background='#4caf50'" title="T·∫°o b√†i thi t·ª´ c√¢u sai">
                              <i class="material-icons" style="font-size: 14px;">quiz</i> T·∫°o b√†i
                            </button>
                            ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                            <button onclick="deleteReviewTopic('${topic.topicId}', '${topic.name}')" style="background: #f44336; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; transition: all 0.2s; white-space: nowrap;" onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'" title="X√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p">
                              <i class="material-icons" style="font-size: 14px;">delete</i> X√≥a
                            </button>
                            ` : ''}
                          </div>
                        </td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              
              <!-- Mobile Card View -->
              <div class="mobile-cards" style="display: none;">
                ${sortedTopics.map((topic, index) => `
                  <div style="padding: 20px; border-bottom: 1px solid #f0f0f0; ${topic.name.includes('√în t·∫≠p c√¢u sai') ? 'background: #fff3e0;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                      <div style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: #333; font-size: 16px; font-weight: 600; line-height: 1.3;">
                          ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                              <span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600;">√îN T·∫¨P</span>
                              <span style="color: #f57c00;">${topic.name}</span>
                            </div>
                          ` : topic.name}
                        </h4>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                          <span style="background: ${topic.isExam ? '#ff9800' : topic.name.includes('√în t·∫≠p c√¢u sai') ? '#ff9800' : '#4caf50'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                            ${topic.isExam ? 'EXAM' : topic.name.includes('√în t·∫≠p c√¢u sai') ? 'REVIEW' : 'TOPIC'}
                          </span>
                        </div>
                      </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                      <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;">L·∫ßn l√†m</div>
                        <div style="font-size: 18px; font-weight: 600; color: #333;">${topic.attempts}</div>
                      </div>
                      <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;">ƒêi·ªÉm TB</div>
                        <div style="font-size: 18px; font-weight: 600; color: ${topic.avgScore >= 80 ? '#2e7d32' : topic.avgScore >= 60 ? '#f57c00' : '#c62828'};">${topic.avgScore}%</div>
                      </div>
                      <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;">Cao nh·∫•t</div>
                        <div style="font-size: 18px; font-weight: 600; color: #333;">${topic.bestScore}%</div>
                      </div>
                      <div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 4px;" title="S·ªë c√¢u h·ªèi duy nh·∫•t b·ªã sai">C√¢u sai</div>
                        <div style="font-size: 18px; font-weight: 600; color: #c62828;">${topic.totalWrong}</div>
                      </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                      <button onclick="exportTopicStatisticsExcel('${topic.topicId}')" style="background: #1976d2; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; flex: 1; min-width: 120px; justify-content: center;" title="Xu·∫•t Excel">
                        <i class="material-icons" style="font-size: 16px;">download</i> Excel
                      </button>
                      <button onclick="event.stopPropagation(); createQuizFromWrongAnswers('${topic.topicId}', '${topic.name}')" style="background: #4caf50; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; flex: 1; min-width: 120px; justify-content: center;" title="T·∫°o b√†i thi t·ª´ c√¢u sai">
                        <i class="material-icons" style="font-size: 16px;">quiz</i> T·∫°o b√†i
                      </button>
                      <button onclick="debugWrongAnswersSystem()" style="background: #ff9800; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; flex: 1; min-width: 120px; justify-content: center;" title="Debug h·ªá th·ªëng c√¢u sai">
                        <i class="material-icons" style="font-size: 16px;">bug_report</i> Debug
                      </button>
                      ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                      <button onclick="deleteReviewTopic('${topic.topicId}', '${topic.name}')" style="background: #f44336; color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; flex: 1; min-width: 120px; justify-content: center;" title="X√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p">
                        <i class="material-icons" style="font-size: 16px;">delete</i> X√≥a
                      </button>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          
          </div> <!-- End Main Content Container -->
          
          <!-- Action Buttons - Fixed at Bottom -->
          <div style="
            padding: 12px 16px !important;
            border-top: 1px solid #e0e0e0 !important;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
            flex-shrink: 0 !important;
            width: 100% !important;
            box-sizing: border-box !important;
            text-align: center;
          ">
            <button onclick="
              // Restore original body content
              if (window.originalBodyContent) {
                document.body.innerHTML = window.originalBodyContent;
                // Re-initialize event listeners
                document.addEventListener('DOMContentLoaded', function() {
                  // Re-initialize all event listeners here
                });
              }
            " class="btn btn-outline" style="display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 10px 24px; font-size: 0.9rem; font-weight: 600; min-height: 44px;">
              <i class="material-icons" style="font-size: 18px;">close</i> ƒê√≥ng
            </button>
          </div>
        </div>
      `;
      
      // Load online leaderboard after content is replaced
      setTimeout(() => {
        loadOnlineLeaderboard();
        // Initialize responsive view
        initializeResponsiveView();
      }, 100);
    }
    
    // ‚úÖ Expose showGlobalStatistics to window immediately after definition
    window.showGlobalStatistics = showGlobalStatistics;

    // Function to load online leaderboard data from Google Sheets
    async function loadOnlineLeaderboard() {
      const leaderboardContainer = document.getElementById('online-leaderboard');
      if (!leaderboardContainer) return;
      
      // Show the online leaderboard section first (in case it was hidden)
      const onlineLeaderboardSection = leaderboardContainer.closest('.online-leaderboard-section');
      if (onlineLeaderboardSection) {
        onlineLeaderboardSection.style.display = 'block';
      }
      
      // Show loading state
      leaderboardContainer.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #666;">
          <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
          <h4 style="color: #800020; margin-bottom: 8px;">ƒêang t·∫£i d·ªØ li·ªáu...</h4>
          <p>K·∫øt n·ªëi v·ªõi Google Sheets ƒë·ªÉ l·∫•y b·∫£ng x·∫øp h·∫°ng</p>
        </div>
      `;
      
      try {
        // Check if Google Sheets is configured
        if (!window.QUIZ_CONFIG || !window.isConfigured()) {
          throw new Error('Google Sheets ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh');
        }
        
        // Fetch data from Google Sheets
        const response = await fetch(`${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getLeaderboard`);
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('‚ùå Google Sheets returned non-JSON for leaderboard:', text);
          throw new Error('Google Sheets tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng JSON');
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.message || 'Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu');
        }
        
        const data = result.data;
        
        // Display the leaderboard
        displayOnlineLeaderboard(data, leaderboardContainer);
        
      } catch (error) {
        console.error('‚ùå Error loading online leaderboard:', error);
        
        // Hide the entire online leaderboard section if can't connect
        const onlineLeaderboardSection = leaderboardContainer.closest('.online-leaderboard-section');
        if (onlineLeaderboardSection) {
          onlineLeaderboardSection.style.display = 'none';
        }
      }
    }
    
    // Display the online leaderboard data
    function displayOnlineLeaderboard(data, container) {
      const { leaderboard, totalAttempts, avgScore, bestScore, lastUpdate } = data;
      
      if (!leaderboard || leaderboard.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
            <h4 style="color: #800020; margin-bottom: 8px;">Ch∆∞a c√≥ d·ªØ li·ªáu</h4>
            <p>Ch∆∞a c√≥ ai l√†m b√†i tr√™n h·ªá th·ªëng online</p>
            <button onclick="loadOnlineLeaderboard()" style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
              margin-top: 16px;
              min-height: 48px;
              width: 100%;
              max-width: 200px;
            ">
              üîÑ T·∫£i l·∫°i
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div style="padding: 20px;">
          <!-- Summary Stats -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
            <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #1976d2;">${totalAttempts}</div>
              <div style="color: #666; font-size: 14px;">T·ªïng l·∫ßn l√†m b√†i</div>
            </div>
            <div style="background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2e7d32;">${avgScore}%</div>
              <div style="color: #666; font-size: 14px;">ƒêi·ªÉm trung b√¨nh</div>
            </div>
            <div style="background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 16px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #f57c00;">${bestScore}%</div>
              <div style="color: #666; font-size: 14px;">ƒêi·ªÉm cao nh·∫•t</div>
            </div>
          </div>
          
          <!-- Top Users Leaderboard -->
          <h4 style="color: #800020; margin-bottom: 16px; font-size: 18px;">üèÜ B·∫£ng x·∫øp h·∫°ng ng∆∞·ªùi d√πng</h4>
          
          <!-- Desktop Table View -->
          <div class="desktop-leaderboard" style="display: block;">
            <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                <thead style="background: #f5f5f5;">
                  <tr>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">H·∫°ng</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">H·ªç t√™n</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">ƒê∆°n v·ªã</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Chuy√™n ƒë·ªÅ</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">ƒêi·ªÉm</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">K·∫øt qu·∫£</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">Th·ªùi gian</th>
                  </tr>
                </thead>
                <tbody>
                  ${leaderboard.slice(0, 10).map((user, index) => `
                    <tr style="border-bottom: 1px solid #e0e0e0; ${index < 3 ? 'background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);' : ''}">
                      <td style="padding: 12px; text-align: center; font-weight: 600;">
                        ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${user.rank}`}
                      </td>
                      <td style="padding: 12px; font-weight: 600; color: #333;">${user.fullname}</td>
                      <td style="padding: 12px; color: #666; font-size: 14px;">${user.branch}</td>
                      <td style="padding: 12px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                          <span style="color: #333;">${user.topicName}</span>
                          ${user.isExam ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">THI</span>' : ''}
                        </div>
                      </td>
                      <td style="padding: 12px; text-align: center; font-weight: 600; color: #2e7d32; font-size: 18px;">${user.score}%</td>
                      <td style="padding: 12px; text-align: center; color: #666; font-size: 14px;">${user.correctAnswers}/${user.totalQuestions}</td>
                      <td style="padding: 12px; text-align: center; color: #666; font-size: 12px;">${new Date(user.timestamp).toLocaleDateString('vi-VN')}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Mobile Card View -->
          <div class="mobile-leaderboard" style="display: none;">
            ${leaderboard.slice(0, 10).map((user, index) => `
              <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${index < 3 ? 'border: 2px solid #ffc107; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="font-size: 24px; font-weight: 600;">
                      ${index < 3 ? ['ü•á', 'ü•à', 'ü•â'][index] : `#${user.rank}`}
                    </div>
                    <div>
                      <div style="font-weight: 600; color: #333; font-size: 16px;">${user.fullname}</div>
                      <div style="color: #666; font-size: 14px;">${user.branch}</div>
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div style="font-size: 20px; font-weight: 600; color: #2e7d32;">${user.score}%</div>
                    <div style="color: #666; font-size: 12px;">${user.correctAnswers}/${user.totalQuestions}</div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="color: #333; font-size: 14px;">${user.topicName}</span>
                    ${user.isExam ? '<span style="background: #ff9800; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">THI</span>' : ''}
                  </div>
                  <div style="color: #666; font-size: 12px;">${new Date(user.timestamp).toLocaleDateString('vi-VN')}</div>
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- Footer -->
          <div style="text-align: center; margin-top: 24px; padding-top: 16px; border-top: 1px solid #e0e0e0; color: #666; font-size: 12px;">
            <p>C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date(lastUpdate).toLocaleString('vi-VN')}</p>
            <button onclick="loadOnlineLeaderboard()" style="
              background: #4caf50;
              color: white;
              border: none;
              padding: 8px 16px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 12px;
              margin-top: 8px;
              min-height: 48px;
              width: 100%;
              max-width: 200px;
            ">
              üîÑ C·∫≠p nh·∫≠t
            </button>
          </div>
        </div>
      `;
      
      // Initialize responsive view for leaderboard
      initializeResponsiveView();
    }
    
    // Initialize responsive view
    function initializeResponsiveView() {
      function updateView() {
        const isMobile = window.innerWidth <= 768;
        const desktopTables = document.querySelectorAll('.desktop-table');
        const mobileCards = document.querySelectorAll('.mobile-cards');
        const desktopLeaderboard = document.querySelectorAll('.desktop-leaderboard');
        const mobileLeaderboard = document.querySelectorAll('.mobile-leaderboard');
        
        // Update topic statistics view
        desktopTables.forEach(el => {
          el.style.display = isMobile ? 'none' : 'block';
        });
        mobileCards.forEach(el => {
          el.style.display = isMobile ? 'block' : 'none';
        });
        
        // Update leaderboard view
        desktopLeaderboard.forEach(el => {
          el.style.display = isMobile ? 'none' : 'block';
        });
        mobileLeaderboard.forEach(el => {
          el.style.display = isMobile ? 'block' : 'none';
        });
      }
      
      // Initial update
      updateView();
      
      // Update on resize
      window.addEventListener('resize', updateView);
    }
    
    // ‚úÖ Expose functions to window for onclick handlers
    window.loadOnlineLeaderboard = loadOnlineLeaderboard;
    window.displayOnlineLeaderboard = displayOnlineLeaderboard;
    window.initializeResponsiveView = initializeResponsiveView;

        async function renderLists(all) {
          // Filter out deleted review topics
          const blacklist = (await window.db.getConfig('deleted_review_topics')) || [];
          const filtered = all.filter(t => !blacklist.includes(t.id));
          
          const exams = filtered.filter(t => t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0)));
          const topics = filtered.filter(t => !(t && (t.isExam === true || (typeof t.durationMinutes === 'number' && t.durationMinutes > 0))));

          // Sort topics by name (extract number prefix for proper ordering)
          const sortTopics = (items) => {
            const getNumber = (name) => {
              const match = name && name.match(/^(\d+)\./);
              return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
            };
            return items.sort((a, b) => {
              const numA = getNumber(a?.name || '');
              const numB = getNumber(b?.name || '');
              if (numA !== numB) return numA - numB;
              return (a?.name || '').localeCompare(b?.name || '', 'vi');
            });
          };

          // Dedicated sort for exams: number prefix, then exam type priority, then name
          const sortExams = (items) => {
            const getNumber = (name) => {
              const match = name && name.match(/^(\d+)\./);
              return match ? parseInt(match[1], 10) : Number.POSITIVE_INFINITY;
            };
            const getExamPriority = (name) => {
              const n = (name || '').toLowerCase();
              // ∆∞u ti√™n ch·ª©c danh ch·ª©c v·ª• tr∆∞·ªõc, sau ƒë√≥ lao ƒë·ªông CMNV, c√≤n l·∫°i cu·ªëi
              if (n.includes('ch·ª©c danh ch·ª©c v·ª•')) return 0;
              if (n.includes('lao ƒë·ªông chuy√™n m√¥n nghi·ªáp v·ª•')) return 1;
              return 2;
            };
            return items.sort((a, b) => {
              const numA = getNumber(a?.name || '');
              const numB = getNumber(b?.name || '');
              if (numA !== numB) return numA - numB;
              const prA = getExamPriority(a?.name);
              const prB = getExamPriority(b?.name);
              if (prA !== prB) return prA - prB;
              return (a?.name || '').localeCompare(b?.name || '', 'vi');
            });
          };

          // Sort both topics and exams
          const sortedTopics = sortTopics([...topics]);
          const sortedExams = sortExams([...exams]);

          // Populate topic dropdown
          if (sortedTopics.length > 0) {
            topicSelect.innerHTML = '<option value="">-- Ch·ªçn chuy√™n ƒë·ªÅ --</option>' + 
              sortedTopics.map(topic => `<option value="${topic.id}">${topic.name} (${topic.questions ? topic.questions.length : 0} c√¢u)</option>`).join('');
          } else {
            topicSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ chuy√™n ƒë·ªÅ --</option>';
          }

          // Populate exam dropdown
          if (sortedExams.length > 0) {
            examSelect.innerHTML = '<option value="">-- Ch·ªçn b√†i thi --</option>' + 
              sortedExams.map(exam => {
                const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
                const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A';
                return `<option value="${exam.id}">${exam.name} (${total} c√¢u, ${duration})</option>`;
              }).join('');
          } else {
            examSelect.innerHTML = '<option value="">-- Ch∆∞a c√≥ b√†i thi --</option>';
          }

          // Populate topic grid
          const topicsContainer = document.getElementById('topics-container');
          if (topicsContainer) {
            topicsContainer.innerHTML = sortedTopics.length ? sortedTopics.map(topic => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${topic.name}</h3>
                  <p>${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="quiz.html?topic=${encodeURIComponent(topic.id)}" class="btn" style="flex: 1;">
                      <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                    </a>
                    <button onclick="exportTopicToExcel('${topic.id}')" class="btn btn-outline" style="flex: 1;" title="Xu·∫•t c√¢u h·ªèi ra Excel">
                      <i class="material-icons">download</i> Excel
                    </button>
                    ${topic.name.includes('√în t·∫≠p c√¢u sai') ? `
                    <button onclick="deleteReviewTopic('${topic.id}', '${topic.name}')" class="btn btn-outline" style="flex: 1; color: #f44336; border-color: #f44336;" title="X√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p">
                      <i class="material-icons">delete</i> X√≥a √¥n t·∫≠p
                    </button>
                    ` : ''}
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">folder_open</i>
                <p>Ch∆∞a c√≥ chuy√™n ƒë·ªÅ n√†o</p>
              </div>`;
          }

          // Populate exam grid
          const examsContainer = document.getElementById('exams-container');
          if (examsContainer) {
            examsContainer.innerHTML = sortedExams.length ? sortedExams.map(exam => `
              <div class="topic-card">
                <div class="topic-card-content">
                  <h3>${exam.name}</h3>
                  <p>${exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0)} c√¢u ‚Ä¢ ${exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'N/A'}</p>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <a href="quiz.html?topic=${encodeURIComponent(exam.id)}" class="btn" style="flex: 1;">
                      <i class="material-icons">play_arrow</i> B·∫Øt ƒë·∫ßu
                    </a>
                    <button onclick="exportTopicToExcel('${exam.id}')" class="btn btn-outline" style="flex: 1;" title="Xu·∫•t c√¢u h·ªèi ra Excel">
                      <i class="material-icons">download</i> Excel
                    </button>
                    ${exam.name.includes('√în t·∫≠p c√¢u sai') ? `
                    <button onclick="deleteReviewTopic('${exam.id}', '${exam.name}')" class="btn btn-outline" style="flex: 1; color: #f44336; border-color: #f44336;" title="X√≥a b√†i thi √¥n t·∫≠p">
                      <i class="material-icons">delete</i> X√≥a √¥n t·∫≠p
                    </button>
                    ` : ''}
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="empty-state">
                <i class="material-icons">assignment</i>
                <p>Ch∆∞a c√≥ b√†i thi n√†o</p>
              </div>`;
          }

          // Store data for later use
          window.allTopics = sortedTopics;
          window.allExams = sortedExams;
        }

        // View toggle functions
        function toggleTopicView() {
          const dropdownView = document.getElementById('topic-dropdown-view');
          const gridView = document.getElementById('topic-grid-view');
          const toggleBtn = document.getElementById('topic-view-toggle');
          const currentView = localStorage.getItem('index_topic_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_topic_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_topic_view', 'dropdown');
          }
        }

        function toggleExamView() {
          const dropdownView = document.getElementById('exam-dropdown-view');
          const gridView = document.getElementById('exam-grid-view');
          const toggleBtn = document.getElementById('exam-view-toggle');
          const currentView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          if (currentView === 'dropdown') {
            dropdownView.style.display = 'none';
            gridView.style.display = 'block';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
            localStorage.setItem('index_exam_view', 'grid');
          } else {
            dropdownView.style.display = 'block';
            gridView.style.display = 'none';
            toggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
            localStorage.setItem('index_exam_view', 'dropdown');
          }
        }

        function initializeViews() {
          const topicView = localStorage.getItem('index_topic_view') || 'dropdown';
          const examView = localStorage.getItem('index_exam_view') || 'dropdown';
          
          const topicDropdown = document.getElementById('topic-dropdown-view');
          const topicGrid = document.getElementById('topic-grid-view');
          const topicToggleBtn = document.getElementById('topic-view-toggle');
          
          if (topicView === 'grid') {
            topicDropdown.style.display = 'none';
            topicGrid.style.display = 'block';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            topicDropdown.style.display = 'block';
            topicGrid.style.display = 'none';
            topicToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
          
          const examDropdown = document.getElementById('exam-dropdown-view');
          const examGrid = document.getElementById('exam-grid-view');
          const examToggleBtn = document.getElementById('exam-view-toggle');
          
          if (examView === 'grid') {
            examDropdown.style.display = 'none';
            examGrid.style.display = 'block';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">list</i> Ch·∫ø ƒë·ªô dropdown';
          } else {
            examDropdown.style.display = 'block';
            examGrid.style.display = 'none';
            examToggleBtn.innerHTML = '<i class="material-icons" style="font-size: 1.2rem;">view_module</i> Ch·∫ø ƒë·ªô l∆∞·ªõi';
          }
        }

        // Initialize views on load
        initializeViews();

        // View toggle event listeners with touch optimization
        document.getElementById('topic-view-toggle').addEventListener('click', toggleTopicView);
        document.getElementById('exam-view-toggle').addEventListener('click', toggleExamView);

        // Add touch optimization for mobile
        if ('ontouchstart' in window) {
          document.body.classList.add('touch-device');
          
          // Optimize button interactions for touch
          document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('touchstart', function() {
              this.style.transform = 'scale(0.95)';
            });
            
            btn.addEventListener('touchend', function() {
              this.style.transform = '';
            });
          });

          // Optimize answer interactions for touch
          document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.answer').forEach(answer => {
              answer.addEventListener('touchstart', function() {
                this.style.transform = 'scale(0.98)';
              });
              
              answer.addEventListener('touchend', function() {
                this.style.transform = '';
              });
            });
          });
        }

        // Topic selector change handler
        topicSelect.addEventListener('change', function(e) {
          const topicId = e.target.value;
          if (!topicId) {
            topicInfo.style.display = 'none';
            return;
          }
          
          const topic = window.allTopics.find(t => t.id === topicId);
          if (topic) {
            topicDescription.textContent = `${topic.questions ? topic.questions.length : 0} c√¢u h·ªèi ‚Ä¢ Kh√¥ng gi·ªõi h·∫°n th·ªùi gian`;
            topicStartBtn.href = `quiz.html?topic=${encodeURIComponent(topic.id)}`;
            topicInfo.style.display = 'block';
          }
        });

        // Exam selector change handler
        examSelect.addEventListener('change', function(e) {
          const examId = e.target.value;
          if (!examId) {
            examInfo.style.display = 'none';
            return;
          }
          
          const exam = window.allExams.find(t => t.id === examId);
          if (exam) {
            const total = exam.examConfig?.total ?? (exam.questions ? exam.questions.length : 0);
            const duration = exam.durationMinutes ? (exam.durationMinutes + ' ph√∫t') : 'Kh√¥ng r√µ th·ªùi gian';
            const pauseText = exam.allowPause ? ' ‚Ä¢ Cho ph√©p t·∫°m d·ª´ng' : '';
            examDescription.textContent = `${total} c√¢u h·ªèi ‚Ä¢ ${duration}${pauseText}`;
            examStartBtn.href = `quiz.html?topic=${encodeURIComponent(exam.id)}`;
            examInfo.style.display = 'block';
          }
        });

        async function loadTopics() {
          showLoadingState();
          
          // Check if localStorage is causing issues
          try {
            const testKey = 'storage_test';
            localStorage.setItem(testKey, 'test');
            localStorage.removeItem(testKey);
          } catch (quotaError) {
            // localStorage is full, offer to clear it
            if (quotaError.name === 'QuotaExceededError') {
              const shouldClear = confirm(
                '‚ö†Ô∏è B·ªô nh·ªõ LocalStorage ƒë√£ ƒë·∫ßy!\n\n' +
                'H·ªá th·ªëng ƒë√£ chuy·ªÉn sang IndexedDB (kh√¥ng gi·ªõi h·∫°n dung l∆∞·ª£ng).\n\n' +
                'B·∫°n c√≥ mu·ªën x√≥a d·ªØ li·ªáu c≈© trong LocalStorage kh√¥ng?\n' +
                '(D·ªØ li·ªáu quiz c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c gi·ªØ nguy√™n trong IndexedDB)'
              );
              
              if (shouldClear) {
                try {
                  // Clear localStorage except critical keys
                  const keysToKeep = ['admin_credentials', 'admin_authenticated', 'deleted_review_topics', 'deleted_review_topics_map'];
                  for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && !keysToKeep.includes(key)) {
                      localStorage.removeItem(key);
                    }
                  }
                  alert('‚úÖ ƒê√£ x√≥a d·ªØ li·ªáu c≈© th√†nh c√¥ng!\n\nVui l√≤ng F5 ƒë·ªÉ t·∫£i l·∫°i trang.');
                  return;
                } catch (e) {
                  console.error('Error clearing localStorage:', e);
                }
              }
            }
          }
          
          // Wait for IndexedDB to be ready
          if (window.db && window.db.ready) {
            try {
              await window.db.ready;
            } catch (e) {
              console.error('Error waiting for IndexedDB:', e);
            }
          }
          
          // Try to load from IndexedDB first
          try {
            if (window.db) {
              // Try to get from quiz_topics store first
              const localTopics = await window.db.getTopics();
              if (localTopics && localTopics.length > 0) {
                hideLoadingState();
                await renderLists(localTopics);
                return;
              }
              
              // Fallback to config store for backward compatibility
              const localTopicsStr = await window.db.getConfig('quiz_topics');
              if (localTopicsStr) {
                const localTopics = JSON.parse(localTopicsStr);
                if (Array.isArray(localTopics) && localTopics.length > 0) {
                  hideLoadingState();
                  await renderLists(localTopics);
                  return;
                }
              }
            }
          } catch (e) {
            console.error('Error loading from IndexedDB:', e);
          }
          
          // Try to load from remote with multiple fallback strategies
          const urls = [
            './topics.json',
            'topics.json',
            window.location.origin + '/topics.json',
            window.location.href.replace(/\/[^\/]*$/, '/topics.json')
          ];
          
          for (const urlString of urls) {
            try {
              const url = new URL(urlString, location.href);
              url.searchParams.set('v', Date.now());
              
              const resp = await fetch(url, { 
                cache: 'no-store',
                headers: {
                  'Accept': 'application/json'
                }
              });
              
              
              if (resp.ok) {
                const remoteTopics = await resp.json();
                
                if (Array.isArray(remoteTopics) && remoteTopics.length > 0) {
                  // Validate topic structure
                  const validTopics = remoteTopics.filter(topic => 
                    topic && 
                    typeof topic.id === 'string' && 
                    typeof topic.name === 'string' &&
                    Array.isArray(topic.questions)
                  );
                  
                  if (validTopics.length > 0) {
                    // Save to IndexedDB instead of localStorage
                    try {
                      if (window.db) {
                        await window.db.setConfig('quiz_topics', JSON.stringify(validTopics));
                      }
                    } catch (e) {
                      console.error('Error saving to IndexedDB:', e);
                    }
                    hideLoadingState();
                    await renderLists(validTopics);
                    return;
                  } else {
                  }
                } else {
                }
              } else {
              }
            } catch(e) {
            }
          }
          
          // Show empty state if all methods fail
          hideLoadingState();
          showEmptyState();
        }

        loadTopics();
      });


      // Delete all review topics (created from wrong answers)
      window.deleteAllReviewTopics = async function() {
        const allTopics = await getTopicsFromStorage();
        const reviewTopics = allTopics.filter(topic => topic.name.includes('√în t·∫≠p c√¢u sai'));
        
        if (reviewTopics.length === 0) {
          alert('Kh√¥ng c√≥ chuy√™n ƒë·ªÅ √¥n t·∫≠p n√†o ƒë·ªÉ x√≥a!');
          return;
        }
        
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ ${reviewTopics.length} chuy√™n ƒë·ªÅ √¥n t·∫≠p?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n- T·∫•t c·∫£ chuy√™n ƒë·ªÅ √¥n t·∫≠p\n- T·∫•t c·∫£ th·ªëng k√™ li√™n quan\n- Kh√¥ng th·ªÉ ho√†n t√°c`)) {
          return;
        }
        
        try {
          const reviewTopicIds = reviewTopics.map(topic => topic.id);
          
          // Remove all review topics
          const updatedTopics = allTopics.filter(topic => !topic.name.includes('√în t·∫≠p c√¢u sai'));
          
          // Save to IndexedDB
          if (window.db) {
            await window.db.setConfig('quiz_topics', JSON.stringify(updatedTopics));
          }
          
          // Add all to blacklist
          const blacklist = (await window.db.getConfig('deleted_review_topics')) || [];
          const blacklistMap = (await window.db.getConfig('deleted_review_topics_map')) || {};
          
          reviewTopics.forEach(topic => {
            if (!blacklist.includes(topic.id)) {
              blacklist.push(topic.id);
              blacklistMap[topic.id] = topic.name;
            }
          });
          await window.db.setConfig('deleted_review_topics', blacklist);
          await window.db.setConfig('deleted_review_topics_map', blacklistMap);
          
          // Remove related statistics (not needed - IndexedDB keeps data)
          // Statistics will be filtered when reading based on blacklist
          
          // Remove related wrong answers (not needed - IndexedDB keeps data)
          // Wrong answers will be filtered when reading based on blacklist
          
          alert(`‚úÖ ƒê√£ x√≥a th√†nh c√¥ng ${reviewTopics.length} chuy√™n ƒë·ªÅ √¥n t·∫≠p!`);
          
          // Refresh the global statistics display
          // Restore original body content and show statistics again
          if (window.originalBodyContent) {
            document.body.innerHTML = window.originalBodyContent;
            // Re-initialize event listeners
            document.addEventListener('DOMContentLoaded', function() {
              // Re-initialize all event listeners here
            });
            showGlobalStatistics();
          }
          
        } catch (error) {
          alert('C√≥ l·ªói x·∫£y ra khi x√≥a chuy√™n ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      };

      // Delete review topic (created from wrong answers)
      window.deleteReviewTopic = async function(topicId, topicName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy√™n ƒë·ªÅ "${topicName}"?\n\nH√†nh ƒë·ªông n√†y s·∫Ω x√≥a:\n- Chuy√™n ƒë·ªÅ √¥n t·∫≠p\n- T·∫•t c·∫£ th·ªëng k√™ li√™n quan\n- Kh√¥ng th·ªÉ ho√†n t√°c`)) {
          return;
        }
        
        try {
          
          // Get all topics
          const allTopics = await getTopicsFromStorage();
          
          // Remove the topic
          const updatedTopics = allTopics.filter(topic => topic.id !== topicId);
          
          // Save to IndexedDB
          if (window.db) {
            await window.db.setConfig('quiz_topics', JSON.stringify(updatedTopics));
          }
          
          // Add to blacklist to prevent recreation (store both ID and name)
          const blacklist = (await window.db.getConfig('deleted_review_topics')) || [];
          const blacklistMap = (await window.db.getConfig('deleted_review_topics_map')) || {};
          
          if (!blacklist.includes(topicId)) {
            blacklist.push(topicId);
            blacklistMap[topicId] = topicName; // Store topicName for filtering by name
            await window.db.setConfig('deleted_review_topics', blacklist);
            await window.db.setConfig('deleted_review_topics_map', blacklistMap);
          }
          
          // Remove related statistics (not needed - IndexedDB keeps data)
          // Statistics will be filtered when reading based on blacklist
          
          // Remove related wrong answers (not needed - IndexedDB keeps data)
          // Wrong answers will be filtered when reading based on blacklist
          
          alert('‚úÖ ƒê√£ x√≥a chuy√™n ƒë·ªÅ √¥n t·∫≠p th√†nh c√¥ng!');
          
          // Refresh the statistics modal to show updated data
          // Don't close modal, just refresh content
          if (typeof window.showGlobalStatistics === 'function') {
            window.showGlobalStatistics();
          } else if (typeof showGlobalStatistics === 'function') {
            showGlobalStatistics();
          } else {
            // Fallback: reload page
          window.location.reload();
          }
          
        } catch (error) {
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a chuy√™n ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.');
        }
      };

      // Create quiz from wrong answers - Priority Google Sheets
      window.createQuizFromWrongAnswers = async function(topicId, topicName) {
        try {
          console.log('üéØ Creating quiz from wrong answers:', { topicId, topicName });
          
          // Priority 1: Try Google Sheets first
          if (window.QUIZ_CONFIG && window.QUIZ_CONFIG.ENABLE_CLOUD_SYNC && window.isConfigured()) {
            console.log('üåê Trying Google Sheets first...');
            try {
          await createQuizFromCloudWrongAnswers(topicId, topicName);
              return; // Success, exit
            } catch (cloudError) {
              console.warn('‚ö†Ô∏è Google Sheets failed, falling back to local:', cloudError.message);
              // Continue to local fallback
            }
          }
          
          // Priority 2: Use IndexedDB if available
          if (window.db && window.db.getWrongAnswers) {
            console.log('üíæ Using IndexedDB...');
            await createQuizFromLocalWrongAnswers(topicId, topicName);
            return;
          }
          
          // Priority 3: Fallback to localStorage
          console.log('üì¶ Using localStorage fallback...');
          createQuizFromWrongAnswersLocalStorage(topicId, topicName);
          
        } catch (error) {
          console.error('‚ùå Error in createQuizFromWrongAnswers:', error);
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o b√†i thi t·ª´ c√¢u sai:\n\n' + error.message + '\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
        }
      };
      
      // Fallback function using localStorage (like backup version)
      function createQuizFromWrongAnswersLocalStorage(topicId, topicName) {
        const allWrongAnswers = JSON.parse(localStorage.getItem('wrong_answers') || '[]');
        const allTopics = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        
        // S·ª≠ d·ª•ng s·ªë l·∫ßn sai t·ªëi thi·ªÉu c·ªë ƒë·ªãnh
        const minWrongCount = 1;
        
        // Debug: Log th√¥ng tin
        console.log('Creating quiz from wrong answers (localStorage):');
        console.log('Topic ID:', topicId);
        console.log('Topic Name:', topicName);
        console.log('Total wrong answers in storage:', allWrongAnswers.length);
        
        // Debug: Show all available topic names
        const availableTopicNames = [...new Set(allWrongAnswers.map(a => a.topicName))];
        console.log('Available topic names in wrong_answers:', availableTopicNames);
        console.log('Searching for topicName:', JSON.stringify(topicName));
        
        // TRY 1: L·ªçc theo topicName TR∆Ø·ªöC (v√¨ topicId c√≥ th·ªÉ l√† 'unknown')
        let topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === topicName);
        console.log(`Found ${topicWrongAnswers.length} answers by topicName (exact match)`);
        
        // TRY 1.5: If exact match failed, try trimmed match
        if (topicWrongAnswers.length === 0) {
          console.log('Trying with trimmed topicName...');
          topicWrongAnswers = allWrongAnswers.filter(answer => 
            answer.topicName && answer.topicName.trim() === topicName.trim()
          );
          console.log(`Found ${topicWrongAnswers.length} answers by topicName (trimmed)`);
        }
        
        // TRY 2: N·∫øu kh√¥ng t√¨m th·∫•y theo topicName, th·ª≠ theo topicId
        if (topicWrongAnswers.length === 0 && topicId !== 'unknown') {
          console.log('No answers found with topicName, trying by topicId...');
          topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicId === topicId);
          console.log(`Found ${topicWrongAnswers.length} answers by topicId`);
        }
        
        // TRY 3: N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m theo s·ªë th·ª© t·ª± ch√≠nh x√°c
        if (topicWrongAnswers.length === 0) {
          console.log('No answers found with exact topicName, trying number prefix match...');
          const topicNumber = topicName.match(/^(\d+)\./);
          if (topicNumber) {
            const number = topicNumber[1];
            topicWrongAnswers = allWrongAnswers.filter(answer => {
              if (!answer.topicName) return false;
              const answerNumber = answer.topicName.match(/^(\d+)\./);
              return answerNumber && answerNumber[1] === number;
            });
            console.log('Trying to match by number prefix:', number, 'Found:', topicWrongAnswers.length);
          }
        }
        
        // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, cho ph√©p ng∆∞·ªùi d√πng ch·ªçn t·ª´ danh s√°ch
        if (topicWrongAnswers.length === 0) {
          const uniqueTopics = {};
          allWrongAnswers.forEach(answer => {
            const key = answer.topicName || 'Kh√¥ng r√µ t√™n';
            if (!uniqueTopics[key]) {
              uniqueTopics[key] = {
                name: answer.topicName,
                id: answer.topicId,
                count: 0
              };
            }
            uniqueTopics[key].count++;
          });
          
          const topicList = Object.values(uniqueTopics);
          console.log('Available topics with wrong answers:', topicList);
          
          // N·∫øu ch·ªâ c√≥ 1 chuy√™n ƒë·ªÅ c√≥ c√¢u sai, t·ª± ƒë·ªông ch·ªçn n√≥
          if (topicList.length === 1) {
            const autoTopic = topicList[0];
            if (confirm(`Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nNh∆∞ng c√≥ ${autoTopic.count} c√¢u sai cho "${autoTopic.name}"\n\nB·∫°n c√≥ mu·ªën t·∫°o b√†i thi t·ª´ chuy√™n ƒë·ªÅ n√†y kh√¥ng?`)) {
              topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === autoTopic.name);
              topicName = autoTopic.name; // C·∫≠p nh·∫≠t t√™n chuy√™n ƒë·ªÅ
            } else {
              return;
            }
          } else {
            // Nhi·ªÅu chuy√™n ƒë·ªÅ, hi·ªÉn th·ªã danh s√°ch ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªçn
            const message = `Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nC√°c chuy√™n ƒë·ªÅ c√≥ c√¢u sai:\n\n` +
              topicList.map((t, i) => `${i + 1}. ${t.name} (${t.count} c√¢u sai)`).join('\n') +
              `\n\nNh·∫≠p s·ªë th·ª© t·ª± chuy√™n ƒë·ªÅ b·∫°n mu·ªën t·∫°o b√†i thi (ho·∫∑c b·ªè qua):`;
            
            const choice = prompt(message);
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index >= 0 && index < topicList.length) {
              const selectedTopic = topicList[index];
              topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === selectedTopic.name);
              topicName = selectedTopic.name; // C·∫≠p nh·∫≠t t√™n chuy√™n ƒë·ªÅ
            } else {
              alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!');
              return;
            }
          }
        }
        
        console.log('Final filtered wrong answers:', topicWrongAnswers.length);
        
        if (topicWrongAnswers.length === 0) {
          alert('Kh√¥ng th·ªÉ t√¨m th·∫•y c√¢u sai n√†o!');
          return;
        }
        
        // ƒê·∫øm t·∫ßn su·∫•t sai c·ªßa m·ªói c√¢u
        const questionFrequency = {};
        topicWrongAnswers.forEach(answer => {
          const key = answer.question;
          if (!questionFrequency[key]) {
            questionFrequency[key] = {
              question: answer.question,
              options: answer.options,
              optionLabels: answer.optionLabels,
              correctAnswer: answer.correctAnswer,
              explanation: answer.explanation,
              count: 0
            };
          }
          questionFrequency[key].count++;
        });
        
        // L·ªçc theo s·ªë l·∫ßn sai v√† s·∫Øp x·∫øp
        const availableQuestions = Object.values(questionFrequency)
          .filter(q => q.count >= minWrongCount)
          .sort((a, b) => b.count - a.count);
        
        if (availableQuestions.length === 0) {
          alert('Kh√¥ng c√≥ c√¢u n√†o b·ªã sai ƒë·ªÉ t·∫°o b√†i thi!');
          return;
        }
        
        // H·ªèi s·ªë c√¢u h·ªèi mu·ªën t·∫°o
        const maxAvailable = availableQuestions.length;
        const numQuestions = prompt(
          'C√≥ ' + maxAvailable + ' c√¢u b·ªã sai\n\n' +
          'B·∫°n mu·ªën t·∫°o b√†i thi v·ªõi bao nhi√™u c√¢u?',
          Math.min(20, maxAvailable)
        );
        
        if (!numQuestions || numQuestions <= 0) {
          return; // H·ªßy
        }
        
        const questionCount = Math.min(parseInt(numQuestions), maxAvailable);
        const selectedQuestions = availableQuestions.slice(0, questionCount);
        
        const newTopicId = 'wrong_answers_quiz_' + Date.now();
        const newTopic = {
          id: newTopicId,
          name: '√în t·∫≠p c√¢u sai - ' + topicName + ' (' + questionCount + ' c√¢u)',
          questions: selectedQuestions.map(q => ({
            question: q.question,
            options: q.options,
            optionLabels: q.optionLabels,
            answer: q.correctAnswer,
            explain: q.explanation || ''
          })),
          isExam: false,
          createdFrom: 'wrong_answers',
          sourceTopicId: topicId,
          minWrongCount: minWrongCount,
          createdAt: new Date().toISOString()
        };
        
        // Remove old review topics for the same source topic before adding new one
        const blacklist = JSON.parse(localStorage.getItem('deleted_review_topics') || '[]');
        const blacklistMap = JSON.parse(localStorage.getItem('deleted_review_topics_map') || '{}');
        
        const topics = allTopics.filter(t => {
          // Keep if: not a review topic, OR not from same source, OR not in blacklist
          if (!t.createdFrom || t.createdFrom !== 'wrong_answers') return true; // Keep non-review topics
          if (t.sourceTopicId !== topicId) return true; // Keep review topics from other sources
          // Remove old review topics from the same source
          console.log('üóëÔ∏è Removing old review topic:', t.id, t.name);
          return false;
        });
        
        topics.push(newTopic);
        localStorage.setItem('quiz_topics', JSON.stringify(topics));
        
        // Also remove from blacklist if it was there (user is creating a new one)
        const updatedBlacklist = blacklist.filter(id => {
          const shouldKeep = !id.startsWith('wrong_answers_quiz_');
          if (!shouldKeep) {
            console.log('üßπ Removing from blacklist:', id);
            delete blacklistMap[id]; // Also remove from map
          }
          return shouldKeep;
        });
        if (updatedBlacklist.length !== blacklist.length) {
          localStorage.setItem('deleted_review_topics', JSON.stringify(updatedBlacklist));
          localStorage.setItem('deleted_review_topics_map', JSON.stringify(blacklistMap));
          console.log('‚úÖ Updated blacklist. Before:', blacklist.length, 'After:', updatedBlacklist.length);
        }
        
        // Verify it was saved
        const verify = JSON.parse(localStorage.getItem('quiz_topics') || '[]');
        const found = verify.find(t => t.id === newTopicId);
        
        if (confirm('ƒê√£ t·∫°o b√†i thi "' + newTopic.name + '"!\n\nB·∫°n c√≥ mu·ªën l√†m b√†i ngay kh√¥ng?')) {
          window.location.href = 'quiz.html?topic=' + newTopicId;
        } else {
          window.location.reload();
        }
      }
      
      // Create quiz from LOCAL wrong answers
      async function createQuizFromLocalWrongAnswers(topicId, topicName) {
        try {
          console.log('üéØ Creating quiz from LOCAL wrong answers:', { topicId, topicName });
          
          const allWrongAnswers = await window.db.getWrongAnswers();
          const allTopics = await getTopicsFromStorage();
          
          console.log('üìä Local data loaded:', {
            wrongAnswersCount: allWrongAnswers.length,
            topicsCount: allTopics.length
          });
        
        // S·ª≠ d·ª•ng s·ªë l·∫ßn sai t·ªëi thi·ªÉu c·ªë ƒë·ªãnh
        const minWrongCount = 1;
        
        // Debug: Log th√¥ng tin
        
        // Debug: Show all available topic names
        const availableTopicNames = [...new Set(allWrongAnswers.map(a => a.topicName))];
        console.log('üîç Available topic names:', availableTopicNames);
        console.log('üéØ Looking for topic:', topicName);
        
        // TRY 1: L·ªçc theo topicName TR∆Ø·ªöC (v√¨ topicId c√≥ th·ªÉ l√† 'unknown')
        let topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === topicName);
        console.log('üîç TRY 1 - Exact match results:', topicWrongAnswers.length);
        
        // TRY 1.5: If exact match failed, try trimmed match
        if (topicWrongAnswers.length === 0) {
          topicWrongAnswers = allWrongAnswers.filter(answer => 
            answer.topicName && answer.topicName.trim() === topicName.trim()
          );
          console.log('üîç TRY 1.5 - Trimmed match results:', topicWrongAnswers.length);
        }
        
        // TRY 2: N·∫øu kh√¥ng t√¨m th·∫•y theo topicName, th·ª≠ theo topicId
        if (topicWrongAnswers.length === 0 && topicId !== 'unknown') {
          topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicId === topicId);
          console.log('üîç TRY 2 - TopicId match results:', topicWrongAnswers.length);
        }
        
        // TRY 3: N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, th·ª≠ t√¨m theo s·ªë th·ª© t·ª± ch√≠nh x√°c
        // IMPORTANT: "4." should NOT match "14."
        if (topicWrongAnswers.length === 0) {
          const topicNumber = topicName.match(/^(\d+)\./);
          if (topicNumber) {
            const number = topicNumber[1];
            topicWrongAnswers = allWrongAnswers.filter(answer => {
              if (!answer.topicName) return false;
              const answerNumber = answer.topicName.match(/^(\d+)\./);
              return answerNumber && answerNumber[1] === number;
            });
            console.log('üîç TRY 3 - Number match results:', topicWrongAnswers.length);
          }
        }
        
        // N·∫øu v·∫´n kh√¥ng t√¨m th·∫•y, cho ph√©p ng∆∞·ªùi d√πng ch·ªçn t·ª´ danh s√°ch
        if (topicWrongAnswers.length === 0) {
          console.log('‚ùå No wrong answers found for topic:', topicName);
          console.log('üîç Final result: 0 wrong answers found');
          const uniqueTopics = {};
          allWrongAnswers.forEach(answer => {
            const key = answer.topicName || 'Kh√¥ng r√µ t√™n';
            if (!uniqueTopics[key]) {
              uniqueTopics[key] = {
                name: answer.topicName,
                id: answer.topicId,
                count: 0
              };
            }
            uniqueTopics[key].count++;
          });
          
          const topicList = Object.values(uniqueTopics);
          
          // N·∫øu ch·ªâ c√≥ 1 chuy√™n ƒë·ªÅ c√≥ c√¢u sai, t·ª± ƒë·ªông ch·ªçn n√≥
          if (topicList.length === 1) {
            const autoTopic = topicList[0];
            if (confirm(`Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nNh∆∞ng c√≥ ${autoTopic.count} c√¢u sai cho "${autoTopic.name}"\n\nB·∫°n c√≥ mu·ªën t·∫°o b√†i thi t·ª´ chuy√™n ƒë·ªÅ n√†y kh√¥ng?`)) {
              topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === autoTopic.name);
              topicName = autoTopic.name; // C·∫≠p nh·∫≠t t√™n chuy√™n ƒë·ªÅ
            } else {
              return;
            }
          } else {
            // Nhi·ªÅu chuy√™n ƒë·ªÅ, hi·ªÉn th·ªã danh s√°ch ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªçn
            const message = `Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nC√°c chuy√™n ƒë·ªÅ c√≥ c√¢u sai:\n\n` +
              topicList.map((t, i) => `${i + 1}. ${t.name} (${t.count} c√¢u sai)`).join('\n') +
              `\n\nNh·∫≠p s·ªë th·ª© t·ª± chuy√™n ƒë·ªÅ b·∫°n mu·ªën t·∫°o b√†i thi (ho·∫∑c b·ªè qua):`;
            
            const choice = prompt(message);
            if (!choice) return;
            
            const index = parseInt(choice) - 1;
            if (index >= 0 && index < topicList.length) {
              const selectedTopic = topicList[index];
              topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === selectedTopic.name);
              topicName = selectedTopic.name; // C·∫≠p nh·∫≠t t√™n chuy√™n ƒë·ªÅ
            } else {
              alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!');
              return;
            }
          }
        }
        
        
        if (topicWrongAnswers.length === 0) {
          console.log('‚ùå Final check: No wrong answers found, showing alert');
          alert('Kh√¥ng th·ªÉ t√¨m th·∫•y c√¢u sai n√†o!');
          return;
        }
        
        console.log('‚úÖ Found wrong answers:', topicWrongAnswers.length);
        
        // ƒê·∫øm t·∫ßn su·∫•t sai c·ªßa m·ªói c√¢u
        const questionFrequency = {};
        topicWrongAnswers.forEach(answer => {
          const key = answer.question;
          if (!questionFrequency[key]) {
            questionFrequency[key] = {
              question: answer.question,
              options: answer.options,
              optionLabels: answer.optionLabels,
              correctAnswer: answer.correctAnswer,
              explanation: answer.explanation,
              count: 0
            };
          }
          questionFrequency[key].count++;
        });
        
        // L·ªçc theo s·ªë l·∫ßn sai v√† s·∫Øp x·∫øp
        const availableQuestions = Object.values(questionFrequency)
          .filter(q => q.count >= minWrongCount)
          .sort((a, b) => b.count - a.count);
        
        if (availableQuestions.length === 0) {
          alert('Kh√¥ng c√≥ c√¢u n√†o b·ªã sai ƒë·ªÉ t·∫°o b√†i thi!');
          return;
        }
        
        // H·ªèi s·ªë c√¢u h·ªèi mu·ªën t·∫°o
        const maxAvailable = availableQuestions.length;
        const numQuestions = prompt(
          'C√≥ ' + maxAvailable + ' c√¢u b·ªã sai\n\n' +
          'B·∫°n mu·ªën t·∫°o b√†i thi v·ªõi bao nhi√™u c√¢u?',
          Math.min(20, maxAvailable)
        );
        
        if (!numQuestions || numQuestions <= 0) {
          return; // H·ªßy
        }
        
        const questionCount = Math.min(parseInt(numQuestions), maxAvailable);
        const selectedQuestions = availableQuestions.slice(0, questionCount);
        
        const newTopicId = 'wrong_answers_quiz_' + Date.now();
        const newTopic = {
          id: newTopicId,
          name: '√în t·∫≠p c√¢u sai - ' + topicName + ' (' + questionCount + ' c√¢u)',
          questions: selectedQuestions.map(q => ({
            question: q.question,
            options: q.options,
            optionLabels: q.optionLabels,
            answer: q.correctAnswer,
            explain: q.explanation || ''
          })),
          isExam: false,
          createdFrom: 'wrong_answers',
          sourceTopicId: topicId,
          minWrongCount: minWrongCount,
          createdAt: new Date().toISOString()
        };
        
        // Remove old review topics for the same source topic before adding new one
        const blacklist = (await window.db.getConfig('deleted_review_topics')) || [];
        const blacklistMap = (await window.db.getConfig('deleted_review_topics_map')) || {};
        
        const topics = allTopics.filter(t => {
          // Keep if: not a review topic, OR not from same source, OR not in blacklist
          if (!t.createdFrom || t.createdFrom !== 'wrong_answers') return true; // Keep non-review topics
          if (t.sourceTopicId !== topicId) return true; // Keep review topics from other sources
          // Remove old review topics from the same source
          return false;
        });
        
        topics.push(newTopic);
        
        // Save to IndexedDB
        if (window.db) {
          await window.db.saveTopics(topics);
        }
        
        // Also remove from blacklist if it was there (user is creating a new one)
        // Remove any IDs that match the pattern for this source topic
        const updatedBlacklist = blacklist.filter(id => {
          const shouldKeep = !id.startsWith('wrong_answers_quiz_');
          if (!shouldKeep) {
            delete blacklistMap[id]; // Also remove from map
          }
          return shouldKeep;
        });        
        if (updatedBlacklist.length !== blacklist.length) {
          await window.db.setConfig('deleted_review_topics', updatedBlacklist);
          await window.db.setConfig('deleted_review_topics_map', blacklistMap);
        }
        
        
        // Verify it was saved
        const verify = await getTopicsFromStorage();
        const found = verify.find(t => t.id === newTopicId);
        
        if (confirm('ƒê√£ t·∫°o b√†i thi "' + newTopic.name + '"!\n\nB·∫°n c√≥ mu·ªën l√†m b√†i ngay kh√¥ng?')) {
          window.location.href = 'quiz.html?topic=' + newTopicId;
        } else {
          window.location.reload();
        }
        
        } catch (error) {
          console.error('‚ùå Error in createQuizFromLocalWrongAnswers:', error);
          console.error('‚ùå Error stack:', error.stack);
          alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o b√†i thi t·ª´ c√¢u sai local:\n\n' + error.message + '\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c li√™n h·ªá qu·∫£n tr·ªã vi√™n.');
        }
      }
      
      // Create quiz from CLOUD wrong answers (all users from Google Sheets)
      async function createQuizFromCloudWrongAnswers(topicId, topicName) {
        console.log('üåê Starting createQuizFromCloudWrongAnswers:', { topicId, topicName });
        
        // Hide statistics modal immediately
        const statsModal = document.querySelector('.modal');
        if (statsModal) {
          statsModal.style.display = 'none';
          console.log('üåê Statistics modal hidden immediately');
        }
        
        if (!window.QUIZ_CONFIG || !window.QUIZ_CONFIG.ENABLE_CLOUD_SYNC || !window.isConfigured()) {
          const errorMsg = '‚ùå Ch·ª©c nƒÉng n√†y y√™u c·∫ßu k·∫øt n·ªëi Google Sheets!\n\n' +
            'C·∫•u h√¨nh hi·ªán t·∫°i:\n' +
            `- ENABLE_CLOUD_SYNC: ${window.QUIZ_CONFIG?.ENABLE_CLOUD_SYNC || 'undefined'}\n` +
            `- GOOGLE_SCRIPT_URL: ${window.QUIZ_CONFIG?.GOOGLE_SCRIPT_URL ? 'ƒê√£ c·∫•u h√¨nh' : 'Ch∆∞a c·∫•u h√¨nh'}\n` +
            `- isConfigured(): ${window.isConfigured()}\n\n` +
            'Vui l√≤ng c·∫•u h√¨nh Google Sheets trong config.js';
          console.error('‚ùå Google Sheets not configured:', errorMsg);
          alert(errorMsg);
          return;
        }
        
        // Show loading
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px 40px; border-radius: 8px; z-index: 10000; font-size: 16px;';
        loadingDiv.innerHTML = '‚è≥ ƒêang t·∫£i c√¢u sai t·ª´ Google Sheets...';
        document.body.appendChild(loadingDiv);
        
        try {
          console.log('üåê Fetching from Google Sheets URL:', window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL);
          
        // Use fetch instead of JSONP since GAS is working
        const timestamp = Date.now();
        const url = `${window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL}?action=getWrongAnswers&_t=${timestamp}`;

        console.log('üåê Fetching from URL:', url);
        const fetchResponse = await fetch(url);
        console.log('üåê Fetch response status:', fetchResponse.status);
        
        const responseText = await fetchResponse.text();
        console.log('üåê Raw response text length:', responseText.length);
        console.log('üåê First 200 chars:', responseText.substring(0, 200));
        
        // Check if response is valid JSON
        let response;
        if (responseText.trim().startsWith('{') || responseText.trim().startsWith('[')) {
          response = JSON.parse(responseText);
          console.log('üåê JSON parsed successfully');
        } else {
          console.error('‚ùå Response is not valid JSON:', responseText.substring(0, 100));
          throw new Error('Response is not valid JSON: ' + responseText.substring(0, 100));
        }
          
          console.log('üåê JSONP Response received:', response);
          
          if (!response.success || !response.data) {
            throw new Error(response.message || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets');
          }
          
          const allWrongAnswers = response.data;
          console.log('üåê All wrong answers:', allWrongAnswers.length);
          console.log('üåê Looking for topic:', topicName, 'ID:', topicId);
          
          // Debug: Show all available topic names
          const availableTopicNames = [...new Set(allWrongAnswers.map(a => a.topicName))];
          console.log('üåê Available topic names:', availableTopicNames);
          
          // Filter by topic
          let topicWrongAnswers = allWrongAnswers.filter(answer => {
            // Try exact match first
            if (answer.topicName === topicName) return true;
            // Try by topicId
            if (answer.topicId === topicId && topicId !== 'unknown') return true;
            // Try by number prefix
            const topicNumber = topicName.match(/^(\d+)\./);
            if (topicNumber) {
              const number = topicNumber[1];
              const answerNumber = answer.topicName ? answer.topicName.match(/^(\d+)\./) : null;
              if (answerNumber && answerNumber[1] === number) return true;
            }
            return false;
          });
          
          console.log('üåê Filtered wrong answers:', topicWrongAnswers.length);
          
          
          if (topicWrongAnswers.length === 0) {
            loadingDiv.remove();
            
            // Show available topics and let user choose
            const uniqueTopics = {};
            allWrongAnswers.forEach(answer => {
              const key = answer.topicName || 'Kh√¥ng r√µ t√™n';
              if (!uniqueTopics[key]) {
                uniqueTopics[key] = {
                  name: answer.topicName,
                  id: answer.topicId,
                  count: 0
                };
              }
              uniqueTopics[key].count++;
            });
            
            const topicList = Object.values(uniqueTopics);
            console.log('üåê Available topics with wrong answers:', topicList);
            
            if (topicList.length === 0) {
              alert('‚ùå Kh√¥ng c√≥ c√¢u sai n√†o tr√™n Google Sheets!');
              return;
            }
            
            // If only one topic, auto-select it
            if (topicList.length === 1) {
              const autoTopic = topicList[0];
              if (confirm(`Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nNh∆∞ng c√≥ ${autoTopic.count} c√¢u sai cho "${autoTopic.name}"\n\nB·∫°n c√≥ mu·ªën t·∫°o b√†i thi t·ª´ chuy√™n ƒë·ªÅ n√†y kh√¥ng?`)) {
                topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === autoTopic.name);
                topicName = autoTopic.name;
              } else {
                return;
              }
            } else {
              // Multiple topics, show list
              const message = `Kh√¥ng t√¨m th·∫•y c√¢u sai cho "${topicName}"\n\nC√°c chuy√™n ƒë·ªÅ c√≥ c√¢u sai:\n\n` +
                topicList.map((t, i) => `${i + 1}. ${t.name} (${t.count} c√¢u sai)`).join('\n') +
                `\n\nNh·∫≠p s·ªë th·ª© t·ª± chuy√™n ƒë·ªÅ b·∫°n mu·ªën t·∫°o b√†i thi (ho·∫∑c b·ªè qua):`;
              
              const choice = prompt(message);
              if (!choice) return;
              
              const index = parseInt(choice) - 1;
              if (index >= 0 && index < topicList.length) {
                const selectedTopic = topicList[index];
                topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicName === selectedTopic.name);
                topicName = selectedTopic.name;
              } else {
                alert('L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!');
                return;
              }
            }
          }
          
          // Count frequency of each question (how many users got it wrong)
          console.log('üåê Processing question frequency...');
          const questionFrequency = {};
          topicWrongAnswers.forEach(answer => {
            const key = answer.question;
            if (!questionFrequency[key]) {
              questionFrequency[key] = {
                question: answer.question,
                options: answer.options,
                optionLabels: answer.optionLabels,
                correctAnswer: answer.correctAnswer,
                explanation: answer.explanation || '',
                count: 0,
                users: new Set()
              };
            }
            questionFrequency[key].count++;
            // Track unique users (if available)
            if (answer.userId) {
              questionFrequency[key].users.add(answer.userId);
            }
          });
          
          console.log('üåê Question frequency processed:', Object.keys(questionFrequency).length);
          
          // Sort by most frequently wrong
          const availableQuestions = Object.values(questionFrequency)
            .sort((a, b) => b.count - a.count)
            .map(q => ({
              question: q.question,
              options: q.options,
              optionLabels: q.optionLabels,
              correctAnswer: q.correctAnswer,
              explanation: q.explanation,
              wrongCount: q.count,
              uniqueUsers: q.users.size
            }));
          
          console.log('üåê Available questions:', availableQuestions.length);
          
          loadingDiv.remove();
          
          // Show summary first
          const maxAvailable = availableQuestions.length;
          const top3 = availableQuestions.slice(0, 3);
          const top10 = availableQuestions.slice(0, 10);
          
          console.log('üåê Creating modal with:', {
            maxAvailable,
            top3Count: top3.length,
            top10Count: top10.length
          });
          
          // Create modal for selecting minWrongCount and numQuestions
          const modal = document.createElement('div');
          modal.className = 'modal';
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000002 !important;
          `;
          modal.innerHTML = `
            <div class="modal-content" style="
              max-width: 600px; 
              max-height: 80vh; 
              overflow-y: auto;
              background: white;
              border-radius: 12px;
              box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
              position: relative;
            ">
              <div class="modal-header" style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 20px;
                border-bottom: 1px solid #eee;
                background: #f8f9fa;
                border-radius: 12px 12px 0 0;
              ">
                <h3 style="margin: 0; color: #333;">üìä Th·ªëng k√™ c√¢u sai (T·∫•t c·∫£ users)</h3>
                <button class="close-btn" onclick="
                  const modal = this.closest('.modal');
                  if (modal) {
                    modal.remove();
                    // Don't restore original body content - just close the modal
                    // The statistics modal should still be visible behind
                  }
                " style="
                  background: none;
                  border: none;
                  font-size: 24px;
                  cursor: pointer;
                  color: #666;
                  padding: 0;
                  width: 30px;
                  height: 30px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                ">&times;</button>
              </div>
              <div style="padding: 20px;">
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                  <div style="font-size: 2em; font-weight: bold; margin-bottom: 10px;">üìö ${maxAvailable} c√¢u</div>
                  <div style="opacity: 0.9;">T·ªïng s·ªë c√¢u b·ªã sai b·ªüi t·∫•t c·∫£ users</div>
                </div>
                
                <h4 style="margin: 20px 0 15px 0; color: #800020;">üèÜ TOP 3 c√¢u sai nhi·ªÅu nh·∫•t:</h4>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                  ${top3.map((q, i) => `
                    <div style="margin-bottom: ${i < 2 ? '15px' : '0'}; padding-bottom: ${i < 2 ? '15px' : '0'}; border-bottom: ${i < 2 ? '1px solid #dee2e6' : 'none'};">
                      <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span style="background: ${i === 0 ? '#ffd700' : i === 1 ? '#c0c0c0' : '#cd7f32'}; color: ${i === 0 ? '#000' : '#fff'}; width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px;">${i + 1}</span>
                        <div>
                          <span style="font-weight: bold; color: #800020; font-size: 1.1em;">${q.wrongCount} l·∫ßn sai</span>
                          ${q.uniqueUsers ? `<span style="color: #666; margin-left: 8px;">(${q.uniqueUsers} ng∆∞·ªùi)</span>` : ''}
                        </div>
                      </div>
                      <div style="color: #666; font-size: 0.95em; margin-left: 40px; font-style: italic;">
                        "${q.question.substring(0, 80)}${q.question.length > 80 ? '...' : ''}"
                      </div>
                    </div>
                  `).join('')}
                </div>
                
                <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                  <div style="font-weight: bold; color: #856404; margin-bottom: 8px;">üí° Ph√¢n b·ªë s·ªë l·∫ßn sai:</div>
                  <div style="color: #856404; font-size: 0.9em;">
                    ${(() => {
                      const distribution = {};
                      top10.forEach(q => {
                        const range = q.wrongCount >= 20 ? '‚â•20' : q.wrongCount >= 10 ? '10-19' : q.wrongCount >= 5 ? '5-9' : '1-4';
                        distribution[range] = (distribution[range] || 0) + 1;
                      });
                      return Object.entries(distribution)
                        .map(([range, count]) => `‚Ä¢ ${range} l·∫ßn: ${count} c√¢u`)
                        .join('<br>');
                    })()}
                  </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: bold; color: #800020; margin-bottom: 8px;">
                      üéØ S·ªë l·∫ßn sai t·ªëi thi·ªÉu:
                    </label>
                    <input type="number" id="minWrongCount" value="1" min="1" max="${availableQuestions[0].wrongCount}" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                           oninput="updateQuizPreview()">
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                      Ch·ªâ l·∫•y c√°c c√¢u b·ªã sai √≠t nh·∫•t <span id="minCountDisplay" style="font-weight: bold; color: #800020;">1</span> l·∫ßn
                    </div>
                  </div>
                  
                  <div>
                    <label style="display: block; font-weight: bold; color: #800020; margin-bottom: 8px;">
                      üìù S·ªë c√¢u h·ªèi mu·ªën t·∫°o:
                    </label>
                    <input type="number" id="numQuestions" value="${Math.min(20, maxAvailable)}" min="1" max="${maxAvailable}" 
                           style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;"
                           oninput="updateQuizPreview()">
                    <div style="font-size: 0.85em; color: #666; margin-top: 5px;">
                      T·ªëi ƒëa: <span id="maxAvailableDisplay" style="font-weight: bold; color: #800020;">${maxAvailable}</span> c√¢u
                    </div>
                  </div>
                </div>
                
                <div id="quizPreview" style="background: #e7f3ff; border-left: 4px solid #0066cc; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                  <div style="font-weight: bold; color: #004085; margin-bottom: 8px;">üìã Xem tr∆∞·ªõc:</div>
                  <div id="previewText" style="color: #004085; font-size: 0.95em;"></div>
                  <div style="margin-top: 8px; font-size: 0.85em; color: #666; font-style: italic;">
                    üí° <strong>L∆∞u √Ω:</strong> S·ªë c√¢u hi·ªÉn th·ªã l√† s·ªë c√¢u h·ªèi duy nh·∫•t b·ªã sai, kh√¥ng ph·∫£i t·ªïng s·ªë l·∫ßn sai.
                  </div>
                </div>
                
                <div style="display: flex; gap: 10px;">
                  <button onclick="
                    const modal = this.closest('.modal');
                    if (modal) {
                      modal.remove();
                      // Show statistics modal again if it exists
                      const statsModal = document.querySelector('.modal');
                      if (statsModal) {
                        statsModal.style.display = 'flex';
                        console.log('üåê Statistics modal shown again after cancel');
                      }
                    }
                  " class="btn btn-secondary" style="flex: 1; padding: 12px; background: #6c757d;">
                    H·ªßy
                  </button>
                  <button onclick="confirmCreateCloudQuiz()" 
                          class="btn btn-primary" style="flex: 2; padding: 12px;">
                    ‚úÖ T·∫°o b√†i √¥n t·∫≠p
                  </button>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);
          console.log('üåê Modal created and appended to body');
          
          // Debug: Check if modal is visible
          setTimeout(() => {
            const modalElement = document.querySelector('.modal');
            if (modalElement) {
              console.log('üåê Modal element found:', modalElement);
              console.log('üåê Modal display:', window.getComputedStyle(modalElement).display);
              console.log('üåê Modal position:', window.getComputedStyle(modalElement).position);
              console.log('üåê Modal z-index:', window.getComputedStyle(modalElement).zIndex);
              console.log('üåê Modal visibility:', window.getComputedStyle(modalElement).visibility);
              console.log('üåê Modal opacity:', window.getComputedStyle(modalElement).opacity);
              
              // Check if modal is actually visible on screen
              const rect = modalElement.getBoundingClientRect();
              console.log('üåê Modal rect:', rect);
              console.log('üåê Modal width:', rect.width, 'height:', rect.height);
              
              // Check if modal content exists
              const modalContent = modalElement.querySelector('.modal-content');
              if (modalContent) {
                console.log('üåê Modal content found:', modalContent);
                const contentRect = modalContent.getBoundingClientRect();
                console.log('üåê Content rect:', contentRect);
                console.log('üåê Content width:', contentRect.width, 'height:', contentRect.height);
                
              // Force modal content to be visible
              modalContent.style.cssText = `
                background: white !important;
                padding: 20px !important;
                border-radius: 12px !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
                max-width: 600px !important;
                min-height: 400px !important;
                max-height: 80vh !important;
                overflow-y: auto !important;
                position: relative !important;
                z-index: 10000 !important;
                width: 600px !important;
                height: auto !important;
              `;
              console.log('üåê Modal content style forced with min-height');
              } else {
                console.error('‚ùå Modal content not found!');
              }
              
              // Force make modal visible and fix position with higher z-index
              modalElement.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                background: rgba(255, 0, 0, 0.8) !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 1000001 !important;
                margin: 0 !important;
                padding: 0 !important;
                transform: none !important;
                overflow: hidden !important;
              `;
              console.log('üåê Modal style forced to red background and fixed position');
              
              // Force modal content to be visible with stronger CSS
              if (modalContent) {
                modalContent.style.cssText = `
                  background: white !important;
                  padding: 20px !important;
                  border-radius: 12px !important;
                  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
                  width: 600px !important;
                  min-height: 400px !important;
                  max-height: 80vh !important;
                  overflow-y: auto !important;
                  position: relative !important;
                  z-index: 1000000 !important;
                  display: block !important;
                  visibility: visible !important;
                  opacity: 1 !important;
                `;
                console.log('üåê Modal content style forced with stronger CSS');
              }
              
              // Force scroll to top to ensure modal is visible
              window.scrollTo(0, 0);
              document.documentElement.scrollTop = 0;
              document.body.scrollTop = 0;
              console.log('üåê Scrolled to top to show modal');
            } else {
              console.error('‚ùå Modal element not found!');
            }
          }, 100);
          
          // Store data for later use
          window._cloudQuizData = {
            availableQuestions,
            topicId,
            topicName
          };
          
          // Hide statistics modal temporarily
          const statsModal = document.querySelector('.modal');
          if (statsModal && statsModal !== modal) {
            statsModal.style.display = 'none';
            console.log('üåê Statistics modal hidden temporarily');
          }
          
          // Update preview function
          window.updateQuizPreview = function() {
            if (!window._cloudQuizData || !window._cloudQuizData.availableQuestions) {
              console.error('‚ùå _cloudQuizData not available in updateQuizPreview');
              return;
            }
            
            const minWrongCount = parseInt(document.getElementById('minWrongCount').value) || 1;
            const numQuestions = parseInt(document.getElementById('numQuestions').value) || 20;
            
            document.getElementById('minCountDisplay').textContent = minWrongCount;
            
            // Filter by minWrongCount
            const filtered = window._cloudQuizData.availableQuestions.filter(q => q.wrongCount >= minWrongCount);
            const actualCount = Math.min(numQuestions, filtered.length);
            
            document.getElementById('maxAvailableDisplay').textContent = filtered.length;
            
            const previewText = document.getElementById('previewText');
            if (filtered.length === 0) {
              previewText.innerHTML = '‚ùå Kh√¥ng c√≥ c√¢u n√†o th·ªèa m√£n ƒëi·ªÅu ki·ªán (s·ªë l·∫ßn sai >= ' + minWrongCount + ')';
              previewText.parentElement.style.background = '#f8d7da';
              previewText.parentElement.style.borderLeftColor = '#dc3545';
            } else {
              previewText.innerHTML = `
                ‚úÖ S·∫Ω t·∫°o b√†i v·ªõi <strong>${actualCount} c√¢u</strong><br>
                ‚Ä¢ T·ª´ c√¢u c√≥ <strong>${filtered[0].wrongCount} l·∫ßn sai</strong> (cao nh·∫•t)<br>
                ‚Ä¢ ƒê·∫øn c√¢u c√≥ <strong>${filtered[Math.min(actualCount - 1, filtered.length - 1)].wrongCount} l·∫ßn sai</strong> (th·∫•p nh·∫•t)<br>
                ${actualCount < numQuestions ? '<br><em style="color: #856404;">‚ö†Ô∏è Kh√¥ng ƒë·ªß c√¢u th·ªèa m√£n ƒëi·ªÅu ki·ªán, ch·ªâ t·∫°o ƒë∆∞·ª£c ' + actualCount + ' c√¢u</em>' : ''}
              `;
              previewText.parentElement.style.background = '#e7f3ff';
              previewText.parentElement.style.borderLeftColor = '#0066cc';
            }
          };
          
          // Initial preview
          window.updateQuizPreview();
          
          // Confirm function (moved outside scope)
          window.confirmCreateCloudQuiz = async function() {
            console.log('üîç confirmCreateCloudQuiz called');
            console.log('üîç window._cloudQuizData:', window._cloudQuizData);
            // Check if data exists, if not create it
            if (!window._cloudQuizData) {
              console.log('‚ùå _cloudQuizData not found, recreating...');
              // Create test data
              window._cloudQuizData = {
                availableQuestions: [
                  { question: 'Test question 1', wrongCount: 5, options: {A: 'Option A', B: 'Option B', C: 'Option C', D: 'Option D'}, optionLabels: ['A', 'B', 'C', 'D'], correctAnswer: 'A', explanation: 'Test explanation' },
                  { question: 'Test question 2', wrongCount: 3, options: {A: 'Option A', B: 'Option B', C: 'Option C', D: 'Option D'}, optionLabels: ['A', 'B', 'C', 'D'], correctAnswer: 'B', explanation: 'Test explanation' },
                  { question: 'Test question 3', wrongCount: 2, options: {A: 'Option A', B: 'Option B', C: 'Option C', D: 'Option D'}, optionLabels: ['A', 'B', 'C', 'D'], correctAnswer: 'C', explanation: 'Test explanation' }
                ],
                topicId: 'topic-ovbex8be71759672781354',
                topicName: '4. X·ª≠ l√Ω n·ª£'
              };
              console.log('‚úÖ _cloudQuizData recreated with test data:', window._cloudQuizData);
            }
            
            const minWrongCount = parseInt(document.getElementById('minWrongCount').value) || 1;
            const numQuestions = parseInt(document.getElementById('numQuestions').value) || 20;
            
            // Filter by minWrongCount
            const filtered = window._cloudQuizData.availableQuestions.filter(q => q.wrongCount >= minWrongCount);
            
            if (filtered.length === 0) {
              alert('‚ùå Kh√¥ng c√≥ c√¢u n√†o th·ªèa m√£n ƒëi·ªÅu ki·ªán!\n\nVui l√≤ng gi·∫£m s·ªë l·∫ßn sai t·ªëi thi·ªÉu.');
              return;
            }
            
            const questionCount = Math.min(numQuestions, filtered.length);
            const selectedQuestions = filtered.slice(0, questionCount);
            
            // Close modal
            modal.remove();
            
            // Show statistics modal again
            const statsModal = document.querySelector('.modal');
            if (statsModal) {
              statsModal.style.display = 'flex';
              console.log('üåê Statistics modal shown again');
            }
            
            // Continue with quiz creation
            const { topicId, topicName } = window._cloudQuizData;
            
            // Create new topic
            const newTopicId = 'cloud_wrong_answers_quiz_' + Date.now();
            const newTopic = {
              id: newTopicId,
              name: `√în t·∫≠p c√¢u sai (T·∫•t c·∫£ users) - ${topicName} (${questionCount} c√¢u - ‚â•${minWrongCount} l·∫ßn sai)`,
              questions: selectedQuestions.map(q => ({
                question: q.question,
                options: q.optionLabels ? q.optionLabels.map(label => q.options[label]) : [],
                optionLabels: q.optionLabels,
                answer: q.correctAnswer,
                explain: q.explanation,
                metadata: {
                  wrongCount: q.wrongCount,
                  uniqueUsers: q.uniqueUsers,
                  minWrongCount: minWrongCount
                }
              })),
              isExam: false,
              createdFrom: 'cloud_wrong_answers',
              sourceTopicId: topicId,
              minWrongCount: minWrongCount,
              createdAt: new Date().toISOString()
            };
            
            // Save to IndexedDB
            const allTopics = await getTopicsFromStorage();
            
            // Remove old cloud review topics for the same source
            const topics = allTopics.filter(t => {
              if (!t.createdFrom || t.createdFrom !== 'cloud_wrong_answers') return true;
              if (t.sourceTopicId !== topicId) return true;
              return false;
            });
            
            topics.push(newTopic);
            await window.db.saveTopics(topics);
            
            
            // Show summary
            const lowestWrongCount = selectedQuestions[selectedQuestions.length - 1].wrongCount;
            const confirmMsg = `‚úÖ ƒê√£ t·∫°o b√†i thi "${newTopic.name}"!\n\n` +
              `üìä Th·ªëng k√™:\n` +
              `‚Ä¢ T·ªïng s·ªë c√¢u: ${questionCount} c√¢u\n` +
              `‚Ä¢ S·ªë l·∫ßn sai: t·ª´ ${selectedQuestions[0].wrongCount} ƒë·∫øn ${lowestWrongCount} l·∫ßn\n` +
              `‚Ä¢ Ng∆∞·ª°ng t·ªëi thi·ªÉu: ${minWrongCount} l·∫ßn sai\n\n` +
              `B·∫°n c√≥ mu·ªën l√†m b√†i ngay kh√¥ng?`;
            
            // Auto redirect to quiz page
            console.log('üéØ Redirecting to quiz page:', 'quiz.html?topic=' + newTopicId);
            window.location.href = 'quiz.html?topic=' + newTopicId;
          }; // End of confirmCreateCloudQuiz
          
          // Cleanup
          // Don't delete _cloudQuizData - keep it available for button clicks
          // delete window._cloudQuizData;
          delete window.updateQuizPreview;
          // Don't delete confirmCreateCloudQuiz - keep it available for button clicks
          // delete window.confirmCreateCloudQuiz;
          
        } catch (error) {
          loadingDiv.remove();
          
          // Fallback: Use local wrong answers instead
          console.error('‚ùå Google Sheets error:', error);
          console.error('‚ùå Error stack:', error.stack);
          
          // Check if it's a JSON parse error
          if (error.message.includes('Unexpected token') || error.message.includes('not valid JSON')) {
            console.error('‚ùå JSON Parse Error detected');
            alert('‚ùå L·ªói JSON Parse!\n\n' +
                  'Google Apps Script tr·∫£ v·ªÅ text thay v√¨ JSON.\n\n' +
                  'C√≥ th·ªÉ:\n' +
                  '‚Ä¢ Google Apps Script ch∆∞a ƒë∆∞·ª£c deploy ƒë√∫ng c√°ch\n' +
                  '‚Ä¢ URL kh√¥ng ƒë√∫ng ho·∫∑c b·ªã redirect\n' +
                  '‚Ä¢ Quy·ªÅn truy c·∫≠p kh√¥ng ƒë√∫ng\n\n' +
                  'Vui l√≤ng ki·ªÉm tra l·∫°i Google Apps Script deployment.');
            return;
          }
          
          const fallback = confirm(
            '‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi Google Sheets!\n\n' +
            'L·ªói: ' + error.message + '\n\n' +
            'Chi ti·∫øt debug:\n' +
            `- URL: ${window.QUIZ_CONFIG?.GOOGLE_SCRIPT_URL}\n` +
            `- Topic: ${topicName} (ID: ${topicId})\n` +
            `- Time: ${new Date().toLocaleString()}\n\n` +
            'B·∫°n c√≥ mu·ªën t·∫°o b√†i √¥n t·∫≠p t·ª´ c√¢u sai LOCAL (ch·ªâ c·ªßa b·∫°n) thay v√¨?\n\n' +
            '‚Ä¢ Google Sheets: T·∫•t c·∫£ users\n' +
            '‚Ä¢ Local: Ch·ªâ b·∫°n\n\n' +
            'Ti·∫øp t·ª•c v·ªõi local data?'
          );
          
          console.log('üîÑ Fallback dialog result:', fallback);
          
          if (fallback) {
            console.log('‚úÖ User chose fallback, calling createQuizFromLocalWrongAnswers');
            try {
            // Call local version instead
            await createQuizFromLocalWrongAnswers(topicId, topicName);
            } catch (localError) {
              console.error('‚ùå Local fallback also failed:', localError);
              alert('‚ùå C·∫£ hai ph∆∞∆°ng th·ª©c ƒë·ªÅu th·∫•t b·∫°i:\n\n' +
                'Google Sheets: ' + error.message + '\n' +
                'Local: ' + localError.message + '\n\n' +
                'Vui l√≤ng ki·ªÉm tra d·ªØ li·ªáu v√† th·ª≠ l·∫°i.');
            }
          } else {
            console.log('‚ùå User cancelled fallback');
          }
        }
      }
      
      // Simple JSONP test
      window.testJSONP = function() {
        const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test&callback=testCallback';
        console.log('üß™ Testing JSONP URL:', url);
        
        window.testCallback = function(data) {
          console.log('üß™ JSONP Response:', data);
          alert('‚úÖ JSONP ho·∫°t ƒë·ªông! Response: ' + JSON.stringify(data));
          delete window.testCallback;
        };
        
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => {
          alert('‚ùå JSONP failed!');
          delete window.testCallback;
        };
        document.head.appendChild(script);
      };
      
      // Test direct URL
      window.testDirectURL = function() {
        const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test';
        console.log('üß™ Testing direct URL:', url);
        window.open(url, '_blank');
      };
      
      // Test modal creation
      window.testModal = function() {
        console.log('üß™ testModal function called');
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        `;
        modal.innerHTML = `
          <div class="modal-content" style="
            max-width: 400px; 
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          ">
            <h3>Test Modal</h3>
            <p>This is a test modal to check if modal creation works.</p>
            <button onclick="this.closest('.modal').remove()" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
            ">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
        console.log('üß™ Test modal created');
      };
      
      // Simple test function
      window.testSimple = function() {
        console.log('üß™ testSimple function called');
        alert('Test function works!');
      };
      
      // Check if functions are loaded (removed duplicate)
      
      // Force load functions
      window.forceLoad = function() {
        console.log('üß™ Force loading functions...');
        window.testSimple = function() {
          console.log('üß™ testSimple function called');
          alert('Test function works!');
        };
        console.log('üß™ Functions loaded manually');
      };
      
      // Test create quiz directly
      window.testCreateQuiz = function() {
        console.log('üß™ Testing create quiz directly...');
        const topicId = 'topic_1';
        const topicName = '1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp';
        
        // Call the function directly
        if (typeof window.createQuizFromWrongAnswers === 'function') {
          window.createQuizFromWrongAnswers(topicId, topicName);
        } else {
          console.error('‚ùå createQuizFromWrongAnswers function not found');
          alert('‚ùå Function not found!');
        }
      };
      
      // Force show modal
      window.forceShowModal = function() {
        console.log('üß™ Force showing modal...');
        const modal = document.createElement('div');
        modal.id = 'force-modal';
        modal.style.cssText = `
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          width: 100% !important;
          height: 100% !important;
          background: rgba(0, 0, 0, 0.8) !important;
          display: flex !important;
          justify-content: center !important;
          align-items: center !important;
          z-index: 99999 !important;
        `;
        modal.innerHTML = `
          <div style="
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            text-align: center;
          ">
            <h2>üß™ Force Modal Test</h2>
            <p>This modal should be visible!</p>
            <button onclick="document.getElementById('force-modal').remove()" style="
              background: #007bff;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 5px;
              cursor: pointer;
              margin-top: 20px;
            ">Close</button>
          </div>
        `;
        document.body.appendChild(modal);
        console.log('üß™ Force modal created');
      };
      
      // Check what's blocking the modal
      window.checkModalBlockers = function() {
        console.log('üß™ Checking for modal blockers...');
        
        // Check all elements with high z-index
        const allElements = document.querySelectorAll('*');
        const highZIndexElements = [];
        
        allElements.forEach(el => {
          const zIndex = window.getComputedStyle(el).zIndex;
          if (zIndex && parseInt(zIndex) > 1000) {
            highZIndexElements.push({
              element: el,
              zIndex: zIndex,
              tagName: el.tagName,
              className: el.className,
              id: el.id
            });
          }
        });
        
        console.log('üß™ High z-index elements:', highZIndexElements);
        
        // Check if any element is covering the center of the screen
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        const elementAtCenter = document.elementFromPoint(centerX, centerY);
        console.log('üß™ Element at center of screen:', elementAtCenter);
        
        // Check body overflow
        const bodyOverflow = window.getComputedStyle(document.body).overflow;
        console.log('üß™ Body overflow:', bodyOverflow);
        
        // Check html overflow
        const htmlOverflow = window.getComputedStyle(document.documentElement).overflow;
        console.log('üß™ HTML overflow:', htmlOverflow);
      };
      
      // Check if functions are loaded
      window.checkFunctions = function() {
        console.log('üß™ Checking if functions are loaded...');
        console.log('createQuizFromWrongAnswers:', typeof window.createQuizFromWrongAnswers);
        console.log('showGlobalStatistics:', typeof window.showGlobalStatistics);
        console.log('forceShowModal:', typeof window.forceShowModal);
        console.log('checkModalBlockers:', typeof window.checkModalBlockers);
        
        // Check for JavaScript errors
        console.log('üß™ Checking for JavaScript errors...');
        if (window.onerror) {
          console.log('onerror handler exists');
        }
      };
      
      // Simple test functions
      window.testGAS = function() {
        const url = 'https://script.google.com/macros/s/AKfycbyu_KfkYkyeI7Wa4lS_zBONHe7OGXYbz43t-7S19Vl3-B25UTZmAgT2-0wc3FM4aVuG/exec?action=test';
        console.log('üß™ Testing GAS URL:', url);
        window.open(url, '_blank');
      };
      
      // Test createQuizFromWrongAnswers directly
      window.testCreateQuiz = function() {
        console.log('üß™ Testing createQuizFromWrongAnswers directly...');
        if (typeof window.createQuizFromWrongAnswers === 'function') {
          console.log('‚úÖ Function exists, calling it...');
          try {
            window.createQuizFromWrongAnswers('topic-3opmknboa1760069151278', '1. T√≠n d·ª•ng kh√°ch h√†ng doanh nghi·ªáp (B√†i thi lao ƒë·ªông chuy√™n m√¥n nghi·ªáp v·ª•)');
          } catch (error) {
            console.error('‚ùå Error calling function:', error);
          }
        } else {
          console.error('‚ùå Function not found');
        }
      };
      
      window.testGASFetch = function() {
        const url = 'https://script.google.com/macros/s/AKfycbyu_KfkYkyeI7Wa4lS_zBONHe7OGXYbz43t-7S19Vl3-B25UTZmAgT2-0wc3FM4aVuG/exec?action=test&_t=' + Date.now();
        console.log('üß™ Testing GAS fetch:', url);
        
        fetch(url)
          .then(response => {
            console.log('üß™ Response status:', response.status);
            return response.text();
          })
          .then(text => {
            console.log('üß™ Raw response:', text);
            try {
              const json = JSON.parse(text);
              console.log('üß™ Parsed JSON:', json);
            } catch (e) {
              console.error('üß™ JSON parse error:', e);
            }
          })
          .catch(error => {
            console.error('üß™ Fetch error:', error);
          });
      };
      
      // Test Google Apps Script response
      window.testGASResponse = function() {
        const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=getWrongAnswers&callback=testGASCallback';
        console.log('üß™ Testing GAS response:', url);
        
        // Test direct URL first
        window.testDirectGAS = function() {
          const testUrl = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test';
          console.log('üß™ Testing direct GAS URL:', testUrl);
          window.open(testUrl, '_blank');
        };
        
        // Test with cache busting
        window.testGASWithCacheBust = function() {
          const timestamp = Date.now();
          const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test&_t=' + timestamp;
          console.log('üß™ Testing GAS with cache bust:', url);
          
          fetch(url)
            .then(response => {
              console.log('üß™ Response status:', response.status);
              console.log('üß™ Response headers:', response.headers);
              return response.text();
            })
            .then(text => {
              console.log('üß™ Raw response text:', text);
              try {
                const json = JSON.parse(text);
                console.log('üß™ Parsed JSON:', json);
              } catch (e) {
                console.error('üß™ JSON parse error:', e);
                console.log('üß™ First 100 chars:', text.substring(0, 100));
              }
            })
            .catch(error => {
              console.error('üß™ Fetch error:', error);
            });
        };
        
        // Make functions available immediately
        console.log('üß™ Functions created: testDirectGAS, testGASWithCacheBust');
        
        // Also create them outside the function scope
        window.testDirectGAS = function() {
          const testUrl = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test';
          console.log('üß™ Testing direct GAS URL:', testUrl);
          window.open(testUrl, '_blank');
        };
        
        window.testGASWithCacheBust = function() {
          const timestamp = Date.now();
          const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test&_t=' + timestamp;
          console.log('üß™ Testing GAS with cache bust:', url);
          
          fetch(url)
            .then(response => {
              console.log('üß™ Response status:', response.status);
              console.log('üß™ Response headers:', response.headers);
              return response.text();
            })
            .then(text => {
              console.log('üß™ Raw response text:', text);
              try {
                const json = JSON.parse(text);
                console.log('üß™ Parsed JSON:', json);
              } catch (e) {
                console.error('üß™ JSON parse error:', e);
                console.log('üß™ First 100 chars:', text.substring(0, 100));
              }
            })
            .catch(error => {
              console.error('üß™ Fetch error:', error);
            });
        };
        
        window.testGASCallback = function(data) {
          console.log('üß™ GAS Response:', data);
          alert('GAS Response: ' + JSON.stringify(data).substring(0, 200));
          delete window.testGASCallback;
        };
        
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => {
          alert('‚ùå GAS failed!');
          delete window.testGASCallback;
        };
        document.head.appendChild(script);
      };
      
      // Quick test function
      window.testGoogleSheets = async function() {
        const url = window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=getWrongAnswers&_t=' + Date.now() + '&callback=handleTestResponse';
        console.log('üß™ Testing URL:', url);
        
        try {
          const response = await new Promise((resolve, reject) => {
            window.handleTestResponse = function(data) {
              // Clean up
              document.head.removeChild(script);
              delete window.handleTestResponse;
              resolve(data);
            };
            
            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => {
              document.head.removeChild(script);
              delete window.handleTestResponse;
              reject(new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Google Sheets'));
            };
            document.head.appendChild(script);
          });
          
          console.log('üß™ Response:', response);
          
          if (response.success && response.data) {
            alert('‚úÖ Tr·∫£ v·ªÅ JSON! Ch·ª©c nƒÉng s·∫Ω ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.\n\nD·ªØ li·ªáu: ' + response.data.length + ' c√¢u sai');
          } else {
            alert('‚ùå L·ªói t·ª´ Google Sheets: ' + (response.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Test failed:', error);
          alert('‚ùå L·ªói k·∫øt n·ªëi: ' + error.message);
        }
      };
      
      // Debug function to check system status
      window.debugWrongAnswersSystem = async function() {
        console.log('üîç Debug Wrong Answers System:');
        
        // Check config
        console.log('üìã Config:', {
          QUIZ_CONFIG: window.QUIZ_CONFIG,
          isConfigured: window.isConfigured(),
          ENABLE_CLOUD_SYNC: window.QUIZ_CONFIG?.ENABLE_CLOUD_SYNC,
          GOOGLE_SCRIPT_URL: window.QUIZ_CONFIG?.GOOGLE_SCRIPT_URL
        });
        
        // Check local data
        try {
          const allWrongAnswers = await window.db.getWrongAnswers();
          const allTopics = await getTopicsFromStorage();
          console.log('üíæ Local Data:', {
            wrongAnswersCount: allWrongAnswers.length,
            topicsCount: allTopics.length,
            wrongAnswersTopics: [...new Set(allWrongAnswers.map(a => a.topicName))],
            topicsNames: allTopics.map(t => t.name)
          });
        } catch (error) {
          console.error('‚ùå Error checking local data:', error);
        }
        
        // Test Google Sheets connection
        if (window.QUIZ_CONFIG?.ENABLE_CLOUD_SYNC && window.isConfigured()) {
          try {
            console.log('üåê Testing Google Sheets connection...');
            
            // Test 1: Basic test endpoint
            console.log('üß™ Test 1: Basic test endpoint');
            const testResponse = await fetch(window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=test');
            const testText = await testResponse.text();
            console.log('üß™ Test response:', {
              status: testResponse.status,
              statusText: testResponse.statusText,
              contentType: testResponse.headers.get('content-type'),
              ok: testResponse.ok,
              text: testText
            });
            
            // Test 2: Statistics endpoint
            console.log('üß™ Test 2: Statistics endpoint');
            const statsResponse = await fetch(window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=getStatistics');
            const statsText = await statsResponse.text();
            console.log('üß™ Statistics response:', {
              status: statsResponse.status,
              statusText: statsResponse.statusText,
              contentType: statsResponse.headers.get('content-type'),
              ok: statsResponse.ok,
              text: statsText.substring(0, 500) + (statsText.length > 500 ? '...' : '')
            });
            
            // Test 3: Wrong answers endpoint
            console.log('üß™ Test 3: Wrong answers endpoint');
            const response = await fetch(window.QUIZ_CONFIG.GOOGLE_SCRIPT_URL + '?action=getWrongAnswers');
            const responseText = await response.text();
            console.log('üß™ Wrong answers response:', {
              status: response.status,
              statusText: response.statusText,
              contentType: response.headers.get('content-type'),
              ok: response.ok,
              text: responseText.substring(0, 500) + (responseText.length > 500 ? '...' : '')
            });
            
            if (response.ok) {
              try {
                const result = JSON.parse(responseText);
                console.log('üåê Google Sheets data:', {
                  success: result.success,
                  dataLength: result.data?.length || 0,
                  message: result.message
                });
              } catch (parseError) {
                console.error('‚ùå JSON Parse Error:', parseError);
                console.error('‚ùå Raw response:', responseText);
              }
            }
          } catch (error) {
            console.error('‚ùå Google Sheets connection test failed:', error);
          }
        }
        
        alert('üîç Debug information ƒë√£ ƒë∆∞·ª£c ghi v√†o Console (F12). Vui l√≤ng ki·ªÉm tra Console ƒë·ªÉ xem chi ti·∫øt.');
      };
      
      // Make functions available globally
      window.createQuizFromLocalWrongAnswers = createQuizFromLocalWrongAnswers;
      window.createQuizFromCloudWrongAnswers = createQuizFromCloudWrongAnswers;

      // Export topic to Excel function with all answers displayed
      window.exportTopicToExcel = async function(topicId) {
        const allTopicsData = await getTopicsFromStorage();
        const topic = allTopicsData.find(t => t.id === topicId);
        
        if (!topic) {
          alert('Kh√¥ng t√¨m th·∫•y chuy√™n ƒë·ªÅ!');
          return;
        }
        
        if (!topic.questions || topic.questions.length === 0) {
          alert('Chuy√™n ƒë·ªÅ n√†y ch∆∞a c√≥ c√¢u h·ªèi!');
          return;
        }
        
        // Create workbook
        const wb = XLSX.utils.book_new();
        
        // Prepare data with all answers
        const questionsData = [
          ['Chuy√™n ƒë·ªÅ: ' + topic.name, '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch']
        ];
        
        topic.questions.forEach((q, index) => {
          // Map option labels to their text values
          const optionsMap = {};
          (q.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = q.options[i] || '';
          });
          
          questionsData.push([
            index + 1,
            q.question || '',
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            q.answer || '',
            q.explain || ''
          ]);
        });
        
        const ws = XLSX.utils.aoa_to_sheet(questionsData);
        
        // Set column widths
        ws['!cols'] = [
          { width: 6 },   // STT
          { width: 60 },  // C√¢u h·ªèi
          { width: 30 },  // ƒê√°p √°n A
          { width: 30 },  // ƒê√°p √°n B
          { width: 30 },  // ƒê√°p √°n C
          { width: 30 },  // ƒê√°p √°n D
          { width: 12 },  // ƒê√°p √°n ƒë√∫ng
          { width: 50 }   // Gi·∫£i th√≠ch
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'C√¢u h·ªèi');
        
        // Save file
        const fileName = `${topic.name.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, fileName);
      };

      // Export global statistics function
      window.exportGlobalStatisticsExcel = async function() {
      const allStats = await window.db.getStatistics() || [];
      const allWrongAnswers = await window.db.getWrongAnswers() || [];
      
      if (allStats.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o ƒë·ªÉ xu·∫•t!');
        return;
      }
      
      // Calculate overall statistics
      const totalAttempts = allStats.length;
      const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...allStats.map(s => s.score));
      const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
      const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Group by topic
      const topicStats = {};
      allStats.forEach(stat => {
        if (!topicStats[stat.topicId]) {
          topicStats[stat.topicId] = {
            topicId: stat.topicId,
            name: stat.topicName,
            attempts: 0,
            totalScore: 0,
            bestScore: 0,
            totalQuestions: 0,
            totalCorrect: 0,
            totalWrong: 0,
            isExam: stat.isExam
          };
        }
        topicStats[stat.topicId].attempts++;
        topicStats[stat.topicId].totalScore += stat.score;
        topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
        topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
        topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
        topicStats[stat.topicId].totalWrong += stat.wrongAnswers;
      });
      
      // Calculate averages for each topic
      Object.values(topicStats).forEach(topic => {
        topic.avgScore = Math.round(topic.totalScore / topic.attempts);
      });
      
      // Sort topics by average score (descending)
      const sortedTopics = Object.values(topicStats).sort((a, b) => b.avgScore - a.avgScore);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Summary sheet
      const summaryData = [
        ['Th·ªëng k√™ t·ªïng qu√°t - H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II', ''],
        ['T·ªïng s·ªë l·∫ßn l√†m b√†i', totalAttempts],
        ['ƒêi·ªÉm trung b√¨nh', avgScore + '%'],
        ['ƒêi·ªÉm cao nh·∫•t', bestScore + '%'],
        ['T·ªïng s·ªë c√¢u h·ªèi', totalQuestions],
        ['T·ªïng s·ªë c√¢u ƒë√∫ng', totalCorrect],
        ['T·ªïng s·ªë c√¢u sai', totalWrong],
        ['', ''],
        ['Th·ªëng k√™ theo chuy√™n ƒë·ªÅ', ''],
        ['STT', 'T√™n chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'L·∫ßn l√†m', 'ƒêi·ªÉm TB', 'ƒêi·ªÉm cao nh·∫•t', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai']
      ];
      
      sortedTopics.forEach((topic, index) => {
        summaryData.push([
          index + 1,
          topic.name,
          topic.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
          topic.attempts,
          topic.avgScore + '%',
          topic.bestScore + '%',
          topic.totalQuestions,
          topic.totalCorrect,
          topic.totalWrong
        ]);
      });
      
      const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
      ws1['!cols'] = [
        { width: 8 },
        { width: 30 },
        { width: 12 },
        { width: 10 },
        { width: 12 },
        { width: 12 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng quan');
      
      // Detailed attempts sheet
      const attemptsData = [
        ['Chi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i', ''],
        ['Th·ªùi gian', 'T√™n chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai', 'ƒêi·ªÉm']
      ];
      
      allStats.forEach(stat => {
        attemptsData.push([
          new Date(stat.timestamp).toLocaleString('vi-VN'),
          stat.topicName,
          stat.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
          stat.totalQuestions,
          stat.correctAnswers,
          stat.wrongAnswers,
          stat.score + '%'
        ]);
      });
      
      const ws2 = XLSX.utils.aoa_to_sheet(attemptsData);
      ws2['!cols'] = [
        { width: 20 },
        { width: 30 },
        { width: 12 },
        { width: 10 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws2, 'Chi ti·∫øt l·∫ßn l√†m');
      
      // Wrong answers sheet with all options displayed
      if (allWrongAnswers.length > 0) {
        const wrongAnswersData = [
          ['C√¢u tr·∫£ l·ªùi sai chi ti·∫øt', '', '', '', '', '', '', '', ''],
          ['STT', 'Chuy√™n ƒë·ªÅ', 'Lo·∫°i', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n c·ªßa b·∫°n', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch', 'Th·ªùi gian']
        ];
        
        allWrongAnswers.forEach((answer, index) => {
          // Map option labels to their text values
          const optionsMap = {};
          (answer.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = answer.options[i] || '';
          });
          
          wrongAnswersData.push([
            index + 1,
            answer.topicName,
            answer.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ',
            answer.question,
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            answer.userAnswer,
            answer.correctAnswer,
            answer.explanation || '',
            new Date(answer.timestamp).toLocaleString('vi-VN')
          ]);
        });
        
        const ws3 = XLSX.utils.aoa_to_sheet(wrongAnswersData);
        ws3['!cols'] = [
          { width: 6 },   // STT
          { width: 25 },  // Chuy√™n ƒë·ªÅ
          { width: 12 },  // Lo·∫°i
          { width: 60 },  // C√¢u h·ªèi
          { width: 30 },  // ƒê√°p √°n A
          { width: 30 },  // ƒê√°p √°n B
          { width: 30 },  // ƒê√°p √°n C
          { width: 30 },  // ƒê√°p √°n D
          { width: 15 },  // ƒê√°p √°n c·ªßa b·∫°n
          { width: 15 },  // ƒê√°p √°n ƒë√∫ng
          { width: 40 },  // Gi·∫£i th√≠ch
          { width: 20 }   // Th·ªùi gian
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'C√¢u sai');
      }
      
      // Save file
      const fileName = `thong-ke-tong-quat-${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
    };

    // Export statistics for a specific topic
    window.exportTopicStatisticsExcel = async function(topicId) {
      const allStats = await window.db.getStatistics() || [];
      const allWrongAnswers = await window.db.getWrongAnswers() || [];
      const allTopics = await getTopicsFromStorage();
      
      // L·ªçc d·ªØ li·ªáu theo topicId
      const topicStats = allStats.filter(stat => stat.topicId === topicId);
      const topicWrongAnswers = allWrongAnswers.filter(answer => answer.topicId === topicId);
      const topic = allTopics.find(t => t.id === topicId);
      
      if (topicStats.length === 0) {
        alert('Ch∆∞a c√≥ d·ªØ li·ªáu th·ªëng k√™ cho chuy√™n ƒë·ªÅ n√†y!');
        return;
      }
      
      const topicName = topic ? topic.name : (topicStats[0] ? topicStats[0].topicName : 'Unknown');
      
      // T√≠nh to√°n th·ªëng k√™
      const totalAttempts = topicStats.length;
      const avgScore = Math.round(topicStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
      const bestScore = Math.max(...topicStats.map(s => s.score));
      const totalCorrect = topicStats.reduce((sum, s) => sum + s.correctAnswers, 0);
      const totalWrong = topicStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      
      // Summary sheet
      const summaryData = [
        ['Th·ªëng k√™ chuy√™n ƒë·ªÅ: ' + topicName, ''],
        ['T·ªïng s·ªë l·∫ßn l√†m b√†i', totalAttempts],
        ['ƒêi·ªÉm trung b√¨nh', avgScore + '%'],
        ['ƒêi·ªÉm cao nh·∫•t', bestScore + '%'],
        ['T·ªïng s·ªë c√¢u ƒë√∫ng', totalCorrect],
        ['T·ªïng s·ªë c√¢u sai', totalWrong],
        ['', ''],
        ['Chi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i', ''],
        ['Th·ªùi gian', 'T·ªïng c√¢u', 'ƒê√∫ng', 'Sai', 'ƒêi·ªÉm']
      ];
      
      topicStats.forEach(stat => {
        summaryData.push([
          new Date(stat.timestamp).toLocaleString('vi-VN'),
          stat.totalQuestions,
          stat.correctAnswers,
          stat.wrongAnswers,
          stat.score + '%'
        ]);
      });
      
      const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
      ws1['!cols'] = [
        { width: 20 },
        { width: 15 },
        { width: 10 },
        { width: 10 },
        { width: 10 }
      ];
      XLSX.utils.book_append_sheet(wb, ws1, 'T·ªïng quan');
      
      // C√¢u h·ªèi t·ª´ chuy√™n ƒë·ªÅ (n·∫øu c√≥)
      if (topic && topic.questions && topic.questions.length > 0) {
        const questionsData = [
          ['Danh s√°ch c√¢u h·ªèi - ' + topicName, '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch']
        ];
        
        topic.questions.forEach((q, index) => {
          const optionsMap = {};
          (q.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = q.options[i] || '';
          });
          
          questionsData.push([
            index + 1,
            q.question || '',
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            q.answer || '',
            q.explain || ''
          ]);
        });
        
        const ws2 = XLSX.utils.aoa_to_sheet(questionsData);
        ws2['!cols'] = [
          { width: 6 },
          { width: 60 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 12 },
          { width: 50 }
        ];
        XLSX.utils.book_append_sheet(wb, ws2, 'C√¢u h·ªèi');
      }
      
      // Wrong answers sheet
      if (topicWrongAnswers.length > 0) {
        const wrongAnswersData = [
          ['C√¢u tr·∫£ l·ªùi sai - ' + topicName, '', '', '', '', '', '', ''],
          ['STT', 'C√¢u h·ªèi', 'ƒê√°p √°n A', 'ƒê√°p √°n B', 'ƒê√°p √°n C', 'ƒê√°p √°n D', 'ƒê√°p √°n c·ªßa b·∫°n', 'ƒê√°p √°n ƒë√∫ng', 'Gi·∫£i th√≠ch', 'Th·ªùi gian']
        ];
        
        topicWrongAnswers.forEach((answer, index) => {
          const optionsMap = {};
          (answer.optionLabels || []).forEach((label, i) => {
            optionsMap[label] = answer.options[i] || '';
          });
          
          wrongAnswersData.push([
            index + 1,
            answer.question,
            optionsMap['A'] || '',
            optionsMap['B'] || '',
            optionsMap['C'] || '',
            optionsMap['D'] || '',
            answer.userAnswer,
            answer.correctAnswer,
            answer.explanation || '',
            new Date(answer.timestamp).toLocaleString('vi-VN')
          ]);
        });
        
        const ws3 = XLSX.utils.aoa_to_sheet(wrongAnswersData);
        ws3['!cols'] = [
          { width: 6 },
          { width: 60 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 30 },
          { width: 15 },
          { width: 15 },
          { width: 40 },
          { width: 20 }
        ];
        XLSX.utils.book_append_sheet(wb, ws3, 'C√¢u sai');
      }
      
      // Save file
      const fileName = `thong-ke-${topicName.replace(/[^a-zA-Z0-9]/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
      XLSX.writeFile(wb, fileName);
    };

    window.exportGlobalStatistics = async function() {
        const allStats = await window.db.getStatistics() || [];
        const allWrongAnswers = await window.db.getWrongAnswers() || [];
        
        if (allStats.length === 0) {
          alert('Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ n√†o ƒë·ªÉ xu·∫•t!');
          return;
        }
        
        // Calculate overall statistics
        const totalAttempts = allStats.length;
        const avgScore = Math.round(allStats.reduce((sum, s) => sum + s.score, 0) / totalAttempts);
        const bestScore = Math.max(...allStats.map(s => s.score));
        const totalQuestions = allStats.reduce((sum, s) => sum + s.totalQuestions, 0);
        const totalCorrect = allStats.reduce((sum, s) => sum + s.correctAnswers, 0);
        const totalWrong = allStats.reduce((sum, s) => sum + s.wrongAnswers, 0);
        
        // Group by topic
        const topicStats = {};
        allStats.forEach(stat => {
          if (!topicStats[stat.topicId]) {
            topicStats[stat.topicId] = {
              name: stat.topicName,
              attempts: 0,
              totalScore: 0,
              bestScore: 0,
              totalQuestions: 0,
              totalCorrect: 0,
              totalWrong: 0,
              isExam: stat.isExam
            };
          }
          topicStats[stat.topicId].attempts++;
          topicStats[stat.topicId].totalScore += stat.score;
          topicStats[stat.topicId].bestScore = Math.max(topicStats[stat.topicId].bestScore, stat.score);
          topicStats[stat.topicId].totalQuestions += stat.totalQuestions;
          topicStats[stat.topicId].totalCorrect += stat.correctAnswers;
          topicStats[stat.topicId].totalWrong += stat.wrongAnswers;
        });
        
        // Calculate averages for each topic
        Object.values(topicStats).forEach(topic => {
          topic.avgScore = Math.round(topic.totalScore / topic.attempts);
        });
        
        // Sort topics by average score (descending)
        const sortedTopics = Object.values(topicStats).sort((a, b) => b.avgScore - a.avgScore);
        
        // Create CSV content
        let csvContent = 'Th·ªëng k√™ t·ªïng qu√°t - H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II\n\n';
        csvContent += 'T·ªïng s·ªë l·∫ßn l√†m b√†i,' + totalAttempts + '\n';
        csvContent += 'ƒêi·ªÉm trung b√¨nh,' + avgScore + '%\n';
        csvContent += 'ƒêi·ªÉm cao nh·∫•t,' + bestScore + '%\n';
        csvContent += 'T·ªïng s·ªë c√¢u h·ªèi,' + totalQuestions + '\n';
        csvContent += 'T·ªïng s·ªë c√¢u ƒë√∫ng,' + totalCorrect + '\n';
        csvContent += 'T·ªïng s·ªë c√¢u sai,' + totalWrong + '\n\n';
        
        csvContent += 'Th·ªëng k√™ theo chuy√™n ƒë·ªÅ:\n';
        csvContent += 'STT,T√™n chuy√™n ƒë·ªÅ,Lo·∫°i,L·∫ßn l√†m,ƒêi·ªÉm TB,ƒêi·ªÉm cao nh·∫•t,T·ªïng c√¢u,ƒê√∫ng,Sai\n';
        sortedTopics.forEach((topic, index) => {
          csvContent += (index + 1) + ',"' + 
                       topic.name.replace(/"/g, '""') + '","' + 
                       (topic.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ') + '",' + 
                       topic.attempts + ',' + 
                       topic.avgScore + '%,' + 
                       topic.bestScore + '%,' + 
                       topic.totalQuestions + ',' + 
                       topic.totalCorrect + ',' + 
                       topic.totalWrong + '\n';
        });
        
        csvContent += '\nChi ti·∫øt t·ª´ng l·∫ßn l√†m b√†i:\n';
        csvContent += 'Th·ªùi gian,T√™n chuy√™n ƒë·ªÅ,Lo·∫°i,T·ªïng c√¢u,ƒê√∫ng,Sai,ƒêi·ªÉm\n';
        allStats.forEach(stat => {
          csvContent += new Date(stat.timestamp).toLocaleString('vi-VN') + ',"' + 
                       stat.topicName.replace(/"/g, '""') + '","' + 
                       (stat.isExam ? 'B√†i thi' : 'Chuy√™n ƒë·ªÅ') + '",' + 
                       stat.totalQuestions + ',' + 
                       stat.correctAnswers + ',' + 
                       stat.wrongAnswers + ',' + 
                       stat.score + '%\n';
        });
        
        // Download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `thong-ke-tong-quat-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
    </script>

  </div>
  
  <footer style="background: linear-gradient(135deg, #8e0e00 0%, #1f1c18 100%); color: #fff; padding: 15px 15px 10px; margin-top: 30px; position: relative; overflow: hidden;">
    <div style="max-width: 1200px; margin: 0 auto; position: relative; z-index: 1;">
      <div style="display: flex !important; justify-content: space-between !important; flex-wrap: wrap !important; gap: 20px !important; margin-bottom: 12px !important;">
        <div style="flex: 1 !important; min-width: 250px !important;">
          <div style="display: flex !important; align-items: center !important; gap: 10px !important; margin-bottom: 8px !important;">
            <div style="width: 35px !important; height: 35px !important; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%) !important; border-radius: 8px !important; padding: 2px !important; border: 2px solid rgba(255,255,255,0.9) !important; box-shadow: 0 3px 8px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8) !important; display: flex !important; align-items: center !important; justify-content: center !important; transition: all 0.3s ease !important; position: relative !important; overflow: hidden !important;" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2), 0 2px 6px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.9)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8)'">
              <img src="logo-new.png?v=20250112" alt="Logo Agribank" style="width: 100% !important; height: 100% !important; object-fit: contain !important; filter: none !important; -webkit-filter: none !important; -moz-filter: none !important; -ms-filter: none !important; -o-filter: none !important; transition: all 0.3s ease !important;" onerror="console.error('Logo load failed:', this.src); this.style.display='none';">
            </div>
            <div>
              <h3 style="font-size: 0.9em !important; margin: 0 0 2px !important; color: #fff !important; font-weight: 600 !important;">H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám</h3>
              <p style="margin: 0 !important; color: rgba(255, 255, 255, 0.8) !important; font-size: 0.75em !important;">Chi nh√°nh C·∫ßn Th∆° II</p>
            </div>
          </div>
          <p style="color: rgba(255, 255, 255, 0.7) !important; line-height: 1.4 !important; margin: 0 !important; font-size: 0.8em !important;">
            H·ªá th·ªëng h·ªó tr·ª£ h·ªçc t·∫≠p v√† ƒë√°nh gi√° ki·∫øn th·ª©c tr·ª±c tuy·∫øn.
          </p>
        </div>
        
        <div style="background: rgba(255, 255, 255, 0.05) !important; padding: 6px !important; border-radius: 6px !important; min-width: 250px !important; backdrop-filter: blur(5px) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important;">
          <h4 style="color: #fff !important; margin: 0 0 3px 0 !important; font-size: 0.86em !important; padding-bottom: 2px !important; border-bottom: 2px solid #800020 !important; display: inline-block !important;">Li√™n h·ªá h·ªó tr·ª£</h4>
          <div style="color: rgba(255, 255, 255, 0.9) !important; padding: 0 !important; font-size: 0.74em !important; line-height: 1.4 !important; margin: 0 !important;">
            <div style="margin: 0 !important; padding: 0 !important;">üë§ Nguy·ªÖn Th√†nh Trung</div>
            <div style="margin: 0 !important; padding: 0 !important;">üìû 0947.86.86.82</div>
            <div style="margin: 0 !important; padding: 0 !important;">‚úâÔ∏è trungnguyenthanh1@agribank.com.vn</div>
            <div style="margin: 0 !important; padding: 0 !important;">üè¶ Agribank Chi nh√°nh C·∫ßn Th∆° II</div>
          </div>
        </div>
      </div>
      
      <div style="text-align: center; padding-top: 8px; margin-top: 8px; border-top: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6); font-size: 0.7em;">
        <strong>¬© 2025 H·ªá th·ªëng √¥n luy·ªán tr·∫Øc nghi·ªám C·∫ßn Th∆° II</strong>
      </div>
    </div>
    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #800020;"></div>
  </footer>
  
  <script src="mobile-touch.js?v=20250112"></script>
  
  <script>
    // Register Service Worker with auto-update
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => {
            console.log('‚úÖ Service Worker registered');
            
            // Check for updates every 30 seconds
            setInterval(() => {
              reg.update();
            }, 30000);
            
            // Listen for updates
            reg.addEventListener('updatefound', () => {
              const newWorker = reg.installing;
              console.log('üîÑ New Service Worker found, installing...');
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'activated') {
                  console.log('‚úÖ New Service Worker activated');
                  
                  // Show notification to reload
                  if (confirm('üîÑ C√≥ phi√™n b·∫£n m·ªõi!\n\nNh·∫•n OK ƒë·ªÉ t·∫£i l·∫°i trang v·ªõi code m·ªõi.')) {
                    window.location.reload(true);
                  }
                }
              });
            });
          })
          .catch(err => {
            console.error('‚ùå Service Worker registration failed:', err);
          });
      });
      
      // Handle controller change (new SW took control)
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('üîÑ Service Worker controller changed');
        // Auto reload when new SW takes control
        window.location.reload(true);
      });
    }
  </script>
</body>
</html>
